<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Culture Gourmet Contracts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        .hidden { display: none !important; }
        .sidebar { 
            height: 100vh; 
            overflow-y: auto;
            flex-shrink: 0;
            min-width: 250px;
        }
        .nav-link.active { background-color: var(--bs-primary); color: white !important; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        
        /* App layout - full viewport */
        #app-section {
            height: 100vh;
            overflow: hidden;
        }
        #app-section > .d-flex {
            height: 100%;
        }
        #app-section main {
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* Section containers */
        #app-section section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        /* Scrollable table containers */
        .table-scroll-container {
            flex: 1;
            min-height: 0;
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }
        /* Larger height for clients table */
        .table-scroll-container.clients-table {
            max-height: 600px ;
        }
        .table-scroll-container table {
            margin-bottom: 0;
        }
        .table-scroll-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8f9fa;
        }
        
        /* Pagination styling */
        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .table-pagination .pagination {
            margin: 0;
        }
        .table-pagination .page-info {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        /* Settings tabs styling */
        #settingsTabs .nav-link {
            border-radius: 8px;
            padding: 10px 20px;
            color: #6c757d;
            font-weight: 500;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        #settingsTabs .nav-link:hover {
            background-color: #f8f9fa;
            color: #495057;
        }
        #settingsTabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        #settingsTabs .nav-item {
            margin-right: 8px;
        }
        
        /* Form control focus styling */
        .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
        }
        
        /* Enhanced Accordion Styling */
        .accordion-item {
            border-radius: 16px !important;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .accordion-button {
            font-weight: 600;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .accordion-button:not(.collapsed)::after {
            filter: brightness(0) invert(1);
        }
        .accordion-button:focus {
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }
        .accordion-body {
            padding: 24px;
        }
        
        /* Search Wrapper */
        .search-wrapper {
            position: relative;
        }
        .search-wrapper .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            z-index: 5;
        }
        
        /* Table vertical alignment */
        .table td, .table th {
            vertical-align: middle;
        }
        .table td {
            color: #6c757d;
        }
        
        /* Template Cards */
        .template-card {
            transition: all 0.2s ease;
            border-color: #e2e8f0 !important;
        }
        .template-card:hover {
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        .template-card .btn-group .btn {
            padding: 0.375rem 0.625rem;
        }
        
        /* Variable Buttons */
        .variable-btn {
            transition: all 0.15s ease;
            background: #f8f9fa;
        }
        .variable-btn:hover {
            background: #667eea !important;
            color: white !important;
            border-color: #667eea !important;
        }
        .variable-btn:hover code {
            color: white !important;
        }
        
        /* Card with table - flex layout */
        .card.table-card {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            max-height: calc(100vh - 250px);
        }
        /* Larger card for clients section */
        .card.table-card.clients-card {
            max-height: calc(100vh - 100px) !important;
        }
        .card.table-card .card-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            padding: 0;
        }
    </style>
</head>

<body class="bg-light">
    <!-- LOGIN -->
    <div id="login-section" class="min-vh-100 d-flex align-items-center justify-content-center p-4">
        <div class="card shadow-sm border-0" style="max-width: 420px; width: 100%;">
            <div class="card-body p-4">
                <h2 class="fw-bold mb-2">Culture Gourmet Portal</h2>
                <p class="text-muted mb-4">Login to manage clients and catering contracts.</p>
                <div class="mb-3">
                    <label for="cg-user-id" class="form-label fw-semibold">User ID</label>
                    <input id="cg-user-id" type="text" class="form-control" placeholder="****" />
                </div>
                <div class="mb-3">
                    <label for="cg-user-pass" class="form-label fw-semibold">Password</label>
                    <input id="cg-user-pass" type="password" class="form-control" placeholder="****" />
                </div>
                <button id="cg-login-btn" class="btn btn-primary w-100" type="button">Login</button>
                <div id="cg-login-error" class="text-danger small mt-2"></div>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-section" class="hidden">
        <div class="d-flex">
            <!-- Sidebar -->
            <aside class="sidebar bg-white border-end p-3" style="width: 250px;">
                <div class="d-flex flex-column h-100">
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">The Cultural Gourmet</h6>
                        <nav class="nav flex-column gap-2">
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center active" href="#" data-section="home-section" id="nav-home">
                                <span>Home</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="clients-section" id="nav-clients">
                                <span>Clients</span>
                                <span class="badge bg-primary rounded-pill" id="clients-count-badge">0</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="contracts-section" id="nav-contracts">
                                <span>Contracts</span>
                                <span class="badge bg-primary rounded-pill" id="contracts-count-badge">0</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="templates-section" id="nav-templates">
                                <span>Templates</span>
                                <span class="badge bg-primary rounded-pill" id="templates-count-badge">0</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="admin-section" id="nav-admin">
                                <span>Admin</span>
                            </a>
                        </nav>
                    </div>
                    <div class="mt-auto pt-4 border-top">
                        <button id="btn-logout" class="btn btn-outline-danger btn-sm w-100">
                            <i class="bi bi-box-arrow-right me-1"></i>Admin Log Out
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-grow-1 p-4">
                <!-- HOME -->
                <section id="home-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1"><i class="bi bi-speedometer2 text-primary me-2"></i>Dashboard</h2>
                        </div>
                        <button class="btn btn-outline-primary" type="button">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
                        </button>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-3 p-3 me-3">
                                            <i class="bi bi-file-earmark-text text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Total Contracts</div>
                                            <div class="fs-3 fw-bold" id="metric-total">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-info rounded-3 p-3 me-3">
                                            <i class="bi bi-send text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Sent</div>
                                            <div class="fs-3 fw-bold" id="metric-sent">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-warning rounded-3 p-3 me-3">
                                            <i class="bi bi-eye text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Under Review</div>
                                            <div class="fs-3 fw-bold" id="metric-under-review">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-3 p-3 me-3">
                                            <i class="bi bi-check-circle text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Signed</div>
                                            <div class="fs-3 fw-bold" id="metric-signed">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3 border-0">
                            <h5 class="card-title mb-0 fw-semibold">
                                <i class="bi bi-clock-history me-2" style="color: #667eea;"></i>Recent Activity
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4">Client</th>
                                            <th class="border-0 py-3">Event</th>
                                            <th class="border-0 py-3">When</th>
                                            <th class="border-0 py-3 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-activity-body">
                                        <tr>
                                            <td colspan="4" class="text-center py-5 text-muted">
                                                <i class="bi bi-clock-history d-block mb-2" style="font-size: 2rem;"></i>
                                                No recent activity
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CLIENTS -->
                <section id="clients-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="page-header">
                            <h2 class="fw-bold mb-1"><i class="bi bi-people-fill me-2" style="color: #667eea;"></i>Clients</h2>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="search-wrapper">
                                <i class="bi bi-search search-icon"></i>
                                <input type="text" class="form-control search-input" placeholder="Search clients..." style="width: 250px; padding-left: 40px !important;">
                            </div>
                            <button id="btn-add-client" class="btn btn-primary" type="button">
                                <i class="bi bi-plus-circle me-2"></i>Add New Client
                            </button>
                        </div>
                    </div>
                    
                    <div class="card border-0 shadow-sm table-card clients-card">
                        <div class="card-body p-0">
                            <div class="table-scroll-container clients-table">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4">Client Name</th>
                                            <th class="border-0 py-3">Email</th>
                                            <th class="border-0 py-3">Phone</th>
                                            <th class="border-0 py-3 text-center">Contacts</th>
                                            <th class="border-0 py-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clients-table-body">
                                        <tr>
                                            <td colspan="5" class="text-center py-5 text-muted">
                                                <i class="bi bi-people d-block mb-2" style="font-size: 2rem;"></i>
                                                No clients yet
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination" id="clients-pagination">
                                <span class="page-info">Showing <span id="clients-page-start">0</span>-<span id="clients-page-end">0</span> of <span id="clients-total">0</span> clients</span>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item" id="clients-prev-page"><a class="page-link" href="#">&laquo; Prev</a></li>
                                        <li class="page-item" id="clients-next-page"><a class="page-link" href="#">Next &raquo;</a></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CONTRACTS -->
                <section id="contracts-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="page-header">
                            <h2 class="fw-bold mb-1"><i class="bi bi-file-earmark-text-fill me-2" style="color: #667eea;"></i>Contracts</h2>
                        </div>
                    </div>

                    <div class="accordion" id="contractsAccordion">
                        <!-- Create Contract -->
                        <div class="accordion-item border-0 shadow-sm mb-1">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#createContract">
                                    <i class="bi bi-plus-circle me-2"></i>Create New Contract
                                </button>
                            </h2>
                            <div id="createContract" class="accordion-collapse collapse" data-bs-parent="#contractsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-lg-5">
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">Contract Details Form</label>
                                                <select id="contract-client-select" class="form-select">
                                                    <option value="">-- Choose a Client --</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <select id="contract-contact-select" class="form-select" disabled>
                                                    <option value="">-- Choose a Contact --</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <input id="contract-client-name" type="text" class="form-control bg-light" placeholder="Auto-filled Contact Name" readonly />
                                            </div>
                                            <div class="mb-3">
                                                <input id="contract-client-email" type="email" class="form-control bg-light" placeholder="Auto-filled Contact Email" readonly />
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-event-location" class="form-label fw-semibold">Event Location</label>
                                                <input id="contract-event-location" type="text" class="form-control" placeholder="Venue / Address (auto-filled or edit)" />
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <label for="contract-guest-count" class="form-label fw-semibold">Guest Count</label>
                                                    <input id="contract-guest-count" type="number" min="1" class="form-control" placeholder="e.g. 80" />
                                                </div>
                                                <div class="col-6">
                                                    <label for="contract-event-date" class="form-label fw-semibold">Event Date</label>
                                                    <input id="contract-event-date" type="date" class="form-control" />
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">Event Start / End Time</label>
                                                <div class="d-flex gap-2">
                                                    <input id="contract-start-time" type="time" class="form-control" />
                                                    <input id="contract-end-time" type="time" class="form-control" />
                                                </div>
                                            </div>
                                            <button id="contract-send-btn" class="btn btn-primary w-100" type="button">Create Contract</button>
                                            <div id="contract-send-message" class="text-success small mt-2"></div>
                                        </div>
                                        <div class="col-lg-7">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label fw-semibold mb-0">Live Contract Preview</label>
                                                <select id="contract-template-select" class="form-select form-select-sm" style="width: auto; min-width: 200px;">
                                                    <option value="">-- Select Template --</option>
                                                </select>
                                            </div>
                                            <div id="contract-preview" class="bg-light rounded p-3 border" style="white-space: pre-wrap; font-size: 13px; max-height: 510px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- View Contracts -->
                        <div class="accordion-item border-0 shadow-sm">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#viewContracts">
                                    <i class="bi bi-list-ul me-2"></i>View Contracts
                                </button>
                            </h2>
                            <div id="viewContracts" class="accordion-collapse collapse show" data-bs-parent="#contractsAccordion">
                                <div class="accordion-body p-0">
                                    <div class="table-scroll-container">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="border-0 py-3 ps-4">Client</th>
                                                    <th class="border-0 py-3">Event Date</th>
                                                    <th class="border-0 py-3">Status</th>
                                                    <th class="border-0 py-3">Created At</th>
                                                    <th class="border-0 py-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="contracts-table-body">
                                                <tr>
                                                    <td colspan="5" class="text-center py-5 text-muted">
                                                        No contracts found. Create your first contract to get started.
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="table-pagination" id="contracts-pagination">
                                        <span class="page-info">Showing <span id="contracts-page-start">0</span>-<span id="contracts-page-end">0</span> of <span id="contracts-total">0</span> contracts</span>
                                        <nav>
                                            <ul class="pagination pagination-sm mb-0">
                                                <li class="page-item" id="contracts-prev-page"><a class="page-link" href="#">&laquo; Prev</a></li>
                                                <li class="page-item" id="contracts-next-page"><a class="page-link" href="#">Next &raquo;</a></li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ADMIN -->
                <section id="admin-section" class="hidden">
                    <!-- Simple Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="page-header">
                            <h2 class="fw-bold mb-1"><i class="bi bi-gear-fill me-2" style="color: #667eea;"></i>Settings</h2>
                        </div>
                    </div>

                    <!-- Settings Tabs -->
                    <ul class="nav nav-pills mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="company-tab" data-bs-toggle="pill" data-bs-target="#company-pane" type="button" role="tab">
                                <i class="bi bi-building me-2"></i>Company
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="signature-tab" data-bs-toggle="pill" data-bs-target="#signature-pane" type="button" role="tab">
                                <i class="bi bi-pen me-2"></i>Signature
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="email-tab" data-bs-toggle="pill" data-bs-target="#email-pane" type="button" role="tab">
                                <i class="bi bi-envelope me-2"></i>Email
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Company Tab -->
                        <div class="tab-pane fade show active" id="company-pane" role="tabpanel">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-4">
                                                <label for="admin-company-name" class="form-label fw-semibold">Company Name</label>
                                                <input id="admin-company-name" type="text" class="form-control form-control-lg" value="Culture Gourmet" />
                                            </div>
                                            <div class="mb-4">
                                                <label for="admin-company-address" class="form-label fw-semibold">Business Address</label>
                                                <textarea id="admin-company-address" rows="3" class="form-control" placeholder="Enter your business address..."></textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="bg-light rounded-3 p-4 text-center h-100 d-flex flex-column justify-content-center">
                                                <i class="bi bi-building text-primary" style="font-size: 3rem;"></i>
                                                <p class="text-muted small mt-2 mb-0">Your company info appears on all contracts</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Signature Tab -->
                        <div class="tab-pane fade" id="signature-pane" role="tabpanel">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="admin-rep-name" class="form-label fw-semibold">Representative Name</label>
                                                <input id="admin-rep-name" type="text" class="form-control" placeholder="e.g. John Smith" />
                                                <small class="text-muted">Name that appears on contracts</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">Digital Signature</label>
                                            <!-- Signature Preview -->
                                            <div id="admin-signature-preview" class="border rounded bg-white p-3 text-center position-relative" style="min-height: 100px; display: none;">
                                                <img id="admin-signature-img" src="" alt="Signature" style="max-height: 70px;" />
                                                <button type="button" class="btn btn-sm btn-link position-absolute text-primary" style="top: 5px; right: 5px;" onclick="editAdminSignature()">
                                                    <i class="bi bi-pencil-square"></i> Change
                                                </button>
                                            </div>
                                            <!-- Signature Canvas -->
                                            <div id="admin-signature-canvas-wrapper" class="border rounded bg-white position-relative" style="min-height: 100px;">
                                                <canvas id="admin-signature-canvas" style="width: 100%; height: 100px; cursor: crosshair;"></canvas>
                                                <button type="button" class="btn btn-sm btn-link position-absolute text-secondary" style="top: 5px; right: 5px;" onclick="clearAdminSignature()">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">Draw your signature using mouse or touch</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Email Tab -->
                        <div class="tab-pane fade" id="email-pane" role="tabpanel">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="d-flex align-items-center mb-3">
                                                <img src="https://resend.com/static/brand/resend-icon-black.svg" alt="Resend" style="height: 24px;" class="me-2" onerror="this.style.display='none'">
                                                <span class="fw-semibold">Resend API</span>
                                                <span class="badge bg-success ms-2">Active</span>
                                            </div>
                                            <div class="mb-3">
                                                <label for="resend-api-key" class="form-label fw-semibold">API Key</label>
                                                <div class="input-group">
                                                    <input id="resend-api-key" type="password" class="form-control" placeholder="re_xxxxxxxxx" />
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('resend-api-key')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                </div>
                                                <small class="text-muted">Get your key from <a href="https://resend.com" target="_blank">resend.com</a></small>
                                            </div>
                                            <div class="mb-0">
                                                <label for="resend-from-email" class="form-label fw-semibold">From Email</label>
                                                <input id="resend-from-email" type="email" class="form-control" placeholder="contracts@yourdomain.com" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="bg-light rounded-3 p-4 text-center h-100 d-flex flex-column justify-content-center">
                                                <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                                                <p class="text-muted small mt-2 mb-0">Used to send contracts to clients</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Save Button (visible for Company, Signature, Email tabs only) -->
                    <div class="mt-4" id="settings-save-wrapper">
                        <button id="btn-save-company" class="btn btn-primary px-4 py-2 me-2" type="button">
                            <i class="bi bi-check-circle me-2"></i>Save All Settings
                        </button>
                        <span id="company-msg" class="ms-2"></span>
                    </div>
                </section>

                <!-- TEMPLATES -->
                <section id="templates-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="page-header">
                            <h2 class="fw-bold mb-1"><i class="bi bi-file-earmark-text-fill me-2" style="color: #667eea;"></i>Templates</h2>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="search-wrapper">
                                <i class="bi bi-search search-icon"></i>
                                <input type="text" class="form-control search-input" id="templates-search" placeholder="Search templates..." style="width: 250px; padding-left: 40px !important;">
                            </div>
                            <button class="btn btn-primary" onclick="openTemplateModal()">
                                <i class="bi bi-plus-lg me-2"></i>New Template
                            </button>
                        </div>
                    </div>
                    
                    <!-- Templates List -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <div id="templates-list" style="max-height: calc(100vh - 180px); overflow-y: auto;">
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-file-earmark-text d-block mb-2" style="font-size: 2rem;"></i>
                                    <p>Loading templates...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Client Form Modal -->
    <div class="modal fade" id="clientFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i><span class="client-form-title">New Client</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label for="client-name-input" class="form-label fw-semibold">Client Name *</label>
                        <input id="client-name-input" type="text" class="form-control" placeholder="Enter client or company name" required>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-semibold mb-0"><i class="bi bi-people me-2 text-primary"></i>Contact Information</h6>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addContactField()">
                            <i class="bi bi-plus me-1"></i>Add Contact
                        </button>
                    </div>
                    <div id="contacts-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="client-save-btn" type="button" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Save Client
                    </button>
                </div>
                <div id="client-form-msg" class="px-3 pb-3"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirm-title">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-text">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="confirm-no">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-yes">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Preview Modal -->
    <div class="modal fade" id="contractPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>Draft Contract Preview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Please review the contract details below before confirming.
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-person me-2"></i>Client Details</h6>
                                    <p class="mb-1"><strong>Client:</strong> <span id="preview-client-name">-</span></p>
                                    <p class="mb-1"><strong>Contact:</strong> <span id="preview-contact-name">-</span></p>
                                    <p class="mb-0"><strong>Email:</strong> <span id="preview-contact-email">-</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-calendar-event me-2"></i>Event Details</h6>
                                    <p class="mb-1"><strong>Date:</strong> <span id="preview-event-date">-</span></p>
                                    <p class="mb-1"><strong>Location:</strong> <span id="preview-event-location">-</span></p>
                                    <p class="mb-1"><strong>Guests:</strong> <span id="preview-guest-count">-</span></p>
                                    <p class="mb-0"><strong>Time:</strong> <span id="preview-event-time">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h6 class="fw-bold text-primary mb-2"><i class="bi bi-file-text me-2"></i>Full Contract</h6>
                    <div id="modal-contract-preview" class="bg-light rounded p-3 border" style="white-space: pre-wrap; font-size: 13px; max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-primary" id="confirm-create-btn">
                        <i class="bi bi-file-earmark-plus me-1"></i>Create
                    </button>
                    <button type="button" class="btn btn-success" id="confirm-send-contract-btn">
                        <i class="bi bi-send me-1"></i>Create & Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div class="modal fade" id="templateEditorModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i><span id="template-modal-title">New Template</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <!-- Left: Form -->
                        <div class="col-md-5">
                            <div class="mb-3">
                                <label for="template-name" class="form-label fw-semibold">Template Name *</label>
                                <input type="text" class="form-control" id="template-name" placeholder="e.g. Standard Catering Contract">
                            </div>
                            <div class="mb-3">
                                <label for="template-description" class="form-label fw-semibold">Description</label>
                                <input type="text" class="form-control" id="template-description" placeholder="Brief description of this template">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="template-is-default">
                                    <label class="form-check-label" for="template-is-default">
                                        Set as default template
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Variables Panel -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-primary bg-opacity-10 py-2">
                                    <h6 class="fw-semibold mb-0"><i class="bi bi-braces me-2 text-primary"></i>Available Variables</h6>
                                </div>
                                <div class="card-body p-2">
                                    <p class="text-muted small mb-2 px-1">Click to insert at cursor position</p>
                                    <div id="template-variables-panel" class="d-flex flex-column gap-1">
                                        <!-- Variables will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Body Editor -->
                        <div class="col-md-7">
                            <label for="template-body" class="form-label fw-semibold">Contract Template Body *</label>
                            <textarea class="form-control font-monospace" id="template-body" rows="20" placeholder="Enter your contract template here...

Use variables like {{clientName}}, {{eventDate}}, etc.

Example:
This Catering Agreement is between {{companyName}} and {{clientName}} for catering services on {{eventDate}}.

Event Location: {{eventLocation}}
Guest Count: {{guestCount}}
Event Time: {{eventTime}}"></textarea>
                            <small class="text-muted">Variables will be replaced with actual values when a contract is created.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="template-save-btn">
                        <i class="bi bi-check-circle me-1"></i>Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Bootstrap JS - MUST be before our custom script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
        // ---------- UI Helpers ----------
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toastEl = document.createElement('div');
            toastEl.className = `toast show align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'primary'} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toastEl);
            setTimeout(() => toastEl.remove(), 4000);
        }

        let confirmResolve = null;
        let confirmModal = null;
        
        function showConfirm(message, title = "Confirm Action") {
            return new Promise((resolve) => {
                if (!confirmModal) {
                    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                }
                confirmResolve = resolve;
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-text').textContent = message;
                confirmModal.show();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('confirm-yes').addEventListener('click', () => {
                const resolver = confirmResolve;
                confirmResolve = null;
                if (confirmModal) confirmModal.hide();
                if (resolver) resolver(true);
            });

            document.getElementById('confirm-no').addEventListener('click', () => {
                const resolver = confirmResolve;
                confirmResolve = null;
                if (confirmModal) confirmModal.hide();
                if (resolver) resolver(false);
            });

            document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
                // Only resolve if not already resolved by button click
                if (confirmResolve) {
                    const resolver = confirmResolve;
                    confirmResolve = null;
                    resolver(false);
                }
            });
        });

        // ---------- Simple Login ----------
        const LOGIN_USER = "admin";
        const LOGIN_PASS = "Abc123***";

        const loginSection = document.getElementById("login-section");
        const appSection = document.getElementById("app-section");
        const loginBtn = document.getElementById("cg-login-btn");
        const loginErr = document.getElementById("cg-login-error");
        const userIdInput = document.getElementById("cg-user-id");
        const userPassInput = document.getElementById("cg-user-pass");
        const btnLogout = document.getElementById("btn-logout");

        function showApp() {
            loginSection.classList.add("hidden");
            appSection.classList.remove("hidden");
            loadInitialData();
            window.location.hash = '';
            activateSection('home-section');
        }

        function showLogin() {
            appSection.classList.add("hidden");
            loginSection.classList.remove("hidden");
            window.location.hash = 'login';
        }

        loginBtn.addEventListener("click", () => {
            const u = userIdInput.value.trim();
            const p = userPassInput.value.trim();
            if (u === LOGIN_USER && p === LOGIN_PASS) {
                loginErr.textContent = "";
                localStorage.setItem("cg_auth", "true");
                showApp();
            } else {
                loginErr.textContent = "Invalid credentials.";
            }
        });

        btnLogout.addEventListener("click", () => {
            localStorage.removeItem("cg_auth");
            showLogin();
        });

        // ---------- Navigation ----------
        const sections = {
            "home-section": document.getElementById("home-section"),
            "clients-section": document.getElementById("clients-section"),
            "contracts-section": document.getElementById("contracts-section"),
            "templates-section": document.getElementById("templates-section"),
            "admin-section": document.getElementById("admin-section"),
        };
        const navItems = document.querySelectorAll(".nav-link[data-section]");

        function activateSection(id) {
            window.location.hash = id;
            Object.keys(sections).forEach((key) => {
                sections[key].classList.toggle("hidden", key !== id);
            });
            navItems.forEach((item) => {
                item.classList.toggle("active", item.getAttribute("data-section") === id);
            });
            
            // Load templates when templates section is activated
            if (id === 'templates-section') {
                loadTemplates();
            }
        }

        navItems.forEach((item) => {
            item.addEventListener("click", (e) => {
                e.preventDefault();
                const id = item.getAttribute("data-section");
                if (id) activateSection(id);
            });
        });

        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            const isAuthenticated = localStorage.getItem("cg_auth") === "true";
            if (hash === 'login') showLogin();
            else if (hash && sections[hash] && isAuthenticated) activateSection(hash);
            else if (!isAuthenticated) showLogin();
        });

        window.addEventListener('load', () => {
            // Initialize client elements and modals after DOM is ready
            initializeClientElements();
            
            const hash = window.location.hash.slice(1);
            const isAuthenticated = localStorage.getItem("cg_auth") === "true";
            if (hash === 'login' || !isAuthenticated) showLogin();
            else if (hash && sections[hash] && isAuthenticated) { showApp(); activateSection(hash); }
            else if (isAuthenticated) showApp();
            else showLogin();
        });

        // ---------- API Helper ----------
        const API_URL = "/webhook/theCultureGourmetContract";

        async function callCG(payload) {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const raw = await res.json();
            return raw.result || raw;
        }

        // ---------- Global Settings ----------
        let settings = { companyName: 'Culture Gourmet', repName: '' };
        let selectedTemplateId = null;

        // ---------- Clients ----------
        let clients = [];
        let editingClientId = null;
        let clientsTableBody, clientsCountBadge, btnAddClient, clientNameInput, clientSaveBtn, clientFormMsg, contactsContainer, clientFormModal;
        let contactCount = 0;
        
        // Pagination state for clients
        let clientsCurrentPage = 1;
        const clientsPerPage = 10;

        function initializeClientElements() {
            clientsTableBody = document.getElementById("clients-table-body");
            clientsCountBadge = document.getElementById("clients-count-badge");
            btnAddClient = document.getElementById("btn-add-client");
            clientNameInput = document.getElementById("client-name-input");
            clientSaveBtn = document.getElementById("client-save-btn");
            clientFormMsg = document.getElementById("client-form-msg");
            contactsContainer = document.getElementById("contacts-container");
            clientFormModal = new bootstrap.Modal(document.getElementById('clientFormModal'));
            
            // Initialize pagination listeners
            document.getElementById('clients-prev-page')?.addEventListener('click', (e) => {
                e.preventDefault();
                if (clientsCurrentPage > 1) {
                    clientsCurrentPage--;
                    renderClients();
                }
            });
            document.getElementById('clients-next-page')?.addEventListener('click', (e) => {
                e.preventDefault();
                const totalPages = Math.ceil(clients.length / clientsPerPage);
                if (clientsCurrentPage < totalPages) {
                    clientsCurrentPage++;
                    renderClients();
                }
            });
            
            btnAddClient.addEventListener("click", () => {
                editingClientId = null;
                clientNameInput.value = "";
                clientFormMsg.textContent = "";
                clearContactFields();
                addContactField();
                document.querySelector('.client-form-title').textContent = "New Client";
                clientFormModal.show();
            });

            clientSaveBtn.addEventListener("click", saveClient);
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // ---------- Templates Management ----------
        let templates = [];
        let templateVariables = [
            { key: '{{clientName}}', label: 'Client Name', description: 'The name of the client' },
            { key: '{{clientEmail}}', label: 'Client Email', description: 'The email of the client' },
            { key: '{{eventDate}}', label: 'Event Date', description: 'The date of the event' },
            { key: '{{eventLocation}}', label: 'Event Location', description: 'The venue/address of the event' },
            { key: '{{guestCount}}', label: 'Guest Count', description: 'Number of guests expected' },
            { key: '{{eventTime}}', label: 'Event Time', description: 'Start/End time of the event' },
            { key: '{{companyName}}', label: 'Company Name', description: 'Your company name from settings' },
            { key: '{{repName}}', label: 'Rep Name', description: 'Your representative name from settings' },
            { key: '{{todayDate}}', label: 'Today Date', description: 'Current date when contract is created' },
        ];
        let editingTemplateId = null;
        let templateEditorModal = null;

        // Initialize template modal
        function initializeTemplateModal() {
            templateEditorModal = new bootstrap.Modal(document.getElementById('templateEditorModal'));
            
            // Save template button
            document.getElementById('template-save-btn').addEventListener('click', saveTemplate);
        }

        async function loadTemplates() {
            try {
                const result = await callCG({ action: 'listTemplates' });
                if (result.success) {
                    templates = result.templates || [];
                    templateVariables = result.variables || templateVariables; // Keep defaults if not returned
                    renderTemplates();
                    renderVariablesBadges();
                    updateTemplatesCountBadge();
                }
            } catch (err) {
                console.error('Error loading templates:', err);
                showToast('Failed to load templates', 'error');
            }
        }

        function renderVariablesBadges() {
            const container = document.getElementById('variables-badges');
            if (!container) return;
            
            container.innerHTML = templateVariables.map(v => 
                `<span class="badge bg-primary bg-opacity-10 text-primary" title="${v.description}">${v.key}</span>`
            ).join('');
        }

        function updateTemplatesCountBadge() {
            const badge = document.getElementById('templates-count-badge');
            if (badge) {
                badge.textContent = templates.length;
            }
        }

        function renderTemplates(searchTerm = '') {
            const container = document.getElementById('templates-list');
            if (!container) return;

            // Filter templates based on search term
            const filteredTemplates = searchTerm 
                ? templates.filter(t => 
                    t.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (t.description && t.description.toLowerCase().includes(searchTerm.toLowerCase()))
                )
                : templates;

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-file-earmark-text d-block mb-2" style="font-size: 2rem;"></i>
                        <p class="mb-2">No templates yet</p>
                        <button class="btn btn-primary btn-sm" onclick="openTemplateModal()">
                            <i class="bi bi-plus-lg me-1"></i>Create Your First Template
                        </button>
                    </div>
                `;
                updateTemplatesCountBadge();
                return;
            }

            if (filteredTemplates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-search d-block mb-2" style="font-size: 2rem;"></i>
                        <p class="mb-0">No templates found matching "<strong>${escapeHtml(searchTerm)}</strong>"</p>
                    </div>
                `;
                return;
            }

            const colors = ['primary', 'success', 'warning', 'info', 'secondary'];
            container.innerHTML = filteredTemplates.map((t, index) => {
                const color = colors[index % colors.length];
                const createdDate = t.createdAt ? new Date(t.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                
                return `
                <div class="card border mb-3 template-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-file-earmark-text text-${color} me-2" style="font-size: 1.5rem;"></i>
                                    <h6 class="mb-0 fw-semibold">${escapeHtml(t.name)}</h6>
                                    ${t.isDefault ? '<span class="badge bg-success ms-2">Default</span>' : ''}
                                </div>
                                <p class="text-muted small mb-2">${escapeHtml(t.description || 'No description')}</p>
                                <div class="d-flex gap-3 text-muted small">
                                    <span><i class="bi bi-calendar3 me-1"></i>Created: ${createdDate}</span>
                                    <span><i class="bi bi-arrow-repeat me-1"></i>Used: ${t.usageCount || 0} times</span>
                                </div>
                            </div>
                            <div class="btn-group">
                                ${!t.isDefault ? `<button class="btn btn-sm btn-outline-success" title="Set as Default" onclick="setTemplateDefault('${t.id}')">
                                    <i class="bi bi-star"></i>
                                </button>` : ''}
                                <button class="btn btn-sm btn-outline-primary" title="Edit" onclick="editTemplate('${t.id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" title="Duplicate" onclick="duplicateTemplate('${t.id}')">
                                    <i class="bi bi-copy"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="deleteTemplate('${t.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openTemplateModal(templateId = null) {
            editingTemplateId = templateId;
            
            // Reset form
            document.getElementById('template-name').value = '';
            document.getElementById('template-description').value = '';
            document.getElementById('template-body').value = '';
            document.getElementById('template-is-default').checked = false;
            
            // Update title
            document.getElementById('template-modal-title').textContent = templateId ? 'Edit Template' : 'New Template';
            
            // Render variables panel
            renderVariablesPanel();
            
            // If editing, load template data
            if (templateId) {
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('template-name').value = template.name || '';
                    document.getElementById('template-description').value = template.description || '';
                    document.getElementById('template-body').value = template.body || '';
                    document.getElementById('template-is-default').checked = template.isDefault || false;
                }
            }
            
            templateEditorModal.show();
        }

        function renderVariablesPanel() {
            const container = document.getElementById('template-variables-panel');
            if (!container) return;
            
            container.innerHTML = templateVariables.map(v => 
                `<button type="button" class="btn btn-sm btn-light text-start w-100 border d-flex justify-content-between align-items-center variable-btn" onclick="insertVariable('${v.key}')" title="${v.description}">
                    <span class="fw-medium">${v.label}</span>
                    <code class="small text-primary">${v.key}</code>
                </button>`
            ).join('');
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('template-body');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + variable + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + variable.length, start + variable.length);
        }

        async function saveTemplate() {
            const name = document.getElementById('template-name').value.trim();
            const description = document.getElementById('template-description').value.trim();
            const body = document.getElementById('template-body').value.trim();
            const isDefault = document.getElementById('template-is-default').checked;
            
            if (!name) {
                showToast('Template name is required', 'error');
                return;
            }
            
            if (!body) {
                showToast('Template body is required', 'error');
                return;
            }
            
            try {
                const action = editingTemplateId ? 'updateTemplate' : 'createTemplate';
                const payload = {
                    action,
                    name,
                    description,
                    body,
                    isDefault
                };
                
                if (editingTemplateId) {
                    payload.templateId = editingTemplateId;
                }
                
                const result = await callCG(payload);
                
                if (result.success) {
                    templates = result.templates || [];
                    renderTemplates();
                    templateEditorModal.hide();
                    showToast(editingTemplateId ? 'Template updated!' : 'Template created!', 'success');
                    editingTemplateId = null;
                } else {
                    showToast(result.message || 'Failed to save template', 'error');
                }
            } catch (err) {
                console.error('Error saving template:', err);
                showToast('Failed to save template', 'error');
            }
        }

        function editTemplate(templateId) {
            openTemplateModal(templateId);
        }

        async function duplicateTemplate(templateId) {
            try {
                const result = await callCG({ action: 'duplicateTemplate', templateId });
                if (result.success) {
                    templates = result.templates || [];
                    renderTemplates();
                    showToast('Template duplicated!', 'success');
                } else {
                    showToast(result.message || 'Failed to duplicate template', 'error');
                }
            } catch (err) {
                console.error('Error duplicating template:', err);
                showToast('Failed to duplicate template', 'error');
            }
        }

        async function deleteTemplate(templateId) {
            if (!await showConfirm('Are you sure you want to delete this template?', 'Delete Template')) return;
            
            try {
                const result = await callCG({ action: 'deleteTemplate', templateId });
                if (result.success) {
                    templates = result.templates || [];
                    renderTemplates();
                    showToast('Template deleted!', 'success');
                } else {
                    showToast(result.message || 'Failed to delete template', 'error');
                }
            } catch (err) {
                console.error('Error deleting template:', err);
                showToast('Failed to delete template', 'error');
            }
        }

        async function setTemplateDefault(templateId) {
            try {
                const result = await callCG({ action: 'setDefaultTemplate', templateId });
                if (result.success) {
                    templates = result.templates || [];
                    renderTemplates();
                    showToast('Default template updated!', 'success');
                } else {
                    showToast(result.message || 'Failed to set default', 'error');
                }
            } catch (err) {
                console.error('Error setting default template:', err);
                showToast('Failed to set default template', 'error');
            }
        }

        // Initialize templates search
        function initializeTemplateSearch() {
            const searchInput = document.getElementById('templates-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    renderTemplates(e.target.value.trim());
                });
            }
        }

        // Initialize templates on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize template modal
            initializeTemplateModal();
            // Initialize template search
            initializeTemplateSearch();
        });

        function addContactField(contactData = null) {
            contactCount++;
            const contactId = `contact-${contactCount}`;
            const contactItem = document.createElement('div');
            contactItem.className = 'card bg-light border-0 mb-3 position-relative';
            contactItem.id = contactId;
            contactItem.innerHTML = `
                <div class="card-body p-3">
                    <button type="button" class="btn btn-outline-danger btn-sm position-absolute top-0 end-0 m-2" onclick="removeContactField('${contactId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Person</label>
                            <input type="text" class="form-control" id="${contactId}-person" value="${contactData?.person || ''}" placeholder="Full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Email</label>
                            <input type="email" class="form-control" id="${contactId}-email" value="${contactData?.email || ''}" placeholder="email@domain.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Phone</label>
                            <input type="text" class="form-control" id="${contactId}-phone" value="${contactData?.phone || ''}" placeholder="(555) 123-4567">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Address</label>
                            <input type="text" class="form-control" id="${contactId}-address" value="${contactData?.address || ''}" placeholder="Street address">
                        </div>
                    </div>
                </div>
            `;
            contactsContainer.appendChild(contactItem);
            return contactId;
        }

        function removeContactField(contactId) {
            const contactItem = document.getElementById(contactId);
            if (contactItem) contactItem.remove();
        }

        function clearContactFields() {
            contactsContainer.innerHTML = '';
            contactCount = 0;
        }

        function getContactData() {
            const contacts = [];
            const contactItems = contactsContainer.querySelectorAll('.card');
            contactItems.forEach(item => {
                const id = item.id;
                const person = document.getElementById(`${id}-person`)?.value || '';
                const email = document.getElementById(`${id}-email`)?.value || '';
                const phone = document.getElementById(`${id}-phone`)?.value || '';
                const address = document.getElementById(`${id}-address`)?.value || '';
                if (person || email || phone || address) {
                    contacts.push({ person, email, phone, address });
                }
            });
            return contacts;
        }

        function renderClients() {
            clientsTableBody.innerHTML = "";
            
            const totalClients = clients.length;
            const totalPages = Math.ceil(totalClients / clientsPerPage);
            
            // Ensure current page is valid
            if (clientsCurrentPage > totalPages) clientsCurrentPage = Math.max(1, totalPages);
            
            const startIndex = (clientsCurrentPage - 1) * clientsPerPage;
            const endIndex = Math.min(startIndex + clientsPerPage, totalClients);
            const paginatedClients = clients.slice(startIndex, endIndex);
            
            if (!clients.length) {
                clientsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-people d-block mb-2" style="font-size: 2rem;"></i>
                            No clients yet. Click "Add New Client" to create your first client.
                        </td>
                    </tr>`;
            } else {
                paginatedClients.forEach((c) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="bi bi-person text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">${c.name}</div>
                                </div>
                            </div>
                        </td>
                        <td>${c.contacts?.[0]?.email || '<span class="text-muted">No email</span>'}</td>
                        <td>${c.contacts?.[0]?.phone || '<span class="text-muted">No phone</span>'}</td>
                        <td class="text-center"><span class="badge bg-primary rounded-pill">${c.contacts?.length || 0}</span></td>
                        <td class="text-center">
                            <button class="btn btn-outline-primary btn-sm me-1" data-edit-client-id="${c.id}"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger btn-sm" data-delete-client-id="${c.id}"><i class="bi bi-trash"></i></button>
                        </td>
                    `;
                    clientsTableBody.appendChild(tr);
                });

                document.querySelectorAll("[data-edit-client-id]").forEach((btn) => {
                    btn.addEventListener("click", () => handleEditClient(btn.getAttribute("data-edit-client-id")));
                });

                document.querySelectorAll("[data-delete-client-id]").forEach((btn) => {
                    btn.addEventListener("click", () => handleDeleteClient(btn.getAttribute("data-delete-client-id")));
                });
            }
            
            // Update pagination info
            document.getElementById('clients-page-start').textContent = totalClients > 0 ? startIndex + 1 : 0;
            document.getElementById('clients-page-end').textContent = endIndex;
            document.getElementById('clients-total').textContent = totalClients;
            
            // Update pagination buttons state
            const prevBtn = document.getElementById('clients-prev-page');
            const nextBtn = document.getElementById('clients-next-page');
            if (prevBtn) prevBtn.classList.toggle('disabled', clientsCurrentPage <= 1);
            if (nextBtn) nextBtn.classList.toggle('disabled', clientsCurrentPage >= totalPages);
            
            clientsCountBadge.textContent = String(clients.length);
            
            // Also update the client dropdown in contracts section (if function exists)
            if (typeof populateClientDropdown === 'function') {
                populateClientDropdown();
            }
        }

        // Search functionality
        function initializeClientSearch() {
            const searchInput = document.querySelector('#clients-section .form-control[placeholder="Search clients..."]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const tableRows = document.querySelectorAll('#clients-table-body tr');
                    tableRows.forEach((row) => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }

        async function saveClient() {
            const name = clientNameInput.value.trim();
            const contacts = getContactData();
            
            if (!name) { showToast("Client name is required.", "error"); return; }
            if (contacts.length === 0) { showToast("At least one contact is required.", "error"); return; }
            const hasValidContact = contacts.some(c => c.person.trim() !== '');
            if (!hasValidContact) { showToast("At least one contact person name is required.", "error"); return; }

            try {
                if (editingClientId) {
                    const resp = await callCG({ action: "updateClient", clientId: editingClientId, name, contacts });
                    if (resp.success) {
                        const idx = clients.findIndex(c => c.id === editingClientId);
                        if (idx !== -1) clients[idx] = resp.client;
                        showToast("Client updated successfully!", "success");
                    } else {
                        showToast(resp.message || "Error updating client.", "error");
                    }
                } else {
                    const resp = await callCG({ action: "createClient", name, contacts });
                    if (resp.success) {
                        clients.push(resp.client);
                        showToast("Client created successfully!", "success");
                    } else {
                        showToast(resp.message || "Error creating client.", "error");
                    }
                }
                renderClients();
                clientFormModal.hide();
                clearContactFields();
                editingClientId = null;
            } catch (err) {
                console.error(err);
                showToast("Error saving client.", "error");
            }
        }

        async function handleEditClient(clientId) {
            const client = clients.find((c) => c.id === clientId);
            if (!client) return;
            editingClientId = clientId;
            clientNameInput.value = client.name || "";
            clientFormMsg.textContent = "";
            clearContactFields();
            if (client.contacts && Array.isArray(client.contacts)) {
                client.contacts.forEach(contact => addContactField(contact));
            } else {
                addContactField();
            }
            document.querySelector('.client-form-title').textContent = "Edit Client";
            clientFormModal.show();
        }

        async function handleDeleteClient(clientId) {
            if (!await showConfirm("Are you sure you want to delete this client?", "Delete Client")) return;
            try {
                const resp = await callCG({ action: "deleteClient", clientId });
                if (!resp.success) { showToast(resp.message || "Error deleting client.", "error"); return; }
                clients = clients.filter((c) => c.id !== clientId);
                renderClients();
                showToast("Client deleted successfully!", "success");
            } catch (err) {
                console.error(err);
                showToast("Error deleting client.", "error");
            }
        }

        // ---------- Contracts ----------
        let contracts = [];
        let selectedClientId = null;
        let editingContractId = null; // Track if we're editing a contract
        
        // Pagination state for contracts
        let contractsCurrentPage = 1;
        const contractsPerPage = 10;
        
        const contractsTableBody = document.getElementById("contracts-table-body");
        const contractsCountBadge = document.getElementById("contracts-count-badge");
        const contractClientSelect = document.getElementById("contract-client-select");
        const contractContactSelect = document.getElementById("contract-contact-select");
        const contractClientName = document.getElementById("contract-client-name");
        const contractClientEmail = document.getElementById("contract-client-email");
        const contractEventDate = document.getElementById("contract-event-date");
        const contractEventLocation = document.getElementById("contract-event-location");
        const contractGuestCount = document.getElementById("contract-guest-count");
        
        // Initialize contracts pagination listeners
        document.getElementById('contracts-prev-page')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (contractsCurrentPage > 1) {
                contractsCurrentPage--;
                renderContracts();
            }
        });
        document.getElementById('contracts-next-page')?.addEventListener('click', (e) => {
            e.preventDefault();
            const totalPages = Math.ceil(contracts.length / contractsPerPage);
            if (contractsCurrentPage < totalPages) {
                contractsCurrentPage++;
                renderContracts();
            }
        });
        const contractStartTime = document.getElementById("contract-start-time");
        const contractEndTime = document.getElementById("contract-end-time");
        const contractPreview = document.getElementById("contract-preview");
        const contractSendBtn = document.getElementById("contract-send-btn");
        const contractSendMessage = document.getElementById("contract-send-message");
        const contractTemplateSelect = document.getElementById("contract-template-select");
        
        // Store templates for contract preview
        let contractFormTemplates = [];

        // Populate template dropdown for contract creation
        async function populateTemplateDropdown() {
            try {
                const result = await callCG({ action: 'listTemplates' });
                if (result.success && result.templates) {
                    contractFormTemplates = result.templates;
                    contractTemplateSelect.innerHTML = '<option value="">-- Select a Template (Required) --</option>';
                    result.templates.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.name + (t.isDefault ? ' (Default)' : '');
                        if (t.isDefault) {
                            option.selected = true;
                            selectedTemplateId = t.id; // Store the default template ID
                        }
                        contractTemplateSelect.appendChild(option);
                    });
                    // Update preview with selected template
                    updateContractPreview();
                }
            } catch (err) {
                console.error('Error loading templates for dropdown:', err);
            }
        }

        // Handle template selection change
        contractTemplateSelect.addEventListener('change', function() {
            selectedTemplateId = contractTemplateSelect.value || null;
            updateContractPreview();
        });

        // Populate client dropdown
        function populateClientDropdown() {
            contractClientSelect.innerHTML = '<option value="">-- Choose a Client --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                contractClientSelect.appendChild(option);
            });
        }

        // Populate contact dropdown based on selected client
        function populateContactDropdown(clientId) {
            contractContactSelect.innerHTML = '<option value="">-- Choose a Contact --</option>';
            const client = clients.find(c => c.id === clientId);
            if (client && client.contacts && client.contacts.length > 0) {
                contractContactSelect.disabled = false;
                client.contacts.forEach((contact, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = contact.person || contact.email || `Contact ${index + 1}`;
                    contractContactSelect.appendChild(option);
                });
            } else {
                contractContactSelect.disabled = true;
            }
        }

        // Handle client selection
        contractClientSelect.addEventListener('change', () => {
            const clientId = contractClientSelect.value;
            selectedClientId = clientId;
            
            // Reset contact fields
            contractContactSelect.value = "";
            contractClientName.value = "";
            contractClientEmail.value = "";
            contractEventLocation.value = "";
            
            if (clientId) {
                populateContactDropdown(clientId);
            } else {
                contractContactSelect.innerHTML = '<option value="">-- Choose a Contact --</option>';
                contractContactSelect.disabled = true;
            }
            
            updateContractPreview();
        });

        // Handle contact selection - auto-fill fields
        contractContactSelect.addEventListener('change', () => {
            const contactIndex = contractContactSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            
            if (client && contactIndex !== "" && client.contacts[contactIndex]) {
                const contact = client.contacts[contactIndex];
                contractClientName.value = contact.person || "";
                contractClientEmail.value = contact.email || "";
                contractEventLocation.value = contact.address || "";
            } else {
                contractClientName.value = "";
                contractClientEmail.value = "";
                contractEventLocation.value = "";
            }
            
            updateContractPreview();
        });

        function fmtEventTime() {
            const s = contractStartTime.value;
            const e = contractEndTime.value;
            if (!s && !e) return "____________________________";
            if (s && e) return `${s}  ${e}`;
            return s || e;
        }
        
        function fmtEventDate() {
            return contractEventDate.value || "____________________________";
        }

        function updateContractPreview() {
            const clientName = contractClientName.value || "________________________";
            const clientEmail = contractClientEmail.value || "________________________";
            const eventDate = fmtEventDate();
            const eventLocation = contractEventLocation.value || "____________________________";
            const guestCount = contractGuestCount.value || "____________________________";
            const eventTime = fmtEventTime();
            const companyName = settings.companyName || "Culture Gourmet";
            const repName = settings.repName || "____________________________";
            const todayDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Check if a template is selected
            const selectedTemplateId = contractTemplateSelect.value;
            let templateBody = null;
            
            if (selectedTemplateId && contractFormTemplates.length > 0) {
                const selectedTemplate = contractFormTemplates.find(t => t.id === selectedTemplateId);
                if (selectedTemplate && selectedTemplate.body) {
                    templateBody = selectedTemplate.body;
                }
            }

            let txt;
            if (templateBody) {
                // Replace variables in template body
                txt = templateBody
                    .replace(/\{\{clientName\}\}/g, clientName)
                    .replace(/\{\{clientEmail\}\}/g, clientEmail)
                    .replace(/\{\{eventDate\}\}/g, eventDate)
                    .replace(/\{\{eventLocation\}\}/g, eventLocation)
                    .replace(/\{\{guestCount\}\}/g, guestCount)
                    .replace(/\{\{eventTime\}\}/g, eventTime)
                    .replace(/\{\{companyName\}\}/g, companyName)
                    .replace(/\{\{repName\}\}/g, repName)
                    .replace(/\{\{todayDate\}\}/g, todayDate);
                contractPreview.textContent = txt.trim();
            } else {
                // No template selected - show message
                contractPreview.innerHTML = '<span class="text-muted fst-italic"> Please select a template above to preview the contract.</span>';
            }
        }

        [contractClientName, contractClientEmail, contractEventDate, contractEventLocation, contractGuestCount, contractStartTime, contractEndTime].forEach((el) => {
            el.addEventListener("input", updateContractPreview);
            el.addEventListener("change", updateContractPreview);
        });

        function renderContracts() {
            contractsTableBody.innerHTML = "";
            
            // Sort contracts by createdAt (newest first)
            const sortedContracts = [...contracts].sort((a, b) => {
                const dateA = new Date(a.createdAt || 0);
                const dateB = new Date(b.createdAt || 0);
                return dateB - dateA; // Descending order (newest first)
            });
            
            const totalContracts = sortedContracts.length;
            const totalPages = Math.ceil(totalContracts / contractsPerPage);
            
            // Ensure current page is valid
            if (contractsCurrentPage > totalPages) contractsCurrentPage = Math.max(1, totalPages);
            
            const startIndex = (contractsCurrentPage - 1) * contractsPerPage;
            const endIndex = Math.min(startIndex + contractsPerPage, totalContracts);
            const paginatedContracts = sortedContracts.slice(startIndex, endIndex);
            
            if (!contracts.length) {
                contractsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No contracts found. Create your first contract to get started.</td></tr>';
            } else {
                paginatedContracts.forEach((c) => {
                    const tr = document.createElement("tr");
                    const statusMap = { 'Draft': 'Draft', 'Sent': 'Sent', 'Under Review': 'Under Review', 'Signed': 'Signed' };
                    const status = c.status || 'Draft';
                    const statusText = statusMap[status] || status;
                    const badgeClass = status === 'Signed' ? 'bg-success' : status === 'Under Review' ? 'bg-warning text-dark' : status === 'Sent' ? 'bg-info' : 'bg-secondary';
                    
                    // Format created at timestamp
                    const createdAt = c.createdAt ? new Date(c.createdAt).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    }) : '';

                    tr.innerHTML = `
                        <td class="ps-4">${c.clientName || ""}</td>
                        <td>${c.eventDate ? new Date(c.eventDate).toLocaleDateString() : ""}</td>
                        <td><span class="badge ${badgeClass}">${statusText}</span></td>
                        <td><small class="text-muted">${createdAt}</small></td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm me-1" data-edit-id="${c.id}">Edit</button>
                            <button class="btn btn-outline-info btn-sm me-1" data-resend-id="${c.id}">Resend</button>
                            <button class="btn btn-outline-danger btn-sm me-1" data-delete-id="${c.id}">Delete</button>
                            <a href="theCultureGourmetContractAdmin.html?contractId=${c.id}" class="btn btn-outline-success btn-sm">Open</a>
                        </td>
                    `;
                    contractsTableBody.appendChild(tr);
                });
            }
            
            // Update pagination info
            document.getElementById('contracts-page-start').textContent = totalContracts > 0 ? startIndex + 1 : 0;
            document.getElementById('contracts-page-end').textContent = endIndex;
            document.getElementById('contracts-total').textContent = totalContracts;
            
            // Update pagination buttons state
            const prevBtn = document.getElementById('contracts-prev-page');
            const nextBtn = document.getElementById('contracts-next-page');
            if (prevBtn) prevBtn.classList.toggle('disabled', contractsCurrentPage <= 1);
            if (nextBtn) nextBtn.classList.toggle('disabled', contractsCurrentPage >= totalPages);

            contractsCountBadge.textContent = String(contracts.length);
            updateMetrics();
            renderRecentActivity();

            document.querySelectorAll("[data-edit-id]").forEach(btn => {
                btn.addEventListener("click", (e) => { e.preventDefault(); handleEditContract(btn.getAttribute("data-edit-id")); });
            });

            document.querySelectorAll("[data-resend-id]").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-resend-id");
                    if (await showConfirm("Resend this contract to the client?", "Confirm Resend")) await sendContract(id, true);
                });
            });

            document.querySelectorAll("[data-delete-id]").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-delete-id");
                    if (await showConfirm("Are you sure you want to delete this contract?", "Confirm Delete")) await handleDeleteContract(id);
                });
            });
        }

        async function sendContract(contractId, skipConfirm = false) {
            const contract = contracts.find((c) => c.id === contractId);
            if (!contract) {
                showToast("Contract not found.", "error");
                return;
            }
            
            if (!skipConfirm && !await showConfirm(`Send contract to ${contract.clientEmail}?`, "Send Contract")) return;

            const timestamp = new Date().toLocaleString();
            console.log(`[${timestamp}] Sending contract ${contractId} to ${contract.clientEmail}...`);

            try {
                const resp = await callCG({ action: "sendContract", contractId });
                console.log(`[${new Date().toLocaleString()}] Server response:`, resp);
                
                if (!resp.success) { 
                    console.error(`[${new Date().toLocaleString()}] Send failed:`, resp.message);
                    showToast(resp.message || "Error sending contract.", "error"); 
                    return; 
                }
                
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) contracts[idx] = resp.contract;
                renderContracts();

                if (resp.emailSent) {
                    console.log(`[${new Date().toLocaleString()}] Email sent successfully to ${contract.clientEmail}`);
                    showToast(`Email sent successfully to ${contract.clientEmail}!`, "success");
                } else {
                    console.warn(`[${new Date().toLocaleString()}] Email not sent. Error: ${resp.emailError || 'Not configured'}`);
                    const fullLink = "https://backend.aivisualpro.com" + (resp.contract.fileUrl || "");
                    const subject = "Culture Gourmet Catering Agreement";
                    const body = `Hi ${resp.contract.clientName},\n\nHere is your catering agreement:\n${fullLink}\n\nThank you,\nCulture Gourmet`;
                    if (resp.emailError) {
                        showToast(`Email failed: ${resp.emailError}. Opening mail client.`, "warning");
                    } else {
                        showToast("Email not configured. Opening default mail client.", "info");
                    }
                    window.open(`mailto:${encodeURIComponent(resp.contract.clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, "_blank");
                }
            } catch (err) {
                console.error(`[${new Date().toLocaleString()}] Error:`, err);
                showToast("Error contacting server.", "error");
            }
        }

        async function handleEditContract(contractId) {
            const contract = contracts.find((c) => c.id === contractId);
            if (!contract) {
                showToast("Contract not found locally.", "error");
                return;
            }

            // Set edit mode
            editingContractId = contractId;
            
            // Populate form fields with contract data
            contractClientName.value = contract.clientName || "";
            contractClientEmail.value = contract.clientEmail || "";
            contractEventDate.value = contract.eventDate || "";
            contractEventLocation.value = contract.eventLocation || "";
            contractGuestCount.value = contract.guestCount || "";
            
            // Parse event time (format: "4:00 PM  8:00 PM")
            if (contract.eventTime && contract.eventTime.includes("")) {
                const times = contract.eventTime.split("").map(t => t.trim());
                if (times.length === 2) {
                    contractStartTime.value = convertTo24Hour(times[0]);
                    contractEndTime.value = convertTo24Hour(times[1]);
                }
            } else {
                contractStartTime.value = "";
                contractEndTime.value = "";
            }
            
            // Make fields editable in edit mode
            contractClientName.readOnly = false;
            contractClientEmail.readOnly = false;
            contractClientName.classList.remove('bg-light');
            contractClientEmail.classList.remove('bg-light');
            
            // Hide client/contact selects in edit mode
            contractClientSelect.closest('.mb-3').style.display = 'none';
            contractContactSelect.closest('.mb-3').style.display = 'none';
            
            // Update button text
            contractSendBtn.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Update Contract';
            contractSendBtn.classList.remove('btn-primary');
            contractSendBtn.classList.add('btn-warning');
            
            // Add cancel button if not exists
            if (!document.getElementById('cancel-edit-btn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancel-edit-btn';
                cancelBtn.className = 'btn btn-outline-secondary w-100 mt-2';
                cancelBtn.type = 'button';
                cancelBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Cancel Edit';
                cancelBtn.addEventListener('click', cancelEditMode);
                contractSendBtn.parentNode.insertBefore(cancelBtn, contractSendMessage);
            }
            
            // Open the Create Contract accordion
            const createContractAccordion = document.getElementById('createContract');
            const bsCollapse = new bootstrap.Collapse(createContractAccordion, { show: true });
            
            // Update preview
            updateContractPreview();
            
            // Scroll to form
            createContractAccordion.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showToast("Editing contract - update the fields and click Update Contract", "info");
        }
        
        // Helper function to convert 12-hour time to 24-hour format
        function convertTo24Hour(time12h) {
            if (!time12h) return "";
            const match = time12h.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return "";
            let hours = parseInt(match[1]);
            const minutes = match[2];
            const period = match[3].toUpperCase();
            
            if (period === 'PM' && hours !== 12) hours += 12;
            if (period === 'AM' && hours === 12) hours = 0;
            
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        
        // Cancel edit mode and reset form
        function cancelEditMode() {
            editingContractId = null;
            
            // Reset form
            resetContractForm();
            
            // Restore readonly state
            contractClientName.readOnly = true;
            contractClientEmail.readOnly = true;
            contractClientName.classList.add('bg-light');
            contractClientEmail.classList.add('bg-light');
            
            // Show client/contact selects
            contractClientSelect.closest('.mb-3').style.display = '';
            contractContactSelect.closest('.mb-3').style.display = '';
            
            // Restore button
            contractSendBtn.innerHTML = 'Create Contract';
            contractSendBtn.classList.remove('btn-warning');
            contractSendBtn.classList.add('btn-primary');
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) cancelBtn.remove();
            
            // Close accordion and open view contracts
            const createContractAccordion = document.getElementById('createContract');
            const viewContractsAccordion = document.getElementById('viewContracts');
            new bootstrap.Collapse(createContractAccordion, { hide: true });
            new bootstrap.Collapse(viewContractsAccordion, { show: true });
            
            showToast("Edit cancelled", "info");
        }

        async function handleDeleteContract(contractId) {
            try {
                console.log("[Delete] Deleting contract:", contractId);
                const resp = await callCG({ action: "deleteContract", contractId });
                console.log("[Delete] Response:", resp);
                if (!resp.success) { 
                    showToast(resp.message || "Error deleting contract.", "error"); 
                    return; 
                }
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) contracts.splice(idx, 1);
                renderContracts();
                showToast("Contract deleted.", "success");
            } catch (err) {
                console.error("[Delete] Error:", err);
                showToast("Error contacting server.", "error");
            }
        }

        // Contract Preview Modal elements
        const contractPreviewModal = new bootstrap.Modal(document.getElementById("contractPreviewModal"));
        const confirmCreateBtn = document.getElementById("confirm-create-btn");
        const confirmSendContractBtn = document.getElementById("confirm-send-contract-btn");
        const modalContractPreview = document.getElementById("modal-contract-preview");

        // Show preview modal when clicking Create Contract (or handle Update in edit mode)
        contractSendBtn.addEventListener("click", async () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            if (!clientName || !clientEmail) { 
                contractSendMessage.textContent = "Client name and email are required."; 
                return; 
            }
            
            // Require template selection for new contracts
            const templateId = contractTemplateSelect.value;
            if (!editingContractId && !templateId) {
                contractSendMessage.textContent = "Please select a contract template.";
                showToast("Please select a contract template.", "error");
                return;
            }
            contractSendMessage.textContent = "";
            
            // If in edit mode, update the contract directly
            if (editingContractId) {
                contractSendBtn.disabled = true;
                contractSendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';
                
                try {
                    const resp = await callCG({ 
                        action: "updateContractFields", 
                        contractId: editingContractId,
                        clientName, 
                        clientEmail, 
                        eventDate: contractEventDate.value, 
                        eventLocation: contractEventLocation.value, 
                        guestCount: contractGuestCount.value, 
                        eventTime: fmtEventTime() 
                    });
                    
                    if (!resp.success) { 
                        showToast(resp.message || "Error updating contract.", "error"); 
                        return; 
                    }
                    
                    // Update local contracts array
                    const idx = contracts.findIndex((c) => c.id === editingContractId);
                    if (idx !== -1) contracts[idx] = resp.contract;
                    
                    renderContracts();
                    showToast("Contract updated successfully!", "success");
                    
                    // Exit edit mode
                    cancelEditMode();
                    
                } catch (err) {
                    console.error("[Edit] Error:", err);
                    showToast("Error contacting server.", "error");
                } finally {
                    contractSendBtn.disabled = false;
                    contractSendBtn.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Update Contract';
                }
                return;
            }
            
            // Normal create mode - show preview modal
            // Populate preview modal fields
            const selectedClient = clients.find(c => c.id === selectedClientId);
            document.getElementById("preview-client-name").textContent = selectedClient ? selectedClient.name : clientName;
            document.getElementById("preview-contact-name").textContent = clientName || "-";
            document.getElementById("preview-contact-email").textContent = clientEmail || "-";
            document.getElementById("preview-event-date").textContent = contractEventDate.value || "-";
            document.getElementById("preview-event-location").textContent = contractEventLocation.value || "-";
            document.getElementById("preview-guest-count").textContent = contractGuestCount.value || "-";
            document.getElementById("preview-event-time").textContent = fmtEventTime().replace("____________________________", "-");
            
            // Copy contract text to modal
            modalContractPreview.innerHTML = contractPreview.innerHTML;
            
            // Show the modal
            contractPreviewModal.show();
        });

        // Helper function to reset form after contract creation
        function resetContractForm() {
            contractClientSelect.value = "";
            contractContactSelect.value = "";
            contractContactSelect.innerHTML = '<option value="">-- Choose a Contact --</option>';
            contractContactSelect.disabled = true;
            contractClientName.value = "";
            contractClientEmail.value = "";
            contractEventDate.value = "";
            contractEventLocation.value = "";
            contractGuestCount.value = "";
            contractStartTime.value = "";
            contractEndTime.value = "";
            selectedClientId = null;
            editingContractId = null;
            // Reset to default template if available, otherwise clear
            const defaultOption = Array.from(contractTemplateSelect.options).find(opt => opt.textContent.includes('(Default)'));
            if (defaultOption) {
                contractTemplateSelect.value = defaultOption.value;
                selectedTemplateId = defaultOption.value;
            } else if (contractTemplateSelect.options.length > 1) {
                contractTemplateSelect.selectedIndex = 0;
                selectedTemplateId = null;
            }
            updateContractPreview();
        }

        // Create Contract only (no send)
        confirmCreateBtn.addEventListener("click", async () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            const templateId = contractTemplateSelect.value || null;
            
            confirmCreateBtn.disabled = true;
            confirmSendContractBtn.disabled = true;
            confirmCreateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';
            
            try {
                const resp = await callCG({ 
                    action: "createContract", 
                    clientName, 
                    clientEmail, 
                    eventDate: contractEventDate.value, 
                    eventLocation: contractEventLocation.value, 
                    guestCount: contractGuestCount.value, 
                    eventTime: fmtEventTime(),
                    templateId
                });
                
                if (!resp.success) { 
                    contractSendMessage.textContent = resp.message || "Error creating contract."; 
                    return; 
                }
                
                contracts.push(resp.contract);
                renderContracts();
                contractPreviewModal.hide();
                showToast("Contract created successfully!", "success");
                resetContractForm();
                
            } catch (err) {
                console.error(err);
                contractSendMessage.textContent = "Error contacting server.";
            } finally {
                confirmCreateBtn.disabled = false;
                confirmSendContractBtn.disabled = false;
                confirmCreateBtn.innerHTML = '<i class="bi bi-file-earmark-plus me-1"></i>Create';
            }
        });

        // Create & Send Contract
        confirmSendContractBtn.addEventListener("click", async () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            const templateId = contractTemplateSelect.value || null;
            
            confirmCreateBtn.disabled = true;
            confirmSendContractBtn.disabled = true;
            confirmSendContractBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating & Sending...';
            
            try {
                // First create the contract
                const resp = await callCG({ 
                    action: "createContract", 
                    clientName, 
                    clientEmail, 
                    eventDate: contractEventDate.value, 
                    eventLocation: contractEventLocation.value, 
                    guestCount: contractGuestCount.value, 
                    eventTime: fmtEventTime(),
                    templateId
                });
                
                if (!resp.success) { 
                    contractSendMessage.textContent = resp.message || "Error creating contract."; 
                    return; 
                }
                
                contracts.push(resp.contract);
                
                // Now send the contract automatically
                const sendResp = await callCG({ action: "sendContract", contractId: resp.contract.id });
                
                if (sendResp.success) {
                    // Update contract status locally
                    const idx = contracts.findIndex(c => c.id === resp.contract.id);
                    if (idx !== -1) {
                        contracts[idx].status = "send";
                    }
                    showToast(`Contract created and sent to ${clientEmail}!`, "success");
                } else {
                    showToast("Contract created but failed to send: " + (sendResp.message || "Unknown error"), "warning");
                }
                
                renderContracts();
                contractPreviewModal.hide();
                resetContractForm();
                
            } catch (err) {
                console.error(err);
                contractSendMessage.textContent = "Error contacting server.";
            } finally {
                confirmCreateBtn.disabled = false;
                confirmSendContractBtn.disabled = false;
                confirmSendContractBtn.innerHTML = '<i class="bi bi-send me-1"></i>Create & Send';
            }
        });

        // ---------- Dashboard Metrics & Activity ----------
        const metricTotal = document.getElementById("metric-total");
        const metricSent = document.getElementById("metric-sent");
        const metricUnderReview = document.getElementById("metric-under-review");
        const metricSigned = document.getElementById("metric-signed");
        const recentActivityBody = document.getElementById("recent-activity-body");

        function updateMetrics() {
            const total = contracts.length;
            const sent = contracts.filter((c) => c.status === "Sent").length;
            const signed = contracts.filter((c) => c.status === "Signed").length;
            const under = contracts.filter((c) => c.status === "Under Review").length;
            metricTotal.textContent = total;
            metricSent.textContent = sent;
            metricSigned.textContent = signed;
            metricUnderReview.textContent = under;
        }

        function renderRecentActivity() {
            recentActivityBody.innerHTML = "";
            if (!contracts.length) {
                recentActivityBody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">Activity will appear once you create contracts.</td></tr>';
                return;
            }
            const items = [];
            contracts.forEach((c) => {
                (c.timeline || []).forEach((ev) => {
                    items.push({ clientName: c.clientName, status: c.status, label: ev.label || "Event", at: ev.at || c.createdAt });
                });
            });
            items.sort((a, b) => (a.at || "").localeCompare(b.at || ""));
            const last = items.slice(-5).reverse();
            last.forEach((ev) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td class="ps-4">${ev.clientName}</td><td>${ev.label}</td><td>${ev.at || ""}</td><td class="text-center"><span class="badge bg-secondary">${ev.status || ""}</span></td>`;
                recentActivityBody.appendChild(tr);
            });
        }

        // ---------- Initial Load ----------
        async function loadInitialData() {
            try {
                const [clientsResp, contractsResp] = await Promise.all([
                    callCG({ action: "listClients" }),
                    callCG({ action: "listContracts" }),
                ]);
                clients = clientsResp.clients || [];
                contracts = contractsResp.contracts || [];
                renderClients();
                renderContracts();
                updateContractPreview();
            } catch (err) {
                console.error("Error loading initial data", err);
            }
            loadEmailSettings();
            loadCompanySettings();
            initializeClientSearch();
            populateTemplateDropdown(); // Load templates for contract form
        }

        // ---------- Email Settings (Resend API) ----------
        const resendApiKeyInput = document.getElementById("resend-api-key");
        const resendFromEmailInput = document.getElementById("resend-from-email");

        async function loadEmailSettings() {
            try {
                const resp = await callCG({ action: "getSettings" });
                if (resp.success && resp.settings) {
                    const s = resp.settings;
                    resendApiKeyInput.value = s.resendApiKey || "";
                    resendFromEmailInput.value = s.resendFromEmail || "";
                }
            } catch (e) {
                console.error("Error loading settings", e);
            }
        }

        // ========== Company Settings (Rep Name & Signature) ==========
        const adminCompanyNameInput = document.getElementById("admin-company-name");
        const adminCompanyAddressInput = document.getElementById("admin-company-address");
        const adminRepNameInput = document.getElementById("admin-rep-name");
        const adminSignatureCanvas = document.getElementById("admin-signature-canvas");
        const adminSignaturePreview = document.getElementById("admin-signature-preview");
        const adminSignatureCanvasWrapper = document.getElementById("admin-signature-canvas-wrapper");
        const adminSignatureImg = document.getElementById("admin-signature-img");
        const btnSaveCompany = document.getElementById("btn-save-company");
        const companyMsg = document.getElementById("company-msg");

        let adminSignatureCtx = null;
        let adminIsDrawing = false;
        let adminSignatureData = "";
        let adminCanvasInitialized = false;

        function initAdminSignatureCanvas() {
            if (!adminSignatureCanvas || adminCanvasInitialized) return;
            
            adminSignatureCtx = adminSignatureCanvas.getContext("2d");
            
            // Set canvas size based on container
            const wrapper = adminSignatureCanvasWrapper;
            const width = wrapper.clientWidth - 32; // padding
            adminSignatureCanvas.width = width > 0 ? width : 300;
            adminSignatureCanvas.height = 100;
            
            // Fill with white background
            adminSignatureCtx.fillStyle = "white";
            adminSignatureCtx.fillRect(0, 0, adminSignatureCanvas.width, adminSignatureCanvas.height);
            
            adminSignatureCtx.strokeStyle = "#1a1a2e";
            adminSignatureCtx.lineWidth = 2;
            adminSignatureCtx.lineCap = "round";
            adminSignatureCtx.lineJoin = "round";

            // Mouse events
            adminSignatureCanvas.addEventListener("mousedown", (e) => {
                adminIsDrawing = true;
                adminSignatureCtx.beginPath();
                const rect = adminSignatureCanvas.getBoundingClientRect();
                adminSignatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });

            adminSignatureCanvas.addEventListener("mousemove", (e) => {
                if (!adminIsDrawing) return;
                const rect = adminSignatureCanvas.getBoundingClientRect();
                adminSignatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                adminSignatureCtx.stroke();
            });

            adminSignatureCanvas.addEventListener("mouseup", () => {
                adminIsDrawing = false;
                adminSignatureData = adminSignatureCanvas.toDataURL("image/png");
            });

            adminSignatureCanvas.addEventListener("mouseleave", () => {
                if (adminIsDrawing) {
                    adminIsDrawing = false;
                    adminSignatureData = adminSignatureCanvas.toDataURL("image/png");
                }
            });

            // Touch events
            adminSignatureCanvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                adminIsDrawing = true;
                const touch = e.touches[0];
                const rect = adminSignatureCanvas.getBoundingClientRect();
                adminSignatureCtx.beginPath();
                adminSignatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
            });

            adminSignatureCanvas.addEventListener("touchmove", (e) => {
                e.preventDefault();
                if (!adminIsDrawing) return;
                const touch = e.touches[0];
                const rect = adminSignatureCanvas.getBoundingClientRect();
                adminSignatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                adminSignatureCtx.stroke();
            });

            adminSignatureCanvas.addEventListener("touchend", () => {
                adminIsDrawing = false;
                adminSignatureData = adminSignatureCanvas.toDataURL("image/png");
            });
            
            adminCanvasInitialized = true;
        }

        function clearAdminSignature() {
            if (adminSignatureCtx) {
                adminSignatureCtx.fillStyle = "white";
                adminSignatureCtx.fillRect(0, 0, adminSignatureCanvas.width, adminSignatureCanvas.height);
                adminSignatureData = "";
            }
        }
        
        function editAdminSignature() {
            // Hide preview, show canvas
            adminSignaturePreview.style.display = "none";
            adminSignatureCanvasWrapper.style.display = "block";
            clearAdminSignature();
        }

        async function loadCompanySettings() {
            console.log("[loadCompanySettings] Called...");
            try {
                const resp = await callCG({ action: "getCompanySettings" });
                console.log("[loadCompanySettings] Response:", resp);
                if (resp.success && resp.settings) {
                    const s = resp.settings;
                    console.log("[loadCompanySettings] Settings found:", s);
                    
                    // Update global settings object
                    settings.companyName = s.companyName || "Culture Gourmet";
                    settings.repName = s.repName || "";
                    
                    adminCompanyNameInput.value = s.companyName || "Culture Gourmet";
                    adminCompanyAddressInput.value = s.companyAddress || "";
                    adminRepNameInput.value = s.repName || "";
                    
                    // Show existing signature or canvas
                    if (s.repSignature && s.repSignature.startsWith('data:image')) {
                        adminSignatureData = s.repSignature;
                        adminSignatureImg.src = s.repSignature;
                        adminSignaturePreview.style.display = "block";
                        adminSignatureCanvasWrapper.style.display = "none";
                        console.log("[loadCompanySettings] Signature loaded");
                    } else {
                        adminSignaturePreview.style.display = "none";
                        adminSignatureCanvasWrapper.style.display = "block";
                        console.log("[loadCompanySettings] No signature found");
                    }
                    
                    // Update display
                    const displayEl = document.getElementById("admin-company-display");
                    if (displayEl) displayEl.textContent = s.companyName || "Culture Gourmet";
                } else {
                    console.log("[loadCompanySettings] No settings in response:", resp);
                }
            } catch (e) {
                console.error("[loadCompanySettings] Error:", e);
            }
        }

        btnSaveCompany.addEventListener("click", async () => {
            btnSaveCompany.disabled = true;
            companyMsg.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Saving all settings...</span>';
            
            let hasError = false;
            
            // Save Company Settings
            try {
                const resp = await callCG({ 
                    action: "saveCompanySettings", 
                    companyName: adminCompanyNameInput.value.trim(),
                    companyAddress: adminCompanyAddressInput.value.trim(),
                    repName: adminRepNameInput.value.trim(),
                    repSignature: adminSignatureData
                });
                if (resp.success) {
                    const displayEl = document.getElementById("admin-company-display");
                    if (displayEl) displayEl.textContent = adminCompanyNameInput.value.trim() || "Culture Gourmet";
                    
                    // Show signature preview after saving
                    if (adminSignatureData && adminSignatureData.startsWith('data:image')) {
                        adminSignatureImg.src = adminSignatureData;
                        adminSignaturePreview.style.display = "block";
                        adminSignatureCanvasWrapper.style.display = "none";
                    }
                } else {
                    hasError = true;
                }
            } catch (e) {
                console.error(e);
                hasError = true;
            }
            
            // Save Email Settings
            try {
                const resp = await callCG({ 
                    action: "saveSettings", 
                    resendApiKey: resendApiKeyInput.value.trim(),
                    resendFromEmail: resendFromEmailInput.value.trim()
                });
                if (!resp.success) hasError = true;
            } catch (e) {
                console.error(e);
                hasError = true;
            }
            
            if (hasError) {
                companyMsg.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Error saving some settings</span>';
            } else {
                companyMsg.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>All settings saved successfully!</span>';
            }
            
            btnSaveCompany.disabled = false;
            
            // Clear message after 3 seconds
            setTimeout(() => {
                companyMsg.innerHTML = '';
            }, 3000);
        });

        // Initialize signature canvas when admin section is shown
        document.querySelector('[data-section="admin-section"]').addEventListener("click", () => {
            setTimeout(() => {
                loadCompanySettings();
                loadEmailSettings();
            }, 100);
        });
        
        // Initialize signature canvas when signature tab is clicked
        document.getElementById("signature-tab").addEventListener("shown.bs.tab", () => {
            setTimeout(() => {
                initAdminSignatureCanvas();
            }, 100);
        });
        
        // Also load company settings on page load if admin section is visible
        window.addEventListener('load', () => {
            const hash = window.location.hash.slice(1);
            if (hash === 'admin-section') {
                setTimeout(() => {
                    loadCompanySettings();
                    loadEmailSettings();
                }, 200);
            }
        });

        // Initialize preview
        updateContractPreview();
    </script>
</body>

</html>