<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Culture Gourmet Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <style>
        .hidden { display: none !important; }
        .sidebar { min-height: 100vh; }
        .nav-link.active { background-color: var(--bs-primary); color: white !important; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>

<body class="bg-light">
    <!-- LOGIN -->
    <div id="login-section" class="min-vh-100 d-flex align-items-center justify-content-center p-4">
        <div class="card shadow-sm border-0" style="max-width: 420px; width: 100%;">
            <div class="card-body p-4">
                <h2 class="fw-bold mb-2">Culture Gourmet Portal</h2>
                <p class="text-muted mb-4">Login to manage clients and catering contracts.</p>
                <div class="mb-3">
                    <label for="cg-user-id" class="form-label fw-semibold">User ID</label>
                    <input id="cg-user-id" type="text" class="form-control" placeholder="****" />
                </div>
                <div class="mb-3">
                    <label for="cg-user-pass" class="form-label fw-semibold">Password</label>
                    <input id="cg-user-pass" type="password" class="form-control" placeholder="****" />
                </div>
                <button id="cg-login-btn" class="btn btn-primary w-100" type="button">Login</button>
                <div id="cg-login-error" class="text-danger small mt-2"></div>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-section" class="hidden">
        <div class="d-flex">
            <!-- Sidebar -->
            <aside class="sidebar bg-white border-end p-3" style="width: 250px;">
                <div class="d-flex flex-column h-100">
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Portal</h6>
                        <nav class="nav flex-column gap-1">
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center active" href="#" data-section="home-section" id="nav-home">
                                <span>Home</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="clients-section" id="nav-clients">
                                <span>Clients</span>
                                <span class="badge bg-primary rounded-pill" id="clients-count-badge">0</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="contracts-section" id="nav-contracts">
                                <span>Contracts</span>
                                <span class="badge bg-primary rounded-pill" id="contracts-count-badge">0</span>
                            </a>
                            <a class="nav-link rounded text-secondary d-flex justify-content-between align-items-center" href="#" data-section="admin-section" id="nav-admin">
                                <span>Admin</span>
                            </a>
                        </nav>
                    </div>
                    <div class="mt-auto pt-4 border-top">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Account</h6>
                        <div class="mb-2">
                            <span class="badge bg-primary-subtle text-primary">admin</span>
                        </div>
                        <button id="btn-logout" class="btn btn-outline-danger btn-sm w-100">
                            <i class="bi bi-box-arrow-right me-1"></i>Log out
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-grow-1 p-4" style="min-height: 100vh;">
                <!-- HOME -->
                <section id="home-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1"><i class="bi bi-speedometer2 text-primary me-2"></i>Dashboard</h2>
                            <p class="text-muted mb-0">Overview of your Culture Gourmet contracts and business metrics</p>
                        </div>
                        <button class="btn btn-outline-primary" type="button">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
                        </button>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-3 p-3 me-3">
                                            <i class="bi bi-file-earmark-text text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Total Contracts</div>
                                            <div class="fs-3 fw-bold" id="metric-total">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-info rounded-3 p-3 me-3">
                                            <i class="bi bi-send text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Sent</div>
                                            <div class="fs-3 fw-bold" id="metric-sent">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-warning rounded-3 p-3 me-3">
                                            <i class="bi bi-eye text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Under Review</div>
                                            <div class="fs-3 fw-bold" id="metric-under-review">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-3 p-3 me-3">
                                            <i class="bi bi-check-circle text-white fs-4"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small text-uppercase">Signed</div>
                                            <div class="fs-3 fw-bold" id="metric-signed">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="card-title mb-0 fw-semibold">
                                <i class="bi bi-clock-history me-2 text-primary"></i>Recent Activity
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4">Client</th>
                                            <th class="border-0 py-3">Event</th>
                                            <th class="border-0 py-3">When</th>
                                            <th class="border-0 py-3 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-activity-body">
                                        <tr>
                                            <td colspan="4" class="text-center py-5 text-muted">
                                                <i class="bi bi-clock-history d-block mb-2" style="font-size: 2rem;"></i>
                                                No recent activity
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CLIENTS -->
                <section id="clients-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1"><i class="bi bi-people-fill text-primary me-2"></i>Clients</h2>
                            <p class="text-muted mb-0">Manage your client database and contact information</p>
                        </div>
                        <button id="btn-add-client" class="btn btn-primary" type="button">
                            <i class="bi bi-plus-circle me-2"></i>Add New Client
                        </button>
                    </div>
                    
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-semibold">
                                    <i class="bi bi-table me-2 text-primary"></i>All Clients
                                </h5>
                                <div class="input-group" style="width: 250px;">
                                    <span class="input-group-text bg-light border-end-0">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0 bg-light" placeholder="Search clients...">
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4">Client Name</th>
                                            <th class="border-0 py-3">Email</th>
                                            <th class="border-0 py-3">Phone</th>
                                            <th class="border-0 py-3 text-center">Contacts</th>
                                            <th class="border-0 py-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clients-table-body">
                                        <tr>
                                            <td colspan="5" class="text-center py-5 text-muted">
                                                <i class="bi bi-people d-block mb-2" style="font-size: 2rem;"></i>
                                                No clients yet
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CONTRACTS -->
                <section id="contracts-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1"><i class="bi bi-file-earmark-text text-primary me-2"></i>Contracts</h2>
                            <p class="text-muted mb-0">Create and manage Culture Gourmet catering agreements</p>
                        </div>
                    </div>

                    <div class="accordion" id="contractsAccordion">
                        <!-- Create Contract -->
                        <div class="accordion-item border-0 shadow-sm mb-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#createContract">
                                    <i class="bi bi-plus-circle me-2"></i>Create New Contract
                                </button>
                            </h2>
                            <div id="createContract" class="accordion-collapse collapse" data-bs-parent="#contractsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-lg-5">
                                            <div class="mb-3">
                                                <label for="contract-client-select" class="form-label fw-semibold">Select Client</label>
                                                <select id="contract-client-select" class="form-select">
                                                    <option value="">-- Choose a Client --</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-contact-select" class="form-label fw-semibold">Select Contact</label>
                                                <select id="contract-contact-select" class="form-select" disabled>
                                                    <option value="">-- Choose a Contact --</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-client-name" class="form-label fw-semibold">Contact Name</label>
                                                <input id="contract-client-name" type="text" class="form-control bg-light" placeholder="Auto-filled from contact" readonly />
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-client-email" class="form-label fw-semibold">Contact Email</label>
                                                <input id="contract-client-email" type="email" class="form-control bg-light" placeholder="Auto-filled from contact" readonly />
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-event-location" class="form-label fw-semibold">Event Location</label>
                                                <input id="contract-event-location" type="text" class="form-control" placeholder="Venue / Address (auto-filled or edit)" />
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-event-date" class="form-label fw-semibold">Event Date</label>
                                                <input id="contract-event-date" type="date" class="form-control" />
                                            </div>
                                            <div class="mb-3">
                                                <label for="contract-guest-count" class="form-label fw-semibold">Guest Count</label>
                                                <input id="contract-guest-count" type="number" min="1" class="form-control" placeholder="e.g. 80" />
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">Event Start / End Time</label>
                                                <div class="d-flex gap-2">
                                                    <input id="contract-start-time" type="time" class="form-control" />
                                                    <input id="contract-end-time" type="time" class="form-control" />
                                                </div>
                                            </div>
                                            <button id="contract-send-btn" class="btn btn-primary w-100" type="button">Create Contract</button>
                                            <div id="contract-send-message" class="text-success small mt-2"></div>
                                        </div>
                                        <div class="col-lg-7">
                                            <label class="form-label fw-semibold">Live Contract Preview</label>
                                            <p class="text-muted small">Updates as you type client details.</p>
                                            <div id="contract-preview" class="bg-light rounded p-3 border" style="white-space: pre-wrap; font-size: 13px; max-height: 400px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- View Contracts -->
                        <div class="accordion-item border-0 shadow-sm">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#viewContracts">
                                    <i class="bi bi-list-ul me-2"></i>View Contracts
                                </button>
                            </h2>
                            <div id="viewContracts" class="accordion-collapse collapse show" data-bs-parent="#contractsAccordion">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="border-0 py-3 ps-4">Client</th>
                                                    <th class="border-0 py-3">Event Date</th>
                                                    <th class="border-0 py-3">Status</th>
                                                    <th class="border-0 py-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="contracts-table-body">
                                                <tr>
                                                    <td colspan="4" class="text-center py-5 text-muted">
                                                        No contracts found. Create your first contract to get started.
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ADMIN -->
                <section id="admin-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1"><i class="bi bi-gear text-primary me-2"></i>Admin Settings</h2>
                            <p class="text-muted mb-0">Configure company profile and system preferences</p>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white py-3">
                                    <h5 class="card-title mb-0 fw-semibold">
                                        <i class="bi bi-building me-2 text-primary"></i>Company Profile
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="admin-company-name" class="form-label fw-semibold">Company Name</label>
                                        <input id="admin-company-name" type="text" class="form-control" value="Culture Gourmet" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="admin-company-address" class="form-label fw-semibold">Business Address</label>
                                        <textarea id="admin-company-address" rows="4" class="form-control" placeholder="Enter your business address..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white py-3">
                                    <h5 class="card-title mb-0 fw-semibold">
                                        <i class="bi bi-envelope-at me-2 text-primary"></i>Email Settings
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Resend API (Recommended for Cloud) -->
                                    <div class="alert alert-info mb-3">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <strong>Resend API</strong> is recommended for cloud hosting (Render, Vercel, etc.)
                                    </div>
                                    <div class="mb-3">
                                        <label for="resend-api-key" class="form-label fw-semibold">Resend API Key</label>
                                        <input id="resend-api-key" type="password" class="form-control" placeholder="re_xxxxxxxxx" />
                                        <small class="text-muted">Get your API key from <a href="https://resend.com" target="_blank">resend.com</a></small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="resend-from-email" class="form-label fw-semibold">Resend From Email</label>
                                        <input id="resend-from-email" type="text" class="form-control" placeholder="onboarding@resend.dev" />
                                        <small class="text-muted">Use your verified domain or onboarding@resend.dev for testing</small>
                                    </div>
                                    <hr class="my-3">
                                    <p class="text-muted small mb-2"><i class="bi bi-info-circle me-1"></i>SMTP is used as fallback (works on localhost)</p>
                                    <div class="mb-3">
                                        <label for="smtp-host" class="form-label fw-semibold">SMTP Host</label>
                                        <input id="smtp-host" type="text" class="form-control" placeholder="smtp.gmail.com" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-port" class="form-label fw-semibold">SMTP Port</label>
                                        <input id="smtp-port" type="number" class="form-control" placeholder="587" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-user" class="form-label fw-semibold">SMTP User (Email)</label>
                                        <input id="smtp-user" type="text" class="form-control" placeholder="you@gmail.com" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-pass" class="form-label fw-semibold">SMTP Password</label>
                                        <input id="smtp-pass" type="password" class="form-control" placeholder="App Password" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-from" class="form-label fw-semibold">From Name (Optional)</label>
                                        <input id="smtp-from" type="text" class="form-control" placeholder="Culture Gourmet" />
                                    </div>
                                    <button id="btn-save-smtp" class="btn btn-primary w-100" type="button">
                                        <i class="bi bi-check-circle me-1"></i>Save Email Settings
                                    </button>
                                    <div id="smtp-msg" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Client Form Modal -->
    <div class="modal fade" id="clientFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i><span class="client-form-title">New Client</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label for="client-name-input" class="form-label fw-semibold">Client Name *</label>
                        <input id="client-name-input" type="text" class="form-control" placeholder="Enter client or company name" required>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-semibold mb-0"><i class="bi bi-people me-2 text-primary"></i>Contact Information</h6>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addContactField()">
                            <i class="bi bi-plus me-1"></i>Add Contact
                        </button>
                    </div>
                    <div id="contacts-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="client-save-btn" type="button" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Save Client
                    </button>
                </div>
                <div id="client-form-msg" class="px-3 pb-3"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirm-title">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-text">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="confirm-no">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-yes">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Preview Modal -->
    <div class="modal fade" id="contractPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>Draft Contract Preview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Please review the contract details below before confirming.
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-person me-2"></i>Client Details</h6>
                                    <p class="mb-1"><strong>Client:</strong> <span id="preview-client-name">-</span></p>
                                    <p class="mb-1"><strong>Contact:</strong> <span id="preview-contact-name">-</span></p>
                                    <p class="mb-0"><strong>Email:</strong> <span id="preview-contact-email">-</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-calendar-event me-2"></i>Event Details</h6>
                                    <p class="mb-1"><strong>Date:</strong> <span id="preview-event-date">-</span></p>
                                    <p class="mb-1"><strong>Location:</strong> <span id="preview-event-location">-</span></p>
                                    <p class="mb-1"><strong>Guests:</strong> <span id="preview-guest-count">-</span></p>
                                    <p class="mb-0"><strong>Time:</strong> <span id="preview-event-time">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h6 class="fw-bold text-primary mb-2"><i class="bi bi-file-text me-2"></i>Full Contract</h6>
                    <div id="modal-contract-preview" class="bg-light rounded p-3 border" style="white-space: pre-wrap; font-size: 13px; max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-primary" id="confirm-create-btn">
                        <i class="bi bi-file-earmark-plus me-1"></i>Create
                    </button>
                    <button type="button" class="btn btn-success" id="confirm-send-contract-btn">
                        <i class="bi bi-send me-1"></i>Create & Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Bootstrap JS - MUST be before our custom script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
        // ---------- UI Helpers ----------
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toastEl = document.createElement('div');
            toastEl.className = `toast show align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'primary'} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toastEl);
            setTimeout(() => toastEl.remove(), 4000);
        }

        let confirmResolve = null;
        let confirmModal = null;
        
        function showConfirm(message, title = "Confirm Action") {
            return new Promise((resolve) => {
                if (!confirmModal) {
                    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                }
                confirmResolve = resolve;
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-text').textContent = message;
                confirmModal.show();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('confirm-yes').addEventListener('click', () => {
                if (confirmModal) confirmModal.hide();
                if (confirmResolve) confirmResolve(true);
            });

            document.getElementById('confirm-no').addEventListener('click', () => {
                if (confirmModal) confirmModal.hide();
                if (confirmResolve) confirmResolve(false);
            });

            document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
                if (confirmResolve) confirmResolve(false);
            });
        });

        // ---------- Simple Login ----------
        const LOGIN_USER = "admin";
        const LOGIN_PASS = "Abc123***";

        const loginSection = document.getElementById("login-section");
        const appSection = document.getElementById("app-section");
        const loginBtn = document.getElementById("cg-login-btn");
        const loginErr = document.getElementById("cg-login-error");
        const userIdInput = document.getElementById("cg-user-id");
        const userPassInput = document.getElementById("cg-user-pass");
        const btnLogout = document.getElementById("btn-logout");

        function showApp() {
            loginSection.classList.add("hidden");
            appSection.classList.remove("hidden");
            loadInitialData();
            window.location.hash = '';
            activateSection('home-section');
        }

        function showLogin() {
            appSection.classList.add("hidden");
            loginSection.classList.remove("hidden");
            window.location.hash = 'login';
        }

        loginBtn.addEventListener("click", () => {
            const u = userIdInput.value.trim();
            const p = userPassInput.value.trim();
            if (u === LOGIN_USER && p === LOGIN_PASS) {
                loginErr.textContent = "";
                localStorage.setItem("cg_auth", "true");
                showApp();
            } else {
                loginErr.textContent = "Invalid credentials.";
            }
        });

        btnLogout.addEventListener("click", () => {
            localStorage.removeItem("cg_auth");
            showLogin();
        });

        // ---------- Navigation ----------
        const sections = {
            "home-section": document.getElementById("home-section"),
            "clients-section": document.getElementById("clients-section"),
            "contracts-section": document.getElementById("contracts-section"),
            "admin-section": document.getElementById("admin-section"),
        };
        const navItems = document.querySelectorAll(".nav-link[data-section]");

        function activateSection(id) {
            window.location.hash = id;
            Object.keys(sections).forEach((key) => {
                sections[key].classList.toggle("hidden", key !== id);
            });
            navItems.forEach((item) => {
                item.classList.toggle("active", item.getAttribute("data-section") === id);
            });
        }

        navItems.forEach((item) => {
            item.addEventListener("click", (e) => {
                e.preventDefault();
                const id = item.getAttribute("data-section");
                if (id) activateSection(id);
            });
        });

        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            const isAuthenticated = localStorage.getItem("cg_auth") === "true";
            if (hash === 'login') showLogin();
            else if (hash && sections[hash] && isAuthenticated) activateSection(hash);
            else if (!isAuthenticated) showLogin();
        });

        window.addEventListener('load', () => {
            // Initialize client elements and modals after DOM is ready
            initializeClientElements();
            
            const hash = window.location.hash.slice(1);
            const isAuthenticated = localStorage.getItem("cg_auth") === "true";
            if (hash === 'login' || !isAuthenticated) showLogin();
            else if (hash && sections[hash] && isAuthenticated) { showApp(); activateSection(hash); }
            else if (isAuthenticated) showApp();
            else showLogin();
        });

        // ---------- API Helper ----------
        const API_URL = "/webhook/theCultureGourmetContract";

        async function callCG(payload) {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const raw = await res.json();
            return raw.result || raw;
        }

        // ---------- Clients ----------
        let clients = [];
        let editingClientId = null;
        let clientsTableBody, clientsCountBadge, btnAddClient, clientNameInput, clientSaveBtn, clientFormMsg, contactsContainer, clientFormModal;
        let contactCount = 0;

        function initializeClientElements() {
            clientsTableBody = document.getElementById("clients-table-body");
            clientsCountBadge = document.getElementById("clients-count-badge");
            btnAddClient = document.getElementById("btn-add-client");
            clientNameInput = document.getElementById("client-name-input");
            clientSaveBtn = document.getElementById("client-save-btn");
            clientFormMsg = document.getElementById("client-form-msg");
            contactsContainer = document.getElementById("contacts-container");
            clientFormModal = new bootstrap.Modal(document.getElementById('clientFormModal'));
            
            btnAddClient.addEventListener("click", () => {
                editingClientId = null;
                clientNameInput.value = "";
                clientFormMsg.textContent = "";
                clearContactFields();
                addContactField();
                document.querySelector('.client-form-title').textContent = "New Client";
                clientFormModal.show();
            });

            clientSaveBtn.addEventListener("click", saveClient);
        }

        function addContactField(contactData = null) {
            contactCount++;
            const contactId = `contact-${contactCount}`;
            const contactItem = document.createElement('div');
            contactItem.className = 'card bg-light border-0 mb-3 position-relative';
            contactItem.id = contactId;
            contactItem.innerHTML = `
                <div class="card-body p-3">
                    <button type="button" class="btn btn-outline-danger btn-sm position-absolute top-0 end-0 m-2" onclick="removeContactField('${contactId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Person</label>
                            <input type="text" class="form-control" id="${contactId}-person" value="${contactData?.person || ''}" placeholder="Full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Email</label>
                            <input type="email" class="form-control" id="${contactId}-email" value="${contactData?.email || ''}" placeholder="email@domain.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Phone</label>
                            <input type="text" class="form-control" id="${contactId}-phone" value="${contactData?.phone || ''}" placeholder="(555) 123-4567">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">Contact Address</label>
                            <input type="text" class="form-control" id="${contactId}-address" value="${contactData?.address || ''}" placeholder="Street address">
                        </div>
                    </div>
                </div>
            `;
            contactsContainer.appendChild(contactItem);
            return contactId;
        }

        function removeContactField(contactId) {
            const contactItem = document.getElementById(contactId);
            if (contactItem) contactItem.remove();
        }

        function clearContactFields() {
            contactsContainer.innerHTML = '';
            contactCount = 0;
        }

        function getContactData() {
            const contacts = [];
            const contactItems = contactsContainer.querySelectorAll('.card');
            contactItems.forEach(item => {
                const id = item.id;
                const person = document.getElementById(`${id}-person`)?.value || '';
                const email = document.getElementById(`${id}-email`)?.value || '';
                const phone = document.getElementById(`${id}-phone`)?.value || '';
                const address = document.getElementById(`${id}-address`)?.value || '';
                if (person || email || phone || address) {
                    contacts.push({ person, email, phone, address });
                }
            });
            return contacts;
        }

        function renderClients() {
            clientsTableBody.innerHTML = "";
            if (!clients.length) {
                clientsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-people d-block mb-2" style="font-size: 2rem;"></i>
                            No clients yet. Click "Add New Client" to create your first client.
                        </td>
                    </tr>`;
            } else {
                clients.forEach((c) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="bi bi-person text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">${c.name}</div>
                                    <small class="text-muted">ID: ${c.id}</small>
                                </div>
                            </div>
                        </td>
                        <td>${c.contacts?.[0]?.email || '<span class="text-muted">No email</span>'}</td>
                        <td>${c.contacts?.[0]?.phone || '<span class="text-muted">No phone</span>'}</td>
                        <td class="text-center"><span class="badge bg-primary rounded-pill">${c.contacts?.length || 0}</span></td>
                        <td class="text-center">
                            <button class="btn btn-outline-primary btn-sm me-1" data-edit-client-id="${c.id}"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger btn-sm" data-delete-client-id="${c.id}"><i class="bi bi-trash"></i></button>
                        </td>
                    `;
                    clientsTableBody.appendChild(tr);
                });

                document.querySelectorAll("[data-edit-client-id]").forEach((btn) => {
                    btn.addEventListener("click", () => handleEditClient(btn.getAttribute("data-edit-client-id")));
                });

                document.querySelectorAll("[data-delete-client-id]").forEach((btn) => {
                    btn.addEventListener("click", () => handleDeleteClient(btn.getAttribute("data-delete-client-id")));
                });
            }
            clientsCountBadge.textContent = String(clients.length);
            
            // Also update the client dropdown in contracts section (if function exists)
            if (typeof populateClientDropdown === 'function') {
                populateClientDropdown();
            }
        }

        // Search functionality
        function initializeClientSearch() {
            const searchInput = document.querySelector('#clients-section .form-control[placeholder="Search clients..."]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const tableRows = document.querySelectorAll('#clients-table-body tr');
                    tableRows.forEach((row) => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }

        async function saveClient() {
            const name = clientNameInput.value.trim();
            const contacts = getContactData();
            
            if (!name) { showToast("Client name is required.", "error"); return; }
            if (contacts.length === 0) { showToast("At least one contact is required.", "error"); return; }
            const hasValidContact = contacts.some(c => c.person.trim() !== '');
            if (!hasValidContact) { showToast("At least one contact person name is required.", "error"); return; }

            try {
                if (editingClientId) {
                    const resp = await callCG({ action: "updateClient", clientId: editingClientId, name, contacts });
                    if (resp.success) {
                        const idx = clients.findIndex(c => c.id === editingClientId);
                        if (idx !== -1) clients[idx] = resp.client;
                        showToast("Client updated successfully!", "success");
                    } else {
                        showToast(resp.message || "Error updating client.", "error");
                    }
                } else {
                    const resp = await callCG({ action: "createClient", name, contacts });
                    if (resp.success) {
                        clients.push(resp.client);
                        showToast("Client created successfully!", "success");
                    } else {
                        showToast(resp.message || "Error creating client.", "error");
                    }
                }
                renderClients();
                clientFormModal.hide();
                clearContactFields();
                editingClientId = null;
            } catch (err) {
                console.error(err);
                showToast("Error saving client.", "error");
            }
        }

        async function handleEditClient(clientId) {
            const client = clients.find((c) => c.id === clientId);
            if (!client) return;
            editingClientId = clientId;
            clientNameInput.value = client.name || "";
            clientFormMsg.textContent = "";
            clearContactFields();
            if (client.contacts && Array.isArray(client.contacts)) {
                client.contacts.forEach(contact => addContactField(contact));
            } else {
                addContactField();
            }
            document.querySelector('.client-form-title').textContent = "Edit Client";
            clientFormModal.show();
        }

        async function handleDeleteClient(clientId) {
            if (!await showConfirm("Are you sure you want to delete this client?", "Delete Client")) return;
            try {
                const resp = await callCG({ action: "deleteClient", clientId });
                if (!resp.success) { showToast(resp.message || "Error deleting client.", "error"); return; }
                clients = clients.filter((c) => c.id !== clientId);
                renderClients();
                showToast("Client deleted successfully!", "success");
            } catch (err) {
                console.error(err);
                showToast("Error deleting client.", "error");
            }
        }

        // ---------- Contracts ----------
        let contracts = [];
        let selectedClientId = null;
        const contractsTableBody = document.getElementById("contracts-table-body");
        const contractsCountBadge = document.getElementById("contracts-count-badge");
        const contractClientSelect = document.getElementById("contract-client-select");
        const contractContactSelect = document.getElementById("contract-contact-select");
        const contractClientName = document.getElementById("contract-client-name");
        const contractClientEmail = document.getElementById("contract-client-email");
        const contractEventDate = document.getElementById("contract-event-date");
        const contractEventLocation = document.getElementById("contract-event-location");
        const contractGuestCount = document.getElementById("contract-guest-count");
        const contractStartTime = document.getElementById("contract-start-time");
        const contractEndTime = document.getElementById("contract-end-time");
        const contractPreview = document.getElementById("contract-preview");
        const contractSendBtn = document.getElementById("contract-send-btn");
        const contractSendMessage = document.getElementById("contract-send-message");

        // Populate client dropdown
        function populateClientDropdown() {
            contractClientSelect.innerHTML = '<option value="">-- Choose a Client --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                contractClientSelect.appendChild(option);
            });
        }

        // Populate contact dropdown based on selected client
        function populateContactDropdown(clientId) {
            contractContactSelect.innerHTML = '<option value="">-- Choose a Contact --</option>';
            const client = clients.find(c => c.id === clientId);
            if (client && client.contacts && client.contacts.length > 0) {
                contractContactSelect.disabled = false;
                client.contacts.forEach((contact, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = contact.person || contact.email || `Contact ${index + 1}`;
                    contractContactSelect.appendChild(option);
                });
            } else {
                contractContactSelect.disabled = true;
            }
        }

        // Handle client selection
        contractClientSelect.addEventListener('change', () => {
            const clientId = contractClientSelect.value;
            selectedClientId = clientId;
            
            // Reset contact fields
            contractContactSelect.value = "";
            contractClientName.value = "";
            contractClientEmail.value = "";
            contractEventLocation.value = "";
            
            if (clientId) {
                populateContactDropdown(clientId);
            } else {
                contractContactSelect.innerHTML = '<option value="">-- Choose a Contact --</option>';
                contractContactSelect.disabled = true;
            }
            
            updateContractPreview();
        });

        // Handle contact selection - auto-fill fields
        contractContactSelect.addEventListener('change', () => {
            const contactIndex = contractContactSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            
            if (client && contactIndex !== "" && client.contacts[contactIndex]) {
                const contact = client.contacts[contactIndex];
                contractClientName.value = contact.person || "";
                contractClientEmail.value = contact.email || "";
                contractEventLocation.value = contact.address || "";
            } else {
                contractClientName.value = "";
                contractClientEmail.value = "";
                contractEventLocation.value = "";
            }
            
            updateContractPreview();
        });

        function fmtEventTime() {
            const s = contractStartTime.value;
            const e = contractEndTime.value;
            if (!s && !e) return "____________________________";
            if (s && e) return `${s}  ${e}`;
            return s || e;
        }
        
        function fmtEventDate() {
            return contractEventDate.value || "____________________________";
        }

        function updateContractPreview() {
            const clientName = contractClientName.value || "________________________";
            const eventDate = fmtEventDate();
            const eventLocation = contractEventLocation.value || "____________________________";
            const guestCount = contractGuestCount.value || "____________________________";
            const eventTime = fmtEventTime();

            const txt = `
CULTURE GOURMET  CATERING AGREEMENT
(One-Page Contract)

This Catering Agreement ("Agreement") is entered into between Culture Gourmet ("Caterer") and the undersigned ${clientName} ("Client") for catering services on the date listed below.

1. EVENT DETAILS
Client Name: ${clientName}
Event Date: ${eventDate}
Event Location: ${eventLocation}
Guest Count: ${guestCount}
Event Start/End Time: ${eventTime}

2. SERVICE AREA
Culture Gourmet provides catering services locally within the DMV and nationwide, subject to travel fees.

3. DEPOSIT & BOOKING POLICY
- A 50% deposit is required to secure the event date.
- The deposit is non-refundable and holds the selected date.
- In cases of inclement weather, the deposit is fully transferable to a new mutually agreed-upon date.

4. CANCELLATION POLICY
If the Client cancels for any reason:
- Payments made are credited in full toward a future event date within 12 months.
- No cash refunds will be provided.

5. RESCHEDULING POLICY
- Rescheduling due to weather or unforeseen circumstances is allowed at no additional cost, pending availability.
- New dates are subject to availability and may incur rate differences on holidays or peak days.

6. PAYMENT TERMS
- Accepted payment methods: Credit Card or Cash.
- All events must be paid in full no later than 14 days prior to the event date.
- If an event is booked within 14 days of the event date, the full invoice amount is due at the time of booking.
- Final payment is non-refundable but fully creditable toward a future date if the event is canceled.

7. ALCOHOL SERVICE (If Applicable)
- Alcohol service is provided only to guests 21+.
- Culture Gourmet is not responsible for guest behavior related to alcohol.
- Client agrees to maintain compliance with all state and local alcohol laws.

8. LIABILITY & DAMAGES
Client is responsible for any damages to equipment, rentals, or property caused by guests. Culture Gourmet is not liable for circumstances outside of its control, including venue limitations, acts of nature, or client-provided items.

9. AGREEMENT & SIGNATURES
By signing below, the Client acknowledges and agrees to all terms outlined.

Client Name: ${clientName}
Client Signature: ________________________________
Date: ____________________

Culture Gourmet Representative: ______________________________
Signature: _____________________________________
Date: ____________________
`;
            contractPreview.textContent = txt.trim();
        }

        [contractClientName, contractClientEmail, contractEventDate, contractEventLocation, contractGuestCount, contractStartTime, contractEndTime].forEach((el) => {
            el.addEventListener("input", updateContractPreview);
            el.addEventListener("change", updateContractPreview);
        });

        function renderContracts() {
            contractsTableBody.innerHTML = "";
            if (!contracts.length) {
                contractsTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">No contracts found. Create your first contract to get started.</td></tr>';
            } else {
                contracts.forEach((c) => {
                    const tr = document.createElement("tr");
                    const statusMap = { 'draft': 'Draft', 'send': 'Sent', 'under-review': 'Under Review', 'reviewed': 'Reviewed', 'signed': 'Signed' };
                    const status = c.status || 'draft';
                    const statusText = statusMap[status] || status;
                    const badgeClass = status === 'signed' ? 'bg-success' : status === 'under-review' ? 'bg-warning' : status === 'send' ? 'bg-info' : 'bg-secondary';

                    tr.innerHTML = `
                        <td class="ps-4">${c.clientName || ""}</td>
                        <td>${c.eventDate ? new Date(c.eventDate).toLocaleDateString() : ""}</td>
                        <td><span class="badge ${badgeClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm me-1" data-edit-id="${c.id}">Edit</button>
                            <button class="btn btn-outline-info btn-sm me-1" data-resend-id="${c.id}">Resend</button>
                            <button class="btn btn-outline-danger btn-sm me-1" data-delete-id="${c.id}">Delete</button>
                            <a href="theCultureGourmetContractAdmin.html?contractId=${c.id}" class="btn btn-outline-success btn-sm">Open</a>
                        </td>
                    `;
                    contractsTableBody.appendChild(tr);
                });
            }

            contractsCountBadge.textContent = String(contracts.length);
            updateMetrics();
            renderRecentActivity();

            document.querySelectorAll("[data-edit-id]").forEach(btn => {
                btn.addEventListener("click", (e) => { e.preventDefault(); handleEditContract(btn.getAttribute("data-edit-id")); });
            });

            document.querySelectorAll("[data-resend-id]").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-resend-id");
                    if (await showConfirm("Resend this contract to the client?", "Confirm Resend")) await sendContract(id, true);
                });
            });

            document.querySelectorAll("[data-delete-id]").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-delete-id");
                    if (await showConfirm("Are you sure you want to delete this contract?", "Confirm Delete")) await handleDeleteContract(id);
                });
            });
        }

        async function sendContract(contractId, skipConfirm = false) {
            const contract = contracts.find((c) => c.id === contractId);
            if (!contract) {
                showToast("Contract not found.", "error");
                return;
            }
            
            if (!skipConfirm && !await showConfirm(`Send contract to ${contract.clientEmail}?`, "Send Contract")) return;

            const timestamp = new Date().toLocaleString();
            console.log(`[${timestamp}] Sending contract ${contractId} to ${contract.clientEmail}...`);

            try {
                const resp = await callCG({ action: "sendContract", contractId });
                console.log(`[${new Date().toLocaleString()}] Server response:`, resp);
                
                if (!resp.success) { 
                    console.error(`[${new Date().toLocaleString()}] Send failed:`, resp.message);
                    showToast(resp.message || "Error sending contract.", "error"); 
                    return; 
                }
                
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) contracts[idx] = resp.contract;
                renderContracts();

                if (resp.emailSent) {
                    console.log(`[${new Date().toLocaleString()}] Email sent successfully to ${contract.clientEmail}`);
                    showToast(`Email sent successfully to ${contract.clientEmail}!`, "success");
                } else {
                    console.warn(`[${new Date().toLocaleString()}] SMTP not used. Error: ${resp.emailError || 'Not configured'}`);
                    const fullLink = "https://backend.aivisualpro.com" + (resp.contract.fileUrl || "");
                    const subject = "Culture Gourmet Catering Agreement";
                    const body = `Hi ${resp.contract.clientName},\n\nHere is your catering agreement:\n${fullLink}\n\nThank you,\nCulture Gourmet`;
                    if (resp.emailError) {
                        showToast(`SMTP failed: ${resp.emailError}. Opening mail client.`, "warning");
                    } else {
                        showToast("SMTP not configured. Opening default mail client.", "info");
                    }
                    window.open(`mailto:${encodeURIComponent(resp.contract.clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, "_blank");
                }
            } catch (err) {
                console.error(`[${new Date().toLocaleString()}] Error:`, err);
                showToast("Error contacting server.", "error");
            }
        }

        async function handleEditContract(contractId) {
            const contract = contracts.find((c) => c.id === contractId);
            if (!contract) return;

            const clientName = prompt("Client Name", contract.clientName || "");
            if (clientName === null) return;
            const clientEmail = prompt("Client Email", contract.clientEmail || "");
            if (clientEmail === null) return;
            const eventDate = prompt("Event Date", contract.eventDate || "");
            if (eventDate === null) return;
            const eventLocation = prompt("Event Location", contract.eventLocation || "");
            if (eventLocation === null) return;
            const guestCount = prompt("Guest Count", contract.guestCount || "");
            if (guestCount === null) return;
            const eventTime = prompt("Event Start/End Time", contract.eventTime || "");
            if (eventTime === null) return;

            try {
                const resp = await callCG({ action: "updateContractFields", contractId, clientName, clientEmail, eventDate, eventLocation, guestCount, eventTime });
                if (!resp.success) { alert(resp.message || "Error updating contract."); return; }
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) contracts[idx] = resp.contract;
                renderContracts();
            } catch (err) {
                console.error(err);
                showToast("Error contacting server.", "error");
            }
        }

        async function handleDeleteContract(contractId) {
            try {
                const resp = await callCG({ action: "deleteContract", contractId });
                if (!resp.success) { showToast(resp.message || "Error deleting contract.", "error"); return; }
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) contracts.splice(idx, 1);
                renderContracts();
                showToast("Contract deleted.", "success");
            } catch (err) {
                console.error(err);
                showToast("Error contacting server.", "error");
            }
        }

        // Contract Preview Modal elements
        const contractPreviewModal = new bootstrap.Modal(document.getElementById("contractPreviewModal"));
        const confirmCreateBtn = document.getElementById("confirm-create-btn");
        const confirmSendContractBtn = document.getElementById("confirm-send-contract-btn");
        const modalContractPreview = document.getElementById("modal-contract-preview");

        // Show preview modal when clicking Create Contract
        contractSendBtn.addEventListener("click", () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            if (!clientName || !clientEmail) { 
                contractSendMessage.textContent = "Client name and email are required."; 
                return; 
            }
            contractSendMessage.textContent = "";
            
            // Populate preview modal fields
            const selectedClient = clients.find(c => c.id === selectedClientId);
            document.getElementById("preview-client-name").textContent = selectedClient ? selectedClient.name : clientName;
            document.getElementById("preview-contact-name").textContent = clientName || "-";
            document.getElementById("preview-contact-email").textContent = clientEmail || "-";
            document.getElementById("preview-event-date").textContent = contractEventDate.value || "-";
            document.getElementById("preview-event-location").textContent = contractEventLocation.value || "-";
            document.getElementById("preview-guest-count").textContent = contractGuestCount.value || "-";
            document.getElementById("preview-event-time").textContent = fmtEventTime().replace("____________________________", "-");
            
            // Copy contract text to modal
            modalContractPreview.textContent = contractPreview.textContent;
            
            // Show the modal
            contractPreviewModal.show();
        });

        // Helper function to reset form after contract creation
        function resetContractForm() {
            contractClientSelect.value = "";
            contractContactSelect.value = "";
            contractContactSelect.innerHTML = '<option value="">-- Choose a Contact --</option>';
            contractContactSelect.disabled = true;
            contractClientName.value = "";
            contractClientEmail.value = "";
            contractEventDate.value = "";
            contractEventLocation.value = "";
            contractGuestCount.value = "";
            contractStartTime.value = "";
            contractEndTime.value = "";
            selectedClientId = null;
            updateContractPreview();
        }

        // Create Contract only (no send)
        confirmCreateBtn.addEventListener("click", async () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            
            confirmCreateBtn.disabled = true;
            confirmSendContractBtn.disabled = true;
            confirmCreateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';
            
            try {
                const resp = await callCG({ 
                    action: "createContract", 
                    clientName, 
                    clientEmail, 
                    eventDate: contractEventDate.value, 
                    eventLocation: contractEventLocation.value, 
                    guestCount: contractGuestCount.value, 
                    eventTime: fmtEventTime() 
                });
                
                if (!resp.success) { 
                    contractSendMessage.textContent = resp.message || "Error creating contract."; 
                    return; 
                }
                
                contracts.push(resp.contract);
                renderContracts();
                contractPreviewModal.hide();
                showToast("Contract created successfully!", "success");
                resetContractForm();
                
            } catch (err) {
                console.error(err);
                contractSendMessage.textContent = "Error contacting server.";
            } finally {
                confirmCreateBtn.disabled = false;
                confirmSendContractBtn.disabled = false;
                confirmCreateBtn.innerHTML = '<i class="bi bi-file-earmark-plus me-1"></i>Create';
            }
        });

        // Create & Send Contract
        confirmSendContractBtn.addEventListener("click", async () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            
            confirmCreateBtn.disabled = true;
            confirmSendContractBtn.disabled = true;
            confirmSendContractBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating & Sending...';
            
            try {
                // First create the contract
                const resp = await callCG({ 
                    action: "createContract", 
                    clientName, 
                    clientEmail, 
                    eventDate: contractEventDate.value, 
                    eventLocation: contractEventLocation.value, 
                    guestCount: contractGuestCount.value, 
                    eventTime: fmtEventTime() 
                });
                
                if (!resp.success) { 
                    contractSendMessage.textContent = resp.message || "Error creating contract."; 
                    return; 
                }
                
                contracts.push(resp.contract);
                
                // Now send the contract automatically
                const sendResp = await callCG({ action: "sendContract", contractId: resp.contract.id });
                
                if (sendResp.success) {
                    // Update contract status locally
                    const idx = contracts.findIndex(c => c.id === resp.contract.id);
                    if (idx !== -1) {
                        contracts[idx].status = "send";
                    }
                    showToast(`Contract created and sent to ${clientEmail}!`, "success");
                } else {
                    showToast("Contract created but failed to send: " + (sendResp.message || "Unknown error"), "warning");
                }
                
                renderContracts();
                contractPreviewModal.hide();
                resetContractForm();
                
            } catch (err) {
                console.error(err);
                contractSendMessage.textContent = "Error contacting server.";
            } finally {
                confirmCreateBtn.disabled = false;
                confirmSendContractBtn.disabled = false;
                confirmSendContractBtn.innerHTML = '<i class="bi bi-send me-1"></i>Create & Send';
            }
        });

        // ---------- Dashboard Metrics & Activity ----------
        const metricTotal = document.getElementById("metric-total");
        const metricSent = document.getElementById("metric-sent");
        const metricUnderReview = document.getElementById("metric-under-review");
        const metricSigned = document.getElementById("metric-signed");
        const recentActivityBody = document.getElementById("recent-activity-body");

        function updateMetrics() {
            const total = contracts.length;
            const sent = contracts.filter((c) => c.status === "Sent").length;
            const signed = contracts.filter((c) => c.status === "Signed").length;
            const under = contracts.filter((c) => c.status === "Under Review").length;
            metricTotal.textContent = total;
            metricSent.textContent = sent;
            metricSigned.textContent = signed;
            metricUnderReview.textContent = under;
        }

        function renderRecentActivity() {
            recentActivityBody.innerHTML = "";
            if (!contracts.length) {
                recentActivityBody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">Activity will appear once you create contracts.</td></tr>';
                return;
            }
            const items = [];
            contracts.forEach((c) => {
                (c.timeline || []).forEach((ev) => {
                    items.push({ clientName: c.clientName, status: c.status, label: ev.label || "Event", at: ev.at || c.createdAt });
                });
            });
            items.sort((a, b) => (a.at || "").localeCompare(b.at || ""));
            const last = items.slice(-5).reverse();
            last.forEach((ev) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td class="ps-4">${ev.clientName}</td><td>${ev.label}</td><td>${ev.at || ""}</td><td class="text-center"><span class="badge bg-secondary">${ev.status || ""}</span></td>`;
                recentActivityBody.appendChild(tr);
            });
        }

        // ---------- Initial Load ----------
        async function loadInitialData() {
            try {
                const [clientsResp, contractsResp] = await Promise.all([
                    callCG({ action: "listClients" }),
                    callCG({ action: "listContracts" }),
                ]);
                clients = clientsResp.clients || [];
                contracts = contractsResp.contracts || [];
                renderClients();
                renderContracts();
                updateContractPreview();
            } catch (err) {
                console.error("Error loading initial data", err);
            }
            loadSmtpSettings();
            initializeClientSearch();
        }

        // ---------- Email Settings ----------
        const resendApiKeyInput = document.getElementById("resend-api-key");
        const resendFromEmailInput = document.getElementById("resend-from-email");
        const smtpHostInput = document.getElementById("smtp-host");
        const smtpPortInput = document.getElementById("smtp-port");
        const smtpUserInput = document.getElementById("smtp-user");
        const smtpPassInput = document.getElementById("smtp-pass");
        const smtpFromInput = document.getElementById("smtp-from");
        const btnSaveSmtp = document.getElementById("btn-save-smtp");
        const smtpMsg = document.getElementById("smtp-msg");

        async function loadSmtpSettings() {
            try {
                const resp = await callCG({ action: "getSettings" });
                if (resp.success && resp.settings) {
                    const s = resp.settings;
                    resendApiKeyInput.value = s.resendApiKey || "";
                    resendFromEmailInput.value = s.resendFromEmail || "";
                    smtpHostInput.value = s.smtpHost || "";
                    smtpPortInput.value = s.smtpPort || "";
                    smtpUserInput.value = s.smtpUser || "";
                    smtpPassInput.value = s.smtpPass || "";
                    smtpFromInput.value = s.smtpFrom || "";
                }
            } catch (e) {
                console.error("Error loading settings", e);
            }
        }

        btnSaveSmtp.addEventListener("click", async () => {
            btnSaveSmtp.disabled = true;
            smtpMsg.textContent = "Saving...";
            try {
                const resp = await callCG({ 
                    action: "saveSettings", 
                    resendApiKey: resendApiKeyInput.value.trim(),
                    resendFromEmail: resendFromEmailInput.value.trim(),
                    smtpHost: smtpHostInput.value.trim(), 
                    smtpPort: smtpPortInput.value.trim(), 
                    smtpUser: smtpUserInput.value.trim(), 
                    smtpPass: smtpPassInput.value.trim(), 
                    smtpFrom: smtpFromInput.value.trim() 
                });
                if (resp.success) smtpMsg.innerHTML = '<span class="text-success"> Settings saved.</span>';
                else smtpMsg.innerHTML = '<span class="text-danger"> Error saving settings.</span>';
            } catch (e) {
                console.error(e);
                smtpMsg.innerHTML = '<span class="text-danger"> Network error.</span>';
            } finally {
                btnSaveSmtp.disabled = false;
            }
        });

        // Initialize preview
        updateContractPreview();
    </script>
</body>

</html>