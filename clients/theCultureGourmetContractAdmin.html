<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>View Contract - Culture Gourmet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f1f5f9;
            color: #0f172a;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #ffffff;
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .btn-back {
            padding: 8px 16px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-back:hover {
            background: #d1d5db;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .contract-panel,
        .timeline-panel {
            background: #ffffff;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #111827;
        }

        .contract-text {
            white-space: pre-wrap;
            font-family: "Georgia", serif;
            line-height: 1.7;
            font-size: 15px;
            color: #374151;
            background: #fafafa;
            padding: 24px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }

        .timeline-item {
            border-left: 3px solid #16a34a;
            padding-left: 16px;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 5px;
            width: 11px;
            height: 11px;
            background: #16a34a;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .timeline-time {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .timeline-status {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
            margin-bottom: 2px;
        }

        .timeline-note {
            font-size: 13px;
            color: #6b7280;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .status-send {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-under-review {
            background: #fef3c7;
            color: #92400e;
        }

        .status-reviewed {
            background: #dbeaff;
            color: #1e40af;
        }

        .status-signed {
            background: #dcfce7;
            color: #166534;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-edit:hover {
            background: #e5e7eb;
        }
        
        .btn-resend {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .btn-resend:hover {
            background: #bfdbfe;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: #b91c1c;
        }
        
        .btn-delete:hover {
            background: #fecaca;
        }
        
        .btn-open {
            background: #d1fae5;
            color: #065f46;
        }
        
        .btn-open:hover {
            background: #a7f3d0;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Contract Details</h1>
            <button class="btn-back" onclick="window.location.href='/theCultureGourmetContract.html#contracts-section'">‚Üê Back to
                Contracts</button>
        </div>

        <div id="loading" style="text-align:center;padding:3rem;background:#fff;border-radius:16px;">Loading contract...
        </div>

        <div id="content" class="main-grid" style="display:none;">
            <div class="contract-panel">
                <div class="panel-title">Contract Document</div>
                <div id="status-badge" class="status-badge"></div>
                <div class="contract-text" id="contract-text"></div>
                <div class="action-buttons" id="action-buttons">
                    <button class="action-btn btn-edit" onclick="handleEdit()">Edit</button>
                    <button class="action-btn btn-resend" onclick="handleResend()">Resend</button>
                    <button class="action-btn btn-delete" onclick="handleDelete()">Delete</button>
                    <button class="action-btn btn-open" onclick="window.open(contractData?.viewLink || '#', '_blank')">Open</button>
                </div>
            </div>

            <div class="timeline-panel">
                <div class="panel-title">Timeline</div>
                <div id="timeline-container"></div>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const contractId = params.get("contractId");
        const API_URL = "/webhook/theCultureGourmetContract";

        let contractData = null;
        
        function updateStatusBadge(status) {
            const badge = document.getElementById('status-badge');
            if (!badge) return;
            
            badge.className = 'status-badge';
            badge.textContent = status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            
            // Remove all status classes
            ['send', 'under-review', 'reviewed', 'signed'].forEach(cls => {
                badge.classList.remove(`status-${cls}`);
            });
            
            // Add the current status class
            badge.classList.add(`status-${status.toLowerCase()}`);
        }
        
        function renderTimeline(history = []) {
            const container = document.getElementById('timeline-container');
            if (!container) {
                console.error("Timeline container not found");
                return;
            }

            try {
                if (!Array.isArray(history)) {
                    console.warn("History is not an array:", history);
                    history = [];
                }

                // Sort by timestamp, newest first
                const sortedHistory = [...history].sort((a, b) => {
                    const timeA = (a.timestamp || a.at) ? new Date(a.timestamp || a.at).getTime() : 0;
                    const timeB = (b.timestamp || b.at) ? new Date(b.timestamp || b.at).getTime() : 0;
                    return timeB - timeA; // Newest first
                });

                if (sortedHistory.length === 0) {
                    container.innerHTML = '<div class="timeline-item"><div class="timeline-note">No activity yet</div></div>';
                    return;
                }

                container.innerHTML = sortedHistory.map(item => {
                    if (!item) return '';
                    
                    const time = item.timestamp || item.at;
                    const status = (item.status || item.type || 'event').toString();
                    const note = (item.note || '').toString();
                    
                    return `
                        <div class="timeline-item">
                            ${time ? `<div class="timeline-time">${formatTime(time)}</div>` : ''}
                            <div class="timeline-status">${status.split('-').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                            ).join(' ')}</div>
                            ${note ? `<div class="timeline-note">${note}</div>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Error rendering timeline:", error);
                container.innerHTML = `
                    <div class="timeline-item">
                        <div class="timeline-status">Error</div>
                        <div class="timeline-note">Could not load timeline. ${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function handleEdit() {
            if (!contractData) return;
            window.location.href = `theCultureGourmetContract.html?edit=${contractData.id}`;
        }
        
        async function handleResend() {
            if (!contractData) return;
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        action: "updateContractStatus",
                        contractId: contractData.id,
                        status: "send",
                        note: "Contract resent to client"
                    })
                });
                
                if (res.ok) {
                    showToast('Contract resent successfully', 'success');
                    await loadContract();
                } else {
                    throw new Error('Failed to resend contract');
                }
            } catch (error) {
                console.error('Error resending contract:', error);
                showToast('Failed to resend contract', 'error');
            }
        }
        
        async function handleDelete() {
            if (!contractData || !confirm('Are you sure you want to delete this contract? This action cannot be undone.')) {
                return;
            }
            
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        action: "deleteContract",
                        contractId: contractData.id
                    })
                });
                
                if (res.ok) {
                    showToast('Contract deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.href = 'theCultureGourmetContract.html';
                    }, 1500);
                } else {
                    throw new Error('Failed to delete contract');
                }
            } catch (error) {
                console.error('Error deleting contract:', error);
                showToast('Failed to delete contract', 'error');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }, 100);
        }
        
        async function loadContract() {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('content');
            
            if (!contractId) {
                loadingEl.textContent = "Error: No contract ID provided.";
                return;
            }

            try {
                console.log("Loading contract with ID:", contractId);
                loadingEl.textContent = "Loading contract data...";
                
                // Show loading state
                contentEl.style.display = "none";
                loadingEl.style.display = "block";

                // Make sure we're not loading from cache
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                        "Cache-Control": "no-cache",
                        "Pragma": "no-cache"
                    },
                    body: JSON.stringify({ 
                        action: "listContracts",
                        timestamp: Date.now() // Add timestamp to prevent caching
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("API Response:", result);

                // Find the specific contract
                let contract;
                if (result.contracts && Array.isArray(result.contracts)) {
                    contract = result.contracts.find(c => c.id === contractId);
                } else if (result.result && result.result.contracts && Array.isArray(result.result.contracts)) {
                    contract = result.result.contracts.find(c => c.id === contractId);
                }

                if (!contract) {
                    // If contract not found, show available contracts for debugging
                    const allContracts = result.contracts || result.result?.contracts || [];
                    console.error("Available contracts:", allContracts);
                    throw new Error(`Contract with ID '${contractId}' not found. Available IDs: ${allContracts.map(c => c.id).join(', ')}`);
                }

                console.log("Found contract:", contract);

                // Update UI with contract data
                document.getElementById('contract-text').textContent = 
                    contract.contractText || contract.text || "No contract text available.";

                // Update status badge
                updateStatusBadge(contract.status || 'draft');

                // Update timeline
                const timeline = contract.timeline || contract.history || [];
                console.log("Timeline data:", timeline);
                renderTimeline(timeline);

                // Show content
                loadingEl.style.display = "none";
                contentEl.style.display = "grid";

            } catch (error) {
                console.error("Error loading contract:", error);
                loadingEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #b91c1c;">
                        <p>Error loading contract: ${error.message || 'Unknown error'}</p>
                        <p>Contract ID: ${contractId}</p>
                        <p>API URL: ${API_URL}</p>
                        <button onclick="window.location.reload()" 
                                style="margin-top: 10px; padding: 8px 16px; 
                                       background: #e5e7eb; border: none; 
                                       border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                        <button onclick="window.location.href='theCultureGourmetContract.html'" 
                                style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; 
                                       background: #dbeafe; border: none; 
                                       border-radius: 6px; cursor: pointer;">
                            Back to Contracts
                        </button>
                    </div>
                `;
                loadingEl.style.display = "block";
                contentEl.style.display = "none";
            }
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Ensure the page loads properly
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, contractId:", contractId);
            if (contractId) {
                loadContract();
            }
        });

        // Also call loadContract immediately in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // Still loading, wait for DOMContentLoaded
        } else {
            // Already loaded, call immediately
            console.log("Document already loaded, contractId:", contractId);
            if (contractId) {
                loadContract();
            }
        }
    </script>
</body>

</html>