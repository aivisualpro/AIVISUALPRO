<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devco | Estimate Details v1.1.0</title>
    <script>
        (function () {
            // Check if current page is login.html to avoid loop (though this is view.html)
            if (!localStorage.getItem('devco_session_valid')) {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
            }
        })();
    </script>
    <link rel="icon" type="image/png" href="devco-logo.png">
    <meta name="description" content="View and edit estimate details">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Lato', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="font-sans bg-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel" src="components.js"></script>

    <script type="text/babel">
        const { Header, Badge, Loading, EmptyState, Button, Modal, Input, SearchableSelect } = window.DevcoComponents;

        // Initialize Lucide Icons
        React.useEffect && lucide.createIcons();

        const DevcoIcon = ({ name, size = 16, className = '' }) => {
            const iconRef = React.useRef(null);

            React.useEffect(() => {
                if (iconRef.current) {
                    // Convert kebab-case to PascalCase
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconNode = lucide.icons[pascalName];

                    if (iconNode) {
                        const svg = lucide.createElement(iconNode);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        svg.setAttribute('stroke-width', 2);
                        if (className) svg.setAttribute('class', className);

                        iconRef.current.innerHTML = '';
                        iconRef.current.appendChild(svg);
                    } else {
                        console.warn(`Icon ${name} (${pascalName}) not found`);
                    }
                }
            }, [name, size, className]);

            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };



        const AddItemModal = ({ section, isOpen, onClose, onSave, items = [], catalog = [], fringe, fringeConstants }) => {
            const { Modal, Input, SearchableSelect, Button, EmptyState, Badge, ItemForm } = window.DevcoComponents;
            const [mode, setMode] = React.useState('manual');
            const [formData, setFormData] = React.useState({});
            const [selectedItems, setSelectedItems] = React.useState(new Set());
            const [searchTerm, setSearchTerm] = React.useState('');
            const [saving, setSaving] = React.useState(false);

            React.useEffect(() => {
                if (isOpen) {
                    setFormData({});
                    setSelectedItems(new Set()); // Start clean, do not pre-select existing
                    setSearchTerm('');
                    setMode('catalog'); // Always default to catalog view for consistency
                }
            }, [isOpen, catalog]);

            // Helper to get unique identifier for an item
            const getIdentifier = (i) => {
                const sId = section?.id;
                const normalize = (val) => String(val || '').toLowerCase().trim();

                if (sId === 'Labor') {
                    // Match by classification + subClassification + fringe
                    const basePay = typeof i.basePay === 'number' ? i.basePay : parseFloat(String(i.basePay || 0).replace(/[^0-9.-]+/g, ""));
                    return `labor|${normalize(i.classification)}|${normalize(i.subClassification)}|${normalize(i.fringe)}|${basePay}`;
                }
                if (sId === 'Equipment') {
                    return `equip|${normalize(i.equipmentMachine)}|${normalize(i.classification)}`;
                }
                if (sId === 'Material') {
                    return `mat|${normalize(i.material)}|${normalize(i.classification)}`;
                }
                if (sId === 'Tools') {
                    return `tool|${normalize(i.tool)}|${normalize(i.classification)}`;
                }
                if (sId === 'Overhead') {
                    return `over|${normalize(i.overhead)}|${normalize(i.classification)}`;
                }
                if (sId === 'Disposal') {
                    return `disp|${normalize(i.disposalAndHaulOff)}|${normalize(i.classification)}`;
                }
                if (sId === 'Miscellaneous') {
                    return `misc|${normalize(i.item)}|${normalize(i.classification)}`;
                }
                if (sId === 'Subcontractor') {
                    return `sub|${normalize(i.subcontractor)}|${normalize(i.classification)}`;
                }

                return normalize(i.classification || i.item || i.name || i.description);
            };

            const existingIdentifiers = React.useMemo(() => {
                return new Set(items.map(getIdentifier));
            }, [items, section]);

            // Catalog Logic (Moved up before conditional return)
            const filteredCatalog = React.useMemo(() => {
                let filtered = (catalog || []).filter(item => {
                    const searchStr = searchTerm.toLowerCase();
                    const text = Object.values(item).filter(v => typeof v === 'string' || typeof v === 'number').join(' ').toLowerCase();
                    return text.includes(searchStr);
                });

                // Deduplicate based on strict identifier
                const uniqueContent = new Set();
                filtered = filtered.filter(item => {
                    const key = getIdentifier(item);
                    if (uniqueContent.has(key)) return false;
                    uniqueContent.add(key);
                    return true;
                });

                // Prioritize items matching the Estimate Fringe
                if (section?.id === 'Labor' && fringe) {
                    filtered.sort((a, b) => {
                        const aMatch = String(a.fringe || '').trim().toLowerCase() === String(fringe).trim().toLowerCase();
                        const bMatch = String(b.fringe || '').trim().toLowerCase() === String(fringe).trim().toLowerCase();
                        if (aMatch && !bMatch) return -1;
                        if (!aMatch && bMatch) return 1;
                        return 0;
                    });
                }
                return filtered;
            }, [catalog, searchTerm, section?.id, fringe, section]);

            if (!isOpen || !section) return null;

            // Manual Logic
            const dropdownFields = ['classification', 'subClassification', 'supplier', 'fringe', 'uom', 'item'];
            const getOptions = (field) => {
                // Combine options from existing items AND catalog
                const allItems = [...items, ...(catalog || [])];
                return allItems.map(item => item[field]).filter(Boolean).filter((v, i, arr) => arr.indexOf(v) === i).sort();
            };

            const handleManualSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                await onSave(section, formData, true); // Pass true for manual entry
                setSaving(false);
                onClose();
            };

            const handleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const toggleSelection = (item) => {
                const newSet = new Set(selectedItems);
                if (newSet.has(item)) newSet.delete(item);
                else newSet.add(item);
                setSelectedItems(newSet);
            };

            const handleAddSelected = async () => {
                if (selectedItems.size === 0) return;
                setSaving(true);

                const promises = Array.from(selectedItems).map(item => {
                    // Double check if already exists (should be disabled in UI, but safe check)
                    if (existingIdentifiers.has(getIdentifier(item))) return Promise.resolve();

                    // Remove _id to avoid duplicate key error. Backend must generate new ID.
                    const { _id, ...itemData } = item;
                    return onSave(section, {
                        ...itemData,
                        quantity: 1, // Default quantity
                        days: item.days || 1,
                        hours: item.hours || 8
                    }, false); // Pass false for catalog selection
                });
                await Promise.all(promises);
                setSaving(false);
                onClose();
            };

            const fieldsToRender = section.formFields || section.fields;
            const headersToRender = section.formHeaders || section.headers;

            // Footer for Modal
            const footerContent = mode === 'catalog' ? (
                <>
                    <div className="flex-1 text-left text-sm text-gray-500">
                        {selectedItems.size} items selected
                    </div>
                    <Button onClick={() => setMode('manual')} variant="ghost">Manual Entry</Button>
                    <Button onClick={onClose} variant="secondary">Cancel</Button>
                    <Button
                        onClick={handleAddSelected}
                        disabled={selectedItems.size === 0 || saving}
                    >
                        {saving ? 'Adding...' : 'Add Selected'}
                    </Button>
                </>
            ) : (
                <>
                    <Button onClick={() => setMode('catalog')} variant="ghost" className="mr-auto">Back to Catalog</Button>
                    <Button onClick={onClose} variant="secondary">Cancel</Button>
                    <Button onClick={handleManualSubmit} disabled={saving} className={section.id === 'Overhead' ? "!bg-[#10B981] !hover:bg-[#059669] text-white px-6 py-2.5 h-10 shadow-md font-bold" : ""}>
                        {saving ? 'Saving...' : (section.id === 'Overhead' ? 'Save the cost' : 'Save Item')}
                    </Button>
                </>
            );

            // Catalog Table Columns (Dynamic but prioritized)
            const getCatalogColumns = () => {
                if (section?.id === 'Labor') {
                    return ['classification', 'basePay', 'subClassification'];
                }
                if (section?.id === 'Miscellaneous') {
                    return ['item', 'classification', 'uom', 'cost'];
                }
                if (section?.id === 'Overhead') {
                    return ['overhead', 'classification', 'subClassification', 'hourlyRate', 'dailyRate'];
                }
                if (section?.id === 'Disposal') {
                    return ['disposalAndHaulOff', 'classification', 'subClassification', 'uom', 'cost'];
                }
                if (section?.id === 'Equipment') {
                    return ['equipmentMachine', 'classification', 'subClassification', 'supplier', 'dailyCost', 'weeklyCost', 'monthlyCost'];
                }
                if (section?.id === 'Material') {
                    return ['material', 'classification', 'subClassification', 'supplier', 'uom', 'cost'];
                }
                if (section?.id === 'Subcontractor') {
                    return ['subcontractor', 'classification', 'subClassification', 'uom', 'cost'];
                }
                if (filteredCatalog.length === 0) return [];
                const first = filteredCatalog[0];
                // Prioritize common fields
                const priority = ['item', 'classification', 'name', 'type', 'description', 'uom', 'cost', 'rate', 'price', 'basePay'];
                const keys = Object.keys(first).filter(k => !['_id', 'createdAt', 'updatedAt', '__v'].includes(k));
                return keys.sort((a, b) => {
                    const idxA = priority.indexOf(a);
                    const idxB = priority.indexOf(b);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    return a.localeCompare(b);
                }).slice(0, 4); // Limit columns
            };
            const displayCols = getCatalogColumns();

            return (
                <Modal
                    isOpen={isOpen}
                    onClose={onClose}
                    title={mode === 'manual' && section.id === 'Overhead' ? 'Add a overhead manually' : `Add ${section.title}`}
                    footer={mode === 'catalog' ? footerContent : undefined} // ItemForm has its own footer
                >
                    {mode === 'catalog' ? (
                        <div className="space-y-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    placeholder="Search catalog..."
                                    className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                                />
                                <svg className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>
                            </div>

                            <div className="max-h-[50vh] overflow-y-auto border border-gray-100 rounded-xl">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10">
                                        <tr>
                                            <th className="p-3 w-10">
                                                <input type="checkbox" className="rounded border-gray-300"
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            // Select ONLY items that are not already added
                                                            const selectable = filteredCatalog.filter(i => !existingIdentifiers.has(getIdentifier(i)));
                                                            setSelectedItems(new Set(selectable));
                                                        }
                                                        else setSelectedItems(new Set());
                                                    }}
                                                    checked={filteredCatalog.length > 0 && selectedItems.size > 0 && selectedItems.size === filteredCatalog.filter(i => !existingIdentifiers.has(getIdentifier(i))).length}
                                                />
                                            </th>
                                            {displayCols.map(col => {
                                                let label = col.replace(/([A-Z])/g, ' $1').trim();
                                                if (section.id === 'Labor' && col === 'classification') label = 'Item';
                                                if (section.id === 'Equipment' && col === 'equipmentMachine') label = 'Equipment';
                                                if (section.id === 'Equipment' && col === 'equipmentMachine') label = 'Equipment';
                                                if (section.id === 'Disposal' && col === 'disposalAndHaulOff') label = 'Disposal';
                                                if (section.id === 'Subcontractor' && col === 'subcontractor') label = 'Subcontractor';
                                                return <th key={col} className="p-3 capitalize">{label}</th>;
                                            })}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredCatalog.map((item, idx) => {
                                            const isSuggested = section?.id === 'Labor' && fringe && String(item.fringe || '').trim().toLowerCase() === String(fringe).trim().toLowerCase();
                                            const isAdded = existingIdentifiers.has(getIdentifier(item));

                                            return (
                                                <tr
                                                    key={item._id || idx}
                                                    className={`cursor-pointer transition-colors ${isAdded ? 'bg-gray-100 opacity-60 cursor-not-allowed' :
                                                        selectedItems.has(item) ? 'bg-indigo-100' :
                                                            (isSuggested ? 'bg-blue-50' : 'hover:bg-gray-50')
                                                        }`}
                                                    onClick={() => !isAdded && toggleSelection(item)}
                                                >
                                                    <td className="p-3">
                                                        <input type="checkbox" checked={selectedItems.has(item) || isAdded} disabled={isAdded} onChange={() => { }} className="rounded border-gray-300 pointer-events-none" />
                                                    </td>
                                                    {displayCols.map((col, cIdx) => (
                                                        <td key={col} className="p-3 text-gray-700">
                                                            {(() => {
                                                                if (section.id === 'Labor' && col === 'classification') {
                                                                    return (
                                                                        <span className="font-medium text-slate-700">
                                                                            {item.classification}{item.fringe ? <span className="text-slate-400 font-normal"> - {item.fringe}</span> : ''}
                                                                        </span>
                                                                    );
                                                                }
                                                                if (typeof item[col] === 'number' && ['cost', 'rate', 'price', 'basePay', 'dailyCost', 'weeklyCost', 'monthlyCost'].some(k => col.toLowerCase().includes(k))) {
                                                                    return `$${item[col].toLocaleString()}`;
                                                                }
                                                                return item[col];
                                                            })()}
                                                            {isSuggested && cIdx === 0 && (
                                                                <span className="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-blue-100 text-blue-700 border border-blue-200">
                                                                    Suggested
                                                                </span>
                                                            )}
                                                        </td>
                                                    ))}
                                                </tr>
                                            );
                                        })}
                                        {filteredCatalog.length === 0 && (
                                            <tr><td colSpan={displayCols.length + 1} className="p-8 text-center text-gray-400">No items found</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : (
                        <div className="px-0 py-2">
                            <ItemForm
                                fields={fieldsToRender.filter(f => f !== 'labor' && f !== 'total')}
                                headers={headersToRender.filter((h, i) => fieldsToRender[i] !== 'labor' && fieldsToRender[i] !== 'total')}
                                formData={formData}
                                onChange={handleChange}
                                onSubmit={() => handleManualSubmit({ preventDefault: () => { } })}
                                onCancel={onClose}
                                submitLabel={section.id === 'Overhead' ? 'Save the cost' : 'Save Item'}
                                cancelLabel="Cancel"
                                category={section.id}
                                dropdownFields={dropdownFields}
                                fieldTypes={{}} // We can infer or pass specific types if needed, ItemForm handles basics
                                fringeConstants={fringeConstants} // Pass fringeConstants if available in scope
                                isSaving={saving}
                                submitButtonClass={section.id === 'Overhead' ? "!bg-[#10B981] !hover:bg-[#059669] text-white px-6 py-2.5 h-10 shadow-md font-bold" : ""}
                            />
                        </div>
                    )}
                </Modal>
            );
        };

        const AccordionItem = ({ title, isOpen, onToggle, items = [], onAdd, color = 'blue', grandTotal = 0, children }) => {
            const count = items.length;

            // Updated total calc logic
            const total = items.reduce((sum, item) => {
                let val = 0;
                if (item.total !== undefined && item.total !== null) {
                    val = item.total;
                } else if (item.cost) {
                    val = item.cost * (item.quantity || 0); // Default to 0 if no quantity
                } else if (item.basePay) {
                    val = item.basePay * (item.quantity || 0) * (item.days || 0); // Default to 0
                }
                return sum + (parseFloat(val) || 0);
            }, 0);

            const formatMoney = (n) =>
                new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);

            const percentage = grandTotal > 0 ? (total / grandTotal) * 100 : 0;

            return (
                <div className="mb-6">
                    <div
                        className="cursor-pointer group select-none"
                        onClick={onToggle}
                    >
                        <div className="flex items-center justify-between pb-2">
                            <div className="flex items-center gap-3">
                                <div className={`transition-transform duration-300 text-gray-400 group-hover:text-gray-600 ${isOpen ? 'rotate-180' : ''}`}>
                                    <DevcoIcon name="chevron-down" size={24} />
                                </div>
                                <h3 className="text-xl font-bold text-gray-900 tracking-tight flex items-center gap-2">
                                    {title}
                                    {count > 0 && (
                                        <span className="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full font-bold">
                                            {count}
                                        </span>
                                    )}
                                </h3>
                            </div>

                            <div className="flex items-center gap-4">
                                <button
                                    className="flex items-center justify-start gap-2 w-48 px-4 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 rounded-xl shadow-sm transition-all"
                                    onClick={(e) => { e.stopPropagation(); onAdd(); }}
                                >
                                    <DevcoIcon name="plus" size={16} />
                                    Add {title}
                                </button>
                                <span className="text-xl font-bold text-gray-900 w-32 text-right">{formatMoney(total)}</span>
                            </div>
                        </div>

                        {/* Progress Bar */}
                        <div className="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                            <div
                                className="h-full rounded-full transition-all duration-1000 ease-out"
                                style={{ width: `${percentage}%`, opacity: percentage > 0 ? 1 : 0, backgroundColor: color }}
                            ></div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className={`grid transition-all duration-300 ease-in-out ${isOpen ? 'grid-rows-[1fr] mt-4 opacity-100' : 'grid-rows-[0fr] opacity-0'}`}>
                        <div className="overflow-hidden bg-white rounded-xl border border-gray-100 shadow-sm">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const CalculationExplanationModal = ({ item, breakdown, isOpen, onClose }) => {
            if (!isOpen || !item || !breakdown) return null;

            const formatMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
            const formatNum = (n) => new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(n);

            return (
                <Modal
                    isOpen={isOpen}
                    onClose={onClose}
                    title={`${item.classification || 'Item'} - ${item.subClassification || 'Sub Classification'} Cost Calculation`}
                    footer={
                        <button
                            onClick={onClose}
                            className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition-colors text-sm"
                        >
                            Close
                        </button>
                    }
                >
                    <div className="space-y-6">

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* 1. Base Rate */}
                            <section>
                                <h4 className="text-sm font-bold text-gray-900 border-b border-gray-100 pb-2 mb-3 flex items-center gap-2">
                                    <span className="bg-gray-100 text-gray-600 w-5 h-5 rounded-full flex items-center justify-center text-[10px]">1</span>
                                    Base Rate
                                </h4>
                                <div className="space-y-2 bg-gray-50/50 p-3 rounded-lg">
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">Base Pay</span>
                                        <span className="font-mono font-bold text-slate-900">{formatMoney(breakdown.basePay)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">W.Comp ({breakdown.wCompPct}%)</span>
                                        <span className="font-mono text-slate-600">{formatMoney(breakdown.wCompTaxAmount)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">Payroll Tax ({breakdown.payrollPct}%)</span>
                                        <span className="font-mono text-slate-600">{formatMoney(breakdown.payrollTaxAmount)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">Fringes</span>
                                        <span className="font-mono text-slate-600">{formatMoney(breakdown.fringe)}</span>
                                    </div>
                                    <div className="flex justify-between text-sm font-bold pt-2 mt-1 border-t border-gray-200">
                                        <span className="text-gray-900">Base Rate</span>
                                        <span className="font-mono text-blue-600">{formatMoney(breakdown.totalBaseRate)}</span>
                                    </div>
                                </div>
                            </section>

                            {/* 2. OT Rate */}
                            <section>
                                <h4 className="text-sm font-bold text-gray-900 border-b border-gray-100 pb-2 mb-3 flex items-center gap-2">
                                    <span className="bg-gray-100 text-gray-600 w-5 h-5 rounded-full flex items-center justify-center text-[10px]">2</span>
                                    OT Rate
                                </h4>
                                <div className="space-y-2 bg-gray-50/50 p-3 rounded-lg">
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">OT Pay (×1.5)</span>
                                        <span className="font-mono font-bold text-slate-900">{formatMoney(breakdown.basePay * 1.5)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">W.Comp (Fixed)</span>
                                        <span className="font-mono text-slate-600">{formatMoney(breakdown.wCompTaxAmount)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">OT Payroll Tax</span>
                                        <span className="font-mono text-slate-600">{formatMoney(breakdown.otPayrollTaxAmount)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs group">
                                        <span className="text-gray-600">Fringes</span>
                                        <span className="font-mono text-slate-600">{formatMoney(breakdown.fringe)}</span>
                                    </div>
                                    <div className="flex justify-between text-sm font-bold pt-2 mt-1 border-t border-gray-200">
                                        <span className="text-gray-900">OT Rate</span>
                                        <span className="font-mono text-blue-600">{formatMoney(breakdown.totalOtRate)}</span>
                                    </div>
                                </div>
                            </section>

                            {/* 3. Hours */}
                            <section>
                                <h4 className="text-sm font-bold text-gray-900 border-b border-gray-100 pb-2 mb-3 flex items-center gap-2">
                                    <span className="bg-gray-100 text-gray-600 w-5 h-5 rounded-full flex items-center justify-center text-[10px]">3</span>
                                    Hours
                                </h4>
                                <div className="space-y-3 bg-gray-50/50 p-3 rounded-lg">
                                    <div className="flex justify-between text-xs">
                                        <span className="text-gray-600">Total Hours</span>
                                        <span className="font-mono font-bold text-slate-900">{formatNum(breakdown.totalHours)}</span>
                                    </div>
                                    <div className="text-[10px] text-gray-400 pl-2 font-mono">
                                        = {breakdown.quantity} (qty) × {breakdown.days} (days) × 8
                                    </div>
                                    <div className="flex justify-between text-xs mt-2 border-t border-gray-100 pt-2">
                                        <span className="text-gray-600">Total OT Hours</span>
                                        <span className="font-mono font-bold text-slate-900">{formatNum(breakdown.totalOtHours)}</span>
                                    </div>
                                    <div className="text-[10px] text-gray-400 pl-2 font-mono">
                                        = {breakdown.quantity} (qty) × {breakdown.days} (days) × {breakdown.otPd} (ot/day)
                                    </div>
                                </div>
                            </section>

                            {/* 4. Total Calculation */}
                            <div className="md:col-span-1">
                                <div className="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-5 text-white shadow-lg h-full flex flex-col justify-center">
                                    <div className="space-y-2 font-mono text-xs text-blue-100 mb-6">
                                        <div>
                                            <span className="opacity-75">({formatNum(breakdown.totalHours)} hrs × {formatMoney(breakdown.totalBaseRate)}) +</span>
                                        </div>
                                        <div>
                                            <span className="opacity-75">({formatNum(breakdown.totalOtHours)} hrs × {formatMoney(breakdown.totalOtRate)})</span>
                                        </div>
                                    </div>

                                    <div className="flex items-end justify-between border-t border-blue-400/30 pt-4">
                                        <span className="text-blue-100 text-xs font-bold tracking-widest uppercase mb-1">Total Cost</span>
                                        <span className="text-3xl font-black tracking-tight">{formatMoney(breakdown.grandTotal)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </Modal >
            );
        };

        const LineItemsTable = ({ headers, items, fields, editableFields = [], onUpdateItem, onExplain, onDelete, sectionId, suppliers = [], uoms = [], miscClassifications = [], miscUoms = [], overheadClassifications = [], overheadSubClassifications = [], disposalClassifications = [], disposalUoms = [], subClassifications = [], subSubClassifications = [], subContractors = [], subUoms = [] }) => {
            // Safe Icon resolution


            if (!items || items.length === 0) {
                return (
                    <div className="p-8 text-center text-gray-400 text-sm italic">
                        No line items found for this category.
                    </div>
                );
            }

            return (
                <div className="overflow-x-auto">
                    {sectionId === 'Equipment' && (
                        <datalist id="equipment-suppliers">
                            {suppliers.map(s => <option key={s} value={s} />)}
                        </datalist>
                    )}
                    {sectionId === 'Material' && (
                        <>
                            <datalist id="material-suppliers">
                                {suppliers.map(s => <option key={s} value={s} />)}
                            </datalist>
                            <datalist id="material-uoms">
                                {uoms.map(u => <option key={u} value={u} />)}
                            </datalist>
                        </>
                    )}
                    {sectionId === 'Miscellaneous' && (
                        <>
                            <datalist id="misc-classifications">
                                {miscClassifications.map(c => <option key={c} value={c} />)}
                            </datalist>
                            <datalist id="misc-uoms">
                                {miscUoms.map(u => <option key={u} value={u} />)}
                            </datalist>
                        </>
                    )}
                    {sectionId === 'Overhead' && (
                        <>
                            <datalist id="overhead-classifications">
                                {overheadClassifications.map(c => <option key={c} value={c} />)}
                            </datalist>
                            <datalist id="overhead-subclassifications">
                                {overheadSubClassifications.map(c => <option key={c} value={c} />)}
                            </datalist>
                        </>
                    )}
                    {sectionId === 'Disposal' && (
                        <>
                            <datalist id="disposal-classifications">
                                {disposalClassifications.map(c => <option key={c} value={c} />)}
                            </datalist>
                            <datalist id="disposal-uoms">
                                {disposalUoms.map(u => <option key={u} value={u} />)}
                            </datalist>
                        </>
                    )}
                    {sectionId === 'Subcontractor' && (
                        <>
                            <datalist id="sub-classifications">
                                {subClassifications.map(c => <option key={c} value={c} />)}
                            </datalist>
                            <datalist id="sub-subclassifications">
                                {subSubClassifications.map(c => <option key={c} value={c} />)}
                            </datalist>
                            <datalist id="sub-contractors">
                                {subContractors.map(c => <option key={c} value={c} />)}
                            </datalist>
                            <datalist id="sub-uoms">
                                {subUoms.map(c => <option key={c} value={c} />)}
                            </datalist>
                        </>
                    )}
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-gray-50 border-b border-gray-100">
                                <th className="px-2 py-2 text-[10px] font-semibold text-gray-500 uppercase tracking-wider w-8 text-center">#</th>
                                {headers.map((header, i) => (
                                    <th key={i} className="px-2 py-2 text-[10px] font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                        {header}
                                    </th>
                                ))}
                                <th className="px-2 py-2 text-[10px] font-semibold text-gray-500 uppercase tracking-wider w-10 text-center"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {items.map((item, i) => {
                                // Create a key that changes when item values change (forces input re-render)
                                const itemKey = `${item._id || i}-${item.updatedAt || ''}-${item.quantity || 0}-${item.cost || 0}`;
                                return (
                                    <tr key={itemKey} className="hover:bg-gray-50/50 transition-colors group">
                                        <td className="px-2 py-2 text-[11px] text-gray-400 text-center font-medium">
                                            {i + 1}
                                        </td>
                                        {fields.map((field, j) => {
                                            const isEditable = editableFields.includes(field);
                                            const val = item[field];
                                            let displayVal = val || (val === 0 ? 0 : '--');

                                            if (typeof val === 'number') {
                                                const lowerField = field.toLowerCase();
                                                if (lowerField.includes('percent')) {
                                                    displayVal = `${val}%`;
                                                } else if (lowerField.includes('cost') || lowerField.includes('pay') || lowerField.includes('rate') || lowerField === 'total') {
                                                    displayVal = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
                                                }
                                            }

                                            // Clickable Total Logic
                                            if (field === 'total' && onExplain) {
                                                return (
                                                    <td key={j} className="px-2 py-2 text-[11px] whitespace-nowrap">
                                                        <div
                                                            onClick={(e) => { e.stopPropagation(); onExplain(item); }}
                                                            className="font-bold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer flex items-center gap-1"
                                                            title="View Calculation Breakdown"
                                                        >
                                                            {displayVal}
                                                            <DevcoIcon name="info" size={10} className="opacity-50" />
                                                        </div>
                                                    </td>
                                                );
                                            }

                                            return (
                                                <td key={j} className="px-2 py-2 text-[11px] text-gray-700 whitespace-nowrap">
                                                    {isEditable ? (
                                                        field === 'uom' && sectionId === 'Equipment' ? (
                                                            <select
                                                                value={val || 'Daily'}
                                                                onChange={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-16 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                            >
                                                                <option value="Daily">Daily</option>
                                                                <option value="Weekly">Weekly</option>
                                                                <option value="Monthly">Monthly</option>
                                                            </select>
                                                        ) : field === 'uom' && sectionId === 'Material' ? (
                                                            <input
                                                                type="text"
                                                                list="material-uoms"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-16 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="UOM"
                                                            />
                                                        ) : field === 'supplier' && sectionId === 'Equipment' ? (
                                                            <input
                                                                type="text"
                                                                list="equipment-suppliers"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-24 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="Select..."
                                                            />
                                                        ) : field === 'supplier' && sectionId === 'Material' ? (
                                                            <input
                                                                type="text"
                                                                list="material-suppliers"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-24 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="Select..."
                                                            />
                                                        ) : (field === 'classification' || field === 'subClassification') && sectionId === 'Material' ? (
                                                            <input
                                                                type="text"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-28 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder={field === 'classification' ? 'Class' : 'Sub Class'}
                                                            />
                                                        ) : field === 'classification' && sectionId === 'Miscellaneous' ? (
                                                            <input
                                                                type="text"
                                                                list="misc-classifications"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-28 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="Classification"
                                                            />
                                                        ) : field === 'uom' && sectionId === 'Miscellaneous' ? (
                                                            <input
                                                                type="text"
                                                                list="misc-uoms"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-16 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="UOM"
                                                            />
                                                        ) : field === 'classification' && sectionId === 'Overhead' ? (
                                                            <input
                                                                type="text"
                                                                list="overhead-classifications"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-full min-w-[120px] bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder="Classification"
                                                            />
                                                        ) : field === 'subClassification' && sectionId === 'Overhead' ? (
                                                            <input
                                                                type="text"
                                                                list="overhead-subclassifications"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-full min-w-[120px] bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder="Sub Classification"
                                                            />
                                                        ) : field === 'classification' && sectionId === 'Disposal' ? (
                                                            <input
                                                                type="text"
                                                                list="disposal-classifications"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-full min-w-[120px] bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder="Classification"
                                                            />
                                                        ) : field === 'uom' && sectionId === 'Disposal' ? (
                                                            <input
                                                                type="text"
                                                                list="disposal-uoms"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-16 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="UOM"
                                                            />
                                                        ) : field === 'uom' && sectionId === 'Disposal' ? (
                                                            <input
                                                                type="text"
                                                                list="disposal-uoms"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-16 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="UOM"
                                                            />
                                                        ) : field === 'classification' && sectionId === 'Subcontractor' ? (
                                                            <input
                                                                type="text"
                                                                list="sub-classifications"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-full min-w-[120px] bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder="Classification"
                                                            />
                                                        ) : field === 'subClassification' && sectionId === 'Subcontractor' ? (
                                                            <input
                                                                type="text"
                                                                list="sub-subclassifications"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-full min-w-[120px] bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder="Sub Class"
                                                            />
                                                        ) : field === 'subcontractor' && sectionId === 'Subcontractor' ? (
                                                            <input
                                                                type="text"
                                                                list="sub-contractors"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-full min-w-[120px] bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                                                                placeholder="Contractor"
                                                            />
                                                        ) : field === 'uom' && sectionId === 'Subcontractor' ? (
                                                            <input
                                                                type="text"
                                                                list="sub-uoms"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className="w-16 bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center"
                                                                placeholder="UOM"
                                                            />
                                                        ) : (
                                                            <input
                                                                type="text"
                                                                defaultValue={val}
                                                                onBlur={(e) => onUpdateItem && onUpdateItem(item, field, e.target.value)}
                                                                className={`${(field === 'quantity' || field === 'times' || field === 'fuelAdditiveCost') ? 'w-12' : 'w-16'} bg-white border border-gray-200 rounded px-1.5 py-0.5 text-[11px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-center`}
                                                            />
                                                        )
                                                    ) : (
                                                        <span>{displayVal}</span>
                                                    )}
                                                </td>
                                            );
                                        })}
                                        <td className="px-2 py-2 text-center">
                                            <button
                                                onClick={(e) => { e.stopPropagation(); onDelete && onDelete(item); }}
                                                className="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-md hover:bg-red-50"
                                                title="Delete Item"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div >
            );
        };

        const PageSkeleton = () => (
            <div className="flex flex-col h-screen bg-slate-50 overflow-hidden font-sans">
                {/* Navigation Bar Skeleton */}
                <div className="h-16 bg-white border-b border-gray-200 shrink-0 flex items-center justify-between px-6">
                    <div className="flex items-center gap-8">
                        <div className="w-32 h-8 bg-slate-200 rounded-lg animate-pulse"></div>
                        <div className="flex gap-6">
                            <div className="w-20 h-4 bg-slate-200 rounded animate-pulse"></div>
                            <div className="w-20 h-4 bg-slate-200 rounded animate-pulse"></div>
                            <div className="w-20 h-4 bg-slate-200 rounded animate-pulse"></div>
                        </div>
                    </div>
                    <div className="flex items-center gap-4">
                        <div className="w-8 h-8 bg-slate-200 rounded-full animate-pulse"></div>
                        <div className="w-8 h-8 bg-slate-200 rounded-full animate-pulse"></div>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto w-full px-8 py-8">
                    {/* Header Card Skeleton - Neumorphic Style */}
                    <div className="bg-[#eef2f6] rounded-[40px] shadow-[12px_12px_24px_#d1d9e6,-12px_-12px_24px_#ffffff] p-8 mb-8 animate-pulse">
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8">
                            {/* Col 1: Customer Info */}
                            <div className="flex flex-col gap-6 p-4 rounded-2xl bg-white/30 border border-white/50 h-full">
                                <div className="space-y-2">
                                    <div className="h-3 w-20 bg-slate-300 rounded"></div>
                                    <div className="h-8 w-3/4 bg-slate-300 rounded"></div>
                                </div>
                                <div className="mt-auto">
                                    <div className="h-3 w-20 bg-slate-300 rounded mb-3"></div>
                                    <div className="flex gap-3">
                                        {[1, 2, 3, 4, 5].map(i => (
                                            <div key={i} className="w-10 h-10 rounded-full bg-slate-300"></div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Col 2: Project Details */}
                            <div className="flex flex-col gap-6 p-4 rounded-2xl bg-white/30 border border-white/50 h-full">
                                <div className="flex justify-between gap-4">
                                    <div className="w-1/2 space-y-2">
                                        <div className="h-3 w-12 bg-slate-300 rounded"></div>
                                        <div className="h-6 w-full bg-slate-300 rounded"></div>
                                    </div>
                                    <div className="w-1/2 space-y-2">
                                        <div className="h-3 w-12 bg-slate-300 rounded"></div>
                                        <div className="h-6 w-full bg-slate-300 rounded"></div>
                                    </div>
                                </div>
                                <div className="space-y-4 mt-auto">
                                    <div className="h-12 bg-slate-300 rounded-2xl"></div>
                                    <div className="h-12 bg-slate-300 rounded-2xl"></div>
                                </div>
                            </div>

                            {/* Col 3: Chart Placeholder */}
                            <div className="flex flex-col items-center justify-center p-4 rounded-2xl bg-white/30 border border-white/50 h-full min-h-[200px]">
                                <div className="w-40 h-20 rounded-t-full bg-slate-300 border-b-8 border-[#eef2f6] box-content"></div>
                                <div className="w-full mt-6 space-y-2 px-4">
                                    <div className="h-3 bg-slate-300 rounded w-full"></div>
                                    <div className="h-3 bg-slate-300 rounded w-full"></div>
                                    <div className="h-3 bg-slate-300 rounded w-2/3"></div>
                                </div>
                            </div>

                            {/* Col 4: Version History */}
                            <div className="flex flex-col gap-4 p-4 rounded-2xl bg-white/30 border border-white/50 h-full">
                                <div className="flex justify-between">
                                    <div className="h-4 w-24 bg-slate-300 rounded"></div>
                                    <div className="h-4 w-12 bg-slate-300 rounded-full"></div>
                                </div>
                                <div className="space-y-3 mt-2">
                                    {[1, 2, 3].map(i => (
                                        <div key={i} className="flex gap-3 items-center">
                                            <div className="w-2 h-2 rounded-full bg-slate-300"></div>
                                            <div className="flex-1 h-2 bg-slate-300 rounded"></div>
                                            <div className="w-12 h-2 bg-slate-300 rounded"></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Accordion Skeletons */}
                    <div className="space-y-6">
                        {['Labor', 'Equipment', 'Material', 'Tools'].map((i) => (
                            <div key={i} className="mb-6 animate-pulse">
                                <div className="flex items-center justify-between pb-2">
                                    <div className="flex items-center gap-3">
                                        <div className="w-6 h-6 bg-slate-300 rounded"></div>
                                        <div className="w-48 h-8 bg-slate-300 rounded"></div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="w-40 h-10 bg-slate-200 rounded-xl"></div>
                                        <div className="w-32 h-8 bg-slate-300 rounded"></div>
                                    </div>
                                </div>
                                <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-slate-300 w-1/4"></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        function ViewApp() {
            const { ToastContainer, ConfirmModal } = window.DevcoComponents;
            const [estimate, setEstimate] = React.useState(null);
            const [laborCatalog, setLaborCatalog] = React.useState([]);
            const [equipmentCatalog, setEquipmentCatalog] = React.useState([]);
            const [materialCatalog, setMaterialCatalog] = React.useState([]);
            const [miscellaneousCatalog, setMiscellaneousCatalog] = React.useState([]);
            const [overheadCatalog, setOverheadCatalog] = React.useState([]);
            const [disposalCatalog, setDisposalCatalog] = React.useState([]);
            const [subcontractorCatalog, setSubcontractorCatalog] = React.useState([]);
            const [fringeConstants, setFringeConstants] = React.useState([]); // Added Fringe Constants State
            const [loading, setLoading] = React.useState(true);
            const [editing, setEditing] = React.useState(true);
            const [formData, setFormData] = React.useState({});
            const skipAutoSaveRef = React.useRef(false); // Flag to skip auto-save during service toggles
            const [saving, setSaving] = React.useState(false);
            const [activeSection, setActiveSection] = React.useState(null); // State to control AddItemModal
            const [explanationItem, setExplanationItem] = React.useState(null); // State for calculation explanation
            const [breakdownData, setBreakdownData] = React.useState(null);
            const [chartAnimate, setChartAnimate] = React.useState(false);
            const [versionHistory, setVersionHistory] = React.useState([]); // Version timeline
            const [unsavedChanges, setUnsavedChanges] = React.useState(false); // Track unsaved changes

            // Local Storage Helper
            const updateLocalStore = (id, newEstimate, newFormData) => {
                const key = `estimate_unsaved_${id}`;
                const data = {
                    timestamp: Date.now(),
                    estimate: newEstimate,
                    formData: newFormData
                };
                localStorage.setItem(key, JSON.stringify(data));
                setUnsavedChanges(true);
            };

            const clearLocalStore = (id) => {
                localStorage.removeItem(`estimate_unsaved_${id}`);
                setUnsavedChanges(false);
            };

            const checkLocalStore = (id) => {
                const key = `estimate_unsaved_${id}`;
                const stored = localStorage.getItem(key);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        // Optional: Check if local data is newer than DB data?
                        // For now, we assume local data takes precedence if it exists
                        return data;
                    } catch (e) {
                        console.error("Error parsing local store:", e);
                        return null;
                    }
                }
                return null;
            };

            const handleGlobalSave = async () => {
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');
                if (!id) return;

                setSaving(true);
                try {
                    // Prepare payload matching updateEstimate signature
                    // We need to map estimate state (keyed by internal keys like 'labor') 
                    // to backend expected keys (usually match internal keys but let's be safe)

                    // Use Chart Data directly for consistency
                    const currentSubTotal = chartData.subTotal;
                    const grandTotalAmount = chartData.grandTotal;
                    const marginAmount = grandTotalAmount - currentSubTotal;

                    const payload = {
                        id: id,
                        ...formData, // Header fields
                        // Ensure markup is saved as string with %
                        bidMarkUp: (String(formData.bidMarkUp).includes('%') ? formData.bidMarkUp : `${formData.bidMarkUp}%`),

                        // Calculated Fields
                        subTotal: currentSubTotal,
                        margin: marginAmount,
                        grandTotal: grandTotalAmount,

                        labor: estimate.labor,
                        equipment: estimate.equipment,
                        material: estimate.material,
                        tools: estimate.tools || estimate.tool,
                        overhead: estimate.overhead,
                        subcontractor: estimate.subcontractor,
                        disposal: estimate.disposal,
                        miscellaneous: estimate.miscellaneous
                    };

                    console.log('Global Save Payload:', payload);

                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateEstimate',
                            payload: payload
                        })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Save failed');
                    }

                    // Update sort order after successful save
                    if (sections && sections.length > 0) {
                        const newOrder = [...sections].sort((a, b) => {
                            const getTot = (s) => s.items.reduce((sum, i) => sum + (i.total || 0), 0);
                            return getTot(b) - getTot(a);
                        }).map(s => s.id);
                        setSectionOrder(newOrder);
                    }

                    setSaving(false);
                    addToast('Estimate saved successfully', 'success');
                    clearLocalStore(id);

                    // Reload to confirm sync and get fresh state
                    await loadEstimate(true);

                } catch (e) {
                    console.error("Global Save Error:", e);
                    addToast('Failed to save estimate', 'error');
                } finally {
                    setSaving(false);
                }
            };


            // Trigger chart animation when estimate loads
            React.useEffect(() => {
                if (estimate) {
                    // Reset first to allow re-animation if estimate changes
                    setChartAnimate(false);
                    const timer = setTimeout(() => setChartAnimate(true), 500);
                    return () => clearTimeout(timer);
                }
            }, [estimate]);

            // Notification & Confirmation State
            const [toasts, setToasts] = React.useState([]);
            const [confirmConfig, setConfirmConfig] = React.useState({ isOpen: false });

            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                // Auto-remove handled by ToastContainer usually, but just in case
            };

            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            const [openSections, setOpenSections] = React.useState({});

            const estimateId = new URLSearchParams(window.location.search).get('id');

            React.useEffect(() => {
                if (estimateId) {
                    loadEstimate();
                }
                loadLaborCatalog();
                loadEquipmentCatalog();
                loadMaterialCatalog();
                loadMiscellaneousCatalog();
                loadOverheadCatalog();
                loadDisposalCatalog();
                loadSubcontractorCatalog();
                loadFringeConstants(); // Load fringe constants
            }, [estimateId]);

            // Helper to get fringe value - HARDENED
            const getFringeRate = (fringeDescription) => {
                if (!fringeDescription) return 0;
                if (!Array.isArray(fringeConstants)) return 0;

                const constant = fringeConstants.find(c => c.description === fringeDescription);
                if (!constant || !constant.value) return 0;

                const val = parseFloat(String(constant.value).replace(/[^0-9.-]+/g, ""));
                return isNaN(val) ? 0 : val;
            };

            const getLaborBreakdown = (item) => {
                const parseNum = (val) => {
                    if (val === undefined || val === null || val === '') return 0;
                    const parsed = parseFloat(String(val).replace(/[^0-9.-]+/g, ""));
                    return isNaN(parsed) ? 0 : parsed;
                };

                const basePay = parseNum(item.basePay);
                const qty = parseNum(item.quantity);
                const days = parseNum(item.days);
                const otPd = parseNum(item.otPd);
                const wCompPct = parseNum(item.wCompPercent);
                const taxesPct = parseNum(item.payrollTaxesPercent);
                const fringeRate = getFringeRate(item.fringe);

                // 1. Total Hours
                const totalHours = qty * days * 8;

                // 2. Total OT Hours
                const totalOtHours = qty * days * otPd;

                // 3. WComp Tax
                const wCompTaxAmount = basePay * (wCompPct / 100);

                // 4. Payroll Taxes
                const payrollTaxAmount = basePay * (taxesPct / 100);

                // 5 & 8. OT Payroll Taxes
                const otPayrollTaxAmount = basePay * 1.5 * (taxesPct / 100);

                // 6. Fringes (Value from constants)
                const fringeAmount = fringeRate;

                // 7. Base Rate
                const baseRate = basePay + wCompTaxAmount + payrollTaxAmount + fringeAmount;

                // 9. OT Rate Calculation based on Spreadsheet
                // OT Rate = (Base Pay * 1.5) + (Base Pay * WComp%) + (Base Pay * 1.5 * Tax%) + Fringe
                const otBasePay = basePay * 1.5;
                const otRate = otBasePay + wCompTaxAmount + otPayrollTaxAmount + fringeAmount;

                // 10. Total
                const total = (totalHours * baseRate) + (totalOtHours * otRate);

                // Final safety check
                const safeTotal = isNaN(total) ? 0 : total;

                return {
                    quantity: qty,
                    days: days,
                    otPd: otPd,
                    basePay: basePay,
                    wCompPct: wCompPct,
                    payrollPct: taxesPct, // Matches modal key
                    fringeRate: fringeRate,

                    totalHours: totalHours,
                    totalOtHours: totalOtHours,
                    wCompTaxAmount: wCompTaxAmount,
                    payrollTaxAmount: payrollTaxAmount,
                    otPayrollTaxAmount: otPayrollTaxAmount,
                    fringe: fringeAmount, // Matches modal key `fringe`
                    fringeAmount: fringeAmount, // Keep for backward compatibility

                    totalBaseRate: baseRate, // Matches modal key `totalBaseRate`
                    baseRate: baseRate,

                    totalOtRate: otRate, // Matches modal key `totalOtRate`
                    otRate: otRate,

                    grandTotal: safeTotal, // Matches modal key `grandTotal`
                    total: safeTotal
                };
            };

            const handleExplain = (item) => {
                const breakdown = getLaborBreakdown(item);
                // Hard reload fringe just in case state lagged
                const freshFringe = getFringeRate(item.fringe);
                breakdown.fringe = freshFringe;
                breakdown.fringeAmount = freshFringe;

                setBreakdownData(breakdown);
                setExplanationItem(item);
            };

            const calculateLaborTotal = (item) => {
                const parseNum = (val) => parseFloat(String(val).replace(/[^0-9.-]+/g, "")) || 0;
                const subClass = (item.subClassification || '').toLowerCase();

                // If Per Diem or Hotel, use simple calc
                if (subClass === 'per diem' || subClass === 'hotel') {
                    const basePay = parseNum(item.basePay);
                    const qty = parseNum(item.quantity);
                    const days = parseNum(item.days);
                    return basePay * qty * days;
                }

                // Use the complex breakdown calc
                return getLaborBreakdown(item).total;
            };


            const loadLaborCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'estimateLineItemsLabor' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setLaborCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading labor catalog:', error);
                }
            };

            const loadEquipmentCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'equipment' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setEquipmentCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading equipment catalog:', error);
                }
            };

            const loadMaterialCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'material' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setMaterialCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading material catalog:', error);
                }
            };

            const loadMiscellaneousCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'miscellaneous' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setMiscellaneousCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading miscellaneous catalog:', error);
                }
            };

            const loadOverheadCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'overhead' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setOverheadCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading overhead catalog:', error);
                }
            };

            const loadDisposalCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'disposal' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setDisposalCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading disposal catalog:', error);
                }
            };

            const loadSubcontractorCatalog = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'subcontractor' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setSubcontractorCatalog(result.result);
                    }
                } catch (error) {
                    console.error('Error loading subcontractor catalog:', error);
                }
            };

            const loadFringeConstants = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'constant' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setFringeConstants(result.result);
                    }
                } catch (error) {
                    console.error('Error loading fringe constants:', error);
                }
            };

            const loadEstimate = async (silent = false) => {
                if (!silent) setLoading(true);
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getEstimateById',
                            payload: { id: estimateId }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        const loadedData = result.result;
                        // Clean numeric fields
                        if (loadedData.bidMarkUp) loadedData.bidMarkUp = String(loadedData.bidMarkUp).replace(/[^0-9.]/g, '');

                        setEstimate(loadedData);
                        setFormData(loadedData);

                        // Check for local unsaved changes
                        const localData = checkLocalStore(estimateId);
                        if (localData) {
                            console.log("Loading unsaved changes from local storage");
                            const mergedEstimate = localData.estimate || loadedData;

                            // Fix for legacy 'tool' key in local storage
                            if (mergedEstimate.tool && Array.isArray(mergedEstimate.tool)) {
                                console.log('Migrating local storage: tool -> tools');
                                mergedEstimate.tools = mergedEstimate.tool;
                                delete mergedEstimate.tool;
                            }

                            const mergedFormData = localData.formData || loadedData;
                            setEstimate(mergedEstimate);
                            setFormData(mergedFormData);
                            setUnsavedChanges(true);
                            addToast('Restored unsaved changes', 'info');
                        } else {
                            setUnsavedChanges(false);
                        }

                        // Load version history if proposalNo exists
                        if (loadedData.proposalNo) {
                            loadVersionHistory(loadedData.proposalNo);
                        }
                    }
                } catch (error) {
                    console.error('Error loading estimate:', error);
                }
                if (!silent) setLoading(false);
            };

            const loadVersionHistory = async (proposalNo) => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getEstimatesByProposal',
                            payload: { proposalNo }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setVersionHistory(result.result);
                    }
                } catch (error) {
                    console.error('Error loading version history:', error);
                }
            };



            const handleSaveItem = async (section, data, isManual = false) => {
                if (!estimate || !section) return;
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');

                try {
                    // Ensure numeric fields are numbers
                    const processedData = { ...data };
                    const fieldsToProcess = section.formFields || section.fields;

                    fieldsToProcess.forEach(field => {
                        const isNumber = ['cost', 'quantity', 'days', 'otPd', 'wCompPercent', 'payrollTaxesPercent', 'basePay', 'taxes', 'dailyCost', 'weeklyCost', 'monthlyCost', 'fuelAdditiveCost', 'hourlyRate', 'dailyRate'].includes(field);
                        if (isNumber && processedData[field]) {
                            processedData[field] = parseFloat(processedData[field]);
                        }
                    });

                    // Special handling for Labor unique string if needed
                    if (section.id === 'Labor') {
                        processedData.labor = `${processedData.classification || ''}${processedData.fringe ? '-' + processedData.fringe : ''}`;
                    }

                    // Generate temp ID
                    processedData._id = 'temp_' + Date.now() + Math.random().toString(36).substr(2, 9);
                    processedData.estimateId = estimate._id;

                    // Update State & Local Storage
                    setEstimate(prev => {
                        const currentItems = prev[section.key] || [];
                        const newEstimate = {
                            ...prev,
                            [section.key]: [...currentItems, processedData]
                        };
                        updateLocalStore(id, newEstimate, formData);
                        return newEstimate;
                    });

                    addToast('Item added (unsaved)', 'success');

                } catch (error) {
                    console.error('Error saving item locally:', error);
                    addToast('Failed to add item', 'error');
                }
            };


            const handleDeleteItem = (section, item) => {
                if (!confirm('Area you sure you want to delete this item?')) return;
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');

                setEstimate(prev => {
                    const currentItems = prev[section.key] || [];
                    const updatedItems = currentItems.filter(i => i._id !== item._id);

                    const newEstimate = { ...prev, [section.key]: updatedItems };
                    updateLocalStore(id, newEstimate, formData);
                    return newEstimate;
                });

                addToast('Item removed (unsaved)', 'info');
            };


            const handleItemUpdate = async (section, item, field, value) => {
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');
                const typeMap = {
                    'Labor': 'estimateLineItemsLabor',
                    'Equipment': 'estimateLineItemsEquipment',
                    'Material': 'estimateLineItemsMaterial',
                    'Tools': 'estimateLineItemsTool',
                    'Overhead': 'estimateLineItemsOverhead',
                    'Subcontractor': 'estimateLineItemsSubcontractor',
                    'Disposal': 'estimateLineItemsDisposal',
                    'Miscellaneous': 'estimateLineItemsMiscellaneous'
                };
                const type = typeMap[section.id];
                if (!type) return;

                // Parse value if numeric field
                let finalValue = value;
                const isNumber = ['quantity', 'days', 'otPd', 'basePay', 'dailyCost', 'weeklyCost', 'monthlyCost', 'fuelAdditiveCost', 'cost', 'wCompPercent', 'payrollTaxesPercent', 'taxes', 'hourlyRate', 'dailyRate', 'times'].includes(field);
                if (isNumber) {
                    // Handle empty strings as 0 or keep as is?
                    if (value === '') finalValue = 0;
                    else {
                        finalValue = parseFloat(value);
                        if (isNaN(finalValue)) finalValue = 0;
                    }
                }

                if (section.id === 'Overhead') {
                    if (field === 'days') {
                        finalValue = parseFloat(value) || 0;
                        const hours = finalValue * 8;
                        const hourlyRate = item.hourlyRate || 0;
                        const total = hours * hourlyRate;

                        // Update multiple fields
                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i => {
                                if (i._id === item._id) {
                                    // Total is calculated as hours * hourlyRate.
                                    // Daily Rate should vary if days vary, but ideally it represents cost per day.
                                    // If we fix Hourly Rate, then Daily Rate = (Days * 8 * Hourly Rate) / Days = 8 * Hourly Rate.
                                    // It seems Daily Rate is just 8 * Hourly Rate regardless of Days if Hours = Days * 8.
                                    // However, let's strictly follow the user formula: (Hours * Hourly Rate) / Days.
                                    // note: Hours = Days * 8, so (Days * 8 * Rate) / Days = 8 * Rate.
                                    // So Daily Rate is constant per hourly rate change, but we should set it explicitly.
                                    const newDailyRate = finalValue > 0 ? total / finalValue : 0;
                                    return { ...i, days: finalValue, hours: hours, total: total, dailyRate: newDailyRate };
                                }
                                return i;
                            });
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                    if (field === 'hourlyRate') {
                        finalValue = parseFloat(value) || 0;
                        const hours = item.hours || 0;
                        const total = hours * finalValue;

                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i => {
                                if (i._id === item._id) {
                                    const dailyRate = i.days > 0 ? total / i.days : 0;
                                    return { ...i, hourlyRate: finalValue, total: total, dailyRate: dailyRate };
                                }
                                return i;
                            });
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                    if (field === 'dailyRate') {
                        finalValue = parseFloat(value) || 0;
                        const days = item.days || 0;
                        // Assuming 8 hour day logic holds for rate conversion too
                        const calculatedHourlyRate = finalValue / 8;
                        const hours = days * 8;
                        const total = days * finalValue; // Or hours * calculatedHourlyRate

                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i =>
                                i._id === item._id ? { ...i, dailyRate: finalValue, hourlyRate: calculatedHourlyRate, total: total } : i
                            );
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                }

                if (section.id === 'Equipment') {
                    // Equipment Total Recalculation
                    const relevantFields = ['quantity', 'times', 'uom', 'dailyCost', 'weeklyCost', 'monthlyCost'];
                    if (relevantFields.includes(field)) {
                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i => {
                                if (i._id === item._id) {
                                    // Get all values, defaulting to current item value if not the field being updated
                                    // For 'times', default to 1 if undefined to preserve legacy math
                                    const getVal = (k, def) => (field === k ? finalValue : (i[k] !== undefined ? i[k] : def));

                                    const qty = parseFloat(getVal('quantity', 0)) || 0;
                                    const times = parseFloat(getVal('times', 1)); // Default to 1
                                    const uom = getVal('uom', 'Daily');

                                    const daily = parseFloat(getVal('dailyCost', 0)) || 0;
                                    const weekly = parseFloat(getVal('weeklyCost', 0)) || 0;
                                    const monthly = parseFloat(getVal('monthlyCost', 0)) || 0;

                                    let newTotal = 0;
                                    const safeTimes = isNaN(times) ? 1 : times;

                                    if (uom === 'Daily') newTotal = daily * qty * safeTimes;
                                    else if (uom === 'Weekly') newTotal = weekly * qty * safeTimes;
                                    else if (uom === 'Monthly') newTotal = monthly * qty * safeTimes;

                                    return {
                                        ...i,
                                        [field]: finalValue,
                                        total: newTotal,
                                        times: safeTimes
                                    };
                                }
                                return i;
                            });
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                }

                if (section.id === 'Equipment') {
                    // Equipment Total Recalculation
                    const relevantFields = ['quantity', 'times', 'uom', 'dailyCost', 'weeklyCost', 'monthlyCost', 'fuelAdditiveCost'];
                    if (relevantFields.includes(field)) {
                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i => {
                                if (i._id === item._id) {
                                    const getVal = (k, def) => (field === k ? finalValue : (i[k] !== undefined ? i[k] : def));

                                    const qty = parseFloat(getVal('quantity', 0)) || 0;
                                    const times = parseFloat(getVal('times', 1)); // Default to 1 if not set
                                    const uom = getVal('uom', 'Daily');

                                    let cost = 0;
                                    if (uom === 'Daily') cost = parseFloat(getVal('dailyCost', 0)) || 0;
                                    else if (uom === 'Weekly') cost = parseFloat(getVal('weeklyCost', 0)) || 0;
                                    else if (uom === 'Monthly') cost = parseFloat(getVal('monthlyCost', 0)) || 0;
                                    else cost = parseFloat(getVal('dailyCost', 0)) || 0;

                                    const newTotal = (cost * qty * (isNaN(times) ? 1 : times));
                                    // Note: fuelAdditiveCost often added to total? User formula didn't explicitly include it in 'cost * qty * times', 
                                    // but if it's a cost, it might need to be. 
                                    // Standard logic was just 'cost' based on UOM. 
                                    // If fuel is separate, add it here if needed. 
                                    // For now, sticking to: Cost * Qty * Times.

                                    return {
                                        ...i,
                                        [field]: finalValue,
                                        times: isNaN(times) ? 1 : times, // Ensure times is saved
                                        total: newTotal
                                    };
                                }
                                return i;
                            });
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                }

                if (section.id === 'Subcontractor') {
                    // Subcontractor Total Recalculation (Qty * Cost)
                    const relevantFields = ['quantity', 'cost'];
                    if (relevantFields.includes(field)) {
                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i => {
                                if (i._id === item._id) {
                                    const getVal = (k, def) => (field === k ? finalValue : (i[k] !== undefined ? i[k] : def));
                                    const qty = parseFloat(getVal('quantity', 0)) || 0;
                                    const cost = parseFloat(getVal('cost', 0)) || 0;
                                    const newTotal = qty * cost;
                                    return {
                                        ...i,
                                        [field]: finalValue,
                                        total: newTotal
                                    };
                                }
                                return i;
                            });
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                }

                if (section.id === 'Material') {
                    // Material Total Recalculation
                    const relevantFields = ['quantity', 'cost', 'taxes'];
                    if (relevantFields.includes(field)) {
                        setEstimate(prev => {
                            const currentItems = prev[section.key] || [];
                            const updatedItems = currentItems.map(i => {
                                if (i._id === item._id) {
                                    const getVal = (k, def) => (field === k ? finalValue : (i[k] !== undefined ? i[k] : def));

                                    const qty = parseFloat(getVal('quantity', 0)) || 0;
                                    const cost = parseFloat(getVal('cost', 0)) || 0;
                                    const taxes = parseFloat(getVal('taxes', 0)) || 0;

                                    // Formula: (Qty * Cost) + (Qty * Cost * Tax)
                                    // Check if Tax is percentage (e.g. 8.5) or decimal (0.085).
                                    // Usually users enter 8.5 for 8.5%.
                                    // If value is > 1, assume percent. If < 1, ambiguous.
                                    // Let's assume input is percentage for consistency with other parts if any.
                                    // User said: (Qty x Cost)*Tax. If Tax is 10 (for $10), it adds $10?
                                    // "Tax" usually implies a rate.
                                    // Let's try treating it as a percentage value.
                                    // Total = (Qty * Cost) * (1 + taxes / 100)

                                    const subTotal = qty * cost;
                                    const taxAmount = subTotal * (taxes / 100);
                                    const newTotal = subTotal + taxAmount;

                                    return {
                                        ...i,
                                        [field]: finalValue,
                                        total: newTotal
                                    };
                                }
                                return i;
                            });
                            const newEstimate = { ...prev, [section.key]: updatedItems };
                            updateLocalStore(id, newEstimate, formData);
                            return newEstimate;
                        });
                        return;
                    }
                }

                if (section.id === 'Labor') {
                    // Recalculate labor total if quantity/days/otPd changes
                    // Using existing calculation logic if needed, or relying on `calculateLaborTotal` helper if it's purely display.
                    // But here we are storing values. 
                    // Labor total is calculated on the fly in `sections` usually, but let's stick to standard single field update unless complex.
                }

                // Standard single field update
                setEstimate(prev => {
                    const currentItems = prev[section.key] || [];
                    const updatedItems = currentItems.map(i =>
                        i._id === item._id ? { ...i, [field]: finalValue } : i
                    );

                    const newEstimate = { ...prev, [section.key]: updatedItems };
                    updateLocalStore(id, newEstimate, formData);
                    return newEstimate;
                });
            };


            const toggleSection = (section) => {
                setOpenSections(prev => ({
                    ...prev,
                    [section]: !prev[section]
                }));
            };

            const handleCreateNew = async () => {
                try {
                    setLoading(true);
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'createEstimate' })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        window.location.href = `view.html?id=${result.result.id}`;
                    }
                } catch (e) {
                    console.error("Error creating", e);
                    setLoading(false);
                }
            };

            const handleDeleteEstimate = async () => {
                if (!confirm('Are you sure you want to delete this estimate?')) return;

                try {
                    setLoading(true);
                    await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'deleteEstimateFromAppSheet',
                            payload: { estimateId: estimateId }
                        })
                    });
                    window.location.href = 'estimates.html';
                } catch (e) {
                    console.error("Error deleting", e);
                    alert("Failed to delete");
                    setLoading(false);
                }
            };

            const [sectionOrder, setSectionOrder] = React.useState([]);
            const initialSortDone = React.useRef(false);

            const baseSections = React.useMemo(() => {
                const defaultColors = {
                    Labor: '#4F7E17',
                    Equipment: '#0000FF',
                    Material: '#F88702',
                    Tools: '#800080',
                    Overhead: '#F0C400',
                    Subcontractor: '#7B4019',
                    Disposal: '#000000',
                    Miscellaneous: '#CD0302'
                };

                const getColor = (name) => {
                    const constant = fringeConstants.find(c => c.description === name || c.description === `${name} Color`);
                    return (constant && constant.color) ? constant.color : (defaultColors[name] || '#cbd5e1');
                };

                const unsortedSections = [
                    {
                        id: 'Labor',
                        title: 'Labor',
                        key: 'labor',
                        items: (estimate?.labor || [])
                            .map(item => ({
                                ...item,
                                labor: item.labor || `${item.classification || ''}-${item.fringe || ''}`,
                                total: calculateLaborTotal(item)
                            })),
                        headers: ['Labor', 'Classification', 'Sub Classification', 'Base Pay', 'Quantity', 'Days', 'OT PD', 'W. Comp', 'Payroll Tax', 'Total'],
                        fields: ['labor', 'classification', 'subClassification', 'basePay', 'quantity', 'days', 'otPd', 'wCompPercent', 'payrollTaxesPercent', 'total'],
                        formHeaders: ['Classification', 'Sub Classification', 'Fringe', 'Base Pay', 'Quantity', 'Days', 'OT PD', 'W. Comp %', 'Payroll Tax %'],
                        formFields: ['classification', 'subClassification', 'fringe', 'basePay', 'quantity', 'days', 'otPd', 'wCompPercent', 'payrollTaxesPercent'],
                        color: getColor('Labor')
                    },
                    {
                        id: 'Equipment',
                        title: 'Equipment',
                        key: 'equipment',
                        items: (estimate?.equipment || [])
                            .map(item => {
                                const qty = item.quantity || 0;
                                const times = item.times !== undefined ? item.times : 1;
                                const uom = item.uom || 'Daily';
                                let calculatedTotal = 0;

                                const cost = uom === 'Daily' ? (item.dailyCost || 0) :
                                    uom === 'Weekly' ? (item.weeklyCost || 0) :
                                        (item.monthlyCost || 0);

                                calculatedTotal = cost * qty * times;

                                return {
                                    ...item,
                                    times: times, // Ensure times is present
                                    total: item.total ?? calculatedTotal
                                };
                            }),
                        headers: ['Equipment / Machine', 'Classification', 'Sub Classification', 'Supplier', 'Qty', 'Times', 'UOM', 'Daily Cost', 'Weekly Cost', 'Monthly Cost', 'Fuel', 'Total'],
                        fields: ['equipmentMachine', 'classification', 'subClassification', 'supplier', 'quantity', 'times', 'uom', 'dailyCost', 'weeklyCost', 'monthlyCost', 'fuelAdditiveCost', 'total'],
                        color: getColor('Equipment')
                    },
                    {
                        id: 'Material',
                        title: 'Material',
                        key: 'material',
                        items: (estimate?.material || [])
                            .map(item => ({
                                ...item,
                                total: item.total ?? ((item.cost || 0) * (item.quantity || 0) * (1 + (item.taxes || 0) / 100))
                            })),
                        headers: ['Material', 'Classification', 'Sub Classification', 'Supplier', 'Qty', 'UOM', 'Cost', 'Taxes', 'Total'],
                        fields: ['material', 'classification', 'subClassification', 'supplier', 'quantity', 'uom', 'cost', 'taxes', 'total'],
                        color: getColor('Material')
                    },
                    {
                        id: 'Tools',
                        title: 'Tools',
                        key: 'tools',
                        items: (estimate?.tools || [])
                            .map(item => ({
                                ...item,
                                total: item.total ?? ((item.cost || 0) * (item.quantity || 0))
                            })),
                        headers: ['Tool', 'Classification', 'Sub Classification', 'UOM', 'Supplier', 'Cost', 'Quantity', 'Taxes', 'Total'],
                        fields: ['tool', 'classification', 'subClassification', 'uom', 'supplier', 'cost', 'quantity', 'taxes', 'total'],
                        color: getColor('Tools')
                    },
                    {
                        id: 'Overhead',
                        title: 'Overhead',
                        key: 'overhead',
                        items: (estimate?.overhead || [])
                            .map(item => ({
                                ...item,
                                total: item.total ?? ((item.cost || 0) * (item.quantity || 0))
                            })),
                        headers: ['Overhead', 'Classification', 'Sub Classification', 'Days', 'Hours', 'Hourly Rate', 'Daily Rate', 'Total'],
                        fields: ['overhead', 'classification', 'subClassification', 'days', 'hours', 'hourlyRate', 'dailyRate', 'total'],
                        formHeaders: ['Overhead', 'Classification', 'Sub Classification', 'Hourly Cost', 'Daily Cost'],
                        formFields: ['overhead', 'classification', 'subClassification', 'hourlyRate', 'dailyRate'],
                        color: getColor('Overhead')
                    },
                    {
                        id: 'Subcontractor',
                        title: 'Subcontractor',
                        key: 'subcontractor',
                        items: (estimate?.subcontractor || [])
                            .map(item => ({
                                ...item,
                                total: item.total ?? ((item.cost || 0) * (item.quantity || 0))
                            })),
                        headers: ['Classification', 'Sub Classification', 'Contractor', 'Qty', 'UOM', 'Cost', 'Total'],
                        fields: ['classification', 'subClassification', 'subcontractor', 'quantity', 'uom', 'cost', 'total'],
                        formHeaders: ['Classification', 'Sub Classification', 'Contractor', 'Qty', 'UOM', 'Cost'],
                        formFields: ['classification', 'subClassification', 'subcontractor', 'quantity', 'uom', 'cost'],
                        color: getColor('Subcontractor')
                    },
                    {
                        id: 'Disposal',
                        title: 'Disposal',
                        key: 'disposal',
                        items: (estimate?.disposal || [])
                            .map(item => ({
                                ...item,
                                total: item.total ?? ((item.cost || 0) * (item.quantity || 0))
                            })),
                        headers: ['Disposal And Haul OFF', 'Classification', 'Sub Classification', 'UOM', 'Quantity', 'Cost', 'Total'],
                        fields: ['disposalAndHaulOff', 'classification', 'subClassification', 'uom', 'quantity', 'cost', 'total'],
                        formHeaders: ['Disposal And Haul OFF', 'Classification', 'Sub Classification', 'UOM', 'Quantity', 'Cost'],
                        formFields: ['disposalAndHaulOff', 'classification', 'subClassification', 'uom', 'quantity', 'cost'],
                        color: getColor('Disposal')
                    },
                    {
                        id: 'Miscellaneous',
                        title: 'Miscellaneous',
                        key: 'miscellaneous',
                        items: (estimate?.miscellaneous || [])
                            .map(item => ({
                                ...item,
                                total: item.total ?? ((item.cost || 0) * (item.quantity || 1))
                            })),
                        headers: ['Item', 'Classification', 'Quantity', 'UOM', 'Cost', 'Total'],
                        fields: ['item', 'classification', 'quantity', 'uom', 'cost', 'total'],
                        formHeaders: ['Item', 'Classification', 'UOM', 'Cost'],
                        formFields: ['item', 'classification', 'uom', 'cost'],
                        color: getColor('Miscellaneous')
                    }
                ];

                return unsortedSections; // Return raw sections without sorting
            }, [estimate, fringeConstants]);

            // sort logic
            const sections = React.useMemo(() => {
                if (sectionOrder.length === 0) return baseSections;
                return [...baseSections].sort((a, b) => {
                    const idxA = sectionOrder.indexOf(a.id);
                    const idxB = sectionOrder.indexOf(b.id);
                    if (idxA === -1) idxA = 999;
                    if (idxB === -1) idxB = 999;
                    return idxA - idxB;
                });
            }, [baseSections, sectionOrder]);

            // Initial Sort on Load
            React.useEffect(() => {
                if (estimate && !initialSortDone.current && baseSections.length > 0) {
                    const newOrder = [...baseSections].sort((a, b) => {
                        const getTot = (s) => s.items.reduce((sum, i) => sum + (i.total || 0), 0);
                        return getTot(b) - getTot(a);
                    }).map(s => s.id);
                    setSectionOrder(newOrder);
                    initialSortDone.current = true;
                }
            }, [estimate, baseSections]);


            // --- Chart & Header Data Preparation ---


            const uniqueEquipmentSuppliers = React.useMemo(() => {
                return [...new Set(equipmentCatalog.map(i => i.supplier).filter(Boolean))].sort();
            }, [equipmentCatalog]);

            const uniqueMaterialSuppliers = React.useMemo(() => {
                return [...new Set(materialCatalog.map(i => i.supplier).filter(Boolean))].sort();
            }, [materialCatalog]);

            const uniqueMaterialUOMs = React.useMemo(() => {
                return [...new Set(materialCatalog.map(i => i.uom).filter(Boolean))].sort();
            }, [materialCatalog]);

            const uniqueMiscClassifications = React.useMemo(() => {
                return [...new Set(miscellaneousCatalog.map(i => i.classification).filter(Boolean))].sort();
            }, [miscellaneousCatalog]);

            const uniqueMiscUOMs = React.useMemo(() => {
                return [...new Set(miscellaneousCatalog.map(i => i.uom).filter(Boolean))].sort();
            }, [miscellaneousCatalog]);

            const uniqueOverheadClassifications = React.useMemo(() => {
                return [...new Set(overheadCatalog.map(i => i.classification).filter(Boolean))].sort();
            }, [overheadCatalog]);

            const uniqueOverheadSubClassifications = React.useMemo(() => {
                return [...new Set(overheadCatalog.map(i => i.subClassification).filter(Boolean))].sort();
            }, [overheadCatalog]);

            const uniqueDisposalClassifications = React.useMemo(() => {
                return [...new Set(disposalCatalog.map(i => i.classification).filter(Boolean))].sort();
            }, [disposalCatalog]);

            const uniqueDisposalUOMs = React.useMemo(() => {
                return [...new Set(disposalCatalog.map(i => i.uom).filter(Boolean))].sort();
            }, [disposalCatalog]);

            const uniqueSubClassifications = React.useMemo(() => {
                return [...new Set(subcontractorCatalog.map(i => i.classification).filter(Boolean))].sort();
            }, [subcontractorCatalog]);

            const uniqueSubSubClassifications = React.useMemo(() => {
                return [...new Set(subcontractorCatalog.map(i => i.subClassification).filter(Boolean))].sort();
            }, [subcontractorCatalog]);

            const uniqueSubContractors = React.useMemo(() => {
                return [...new Set(subcontractorCatalog.map(i => i.subcontractor).filter(Boolean))].sort();
            }, [subcontractorCatalog]);

            const uniqueSubUOMs = React.useMemo(() => {
                return [...new Set(subcontractorCatalog.map(i => i.uom).filter(Boolean))].sort();
            }, [subcontractorCatalog]);

            const chartData = React.useMemo(() => {
                try {
                    if (!sections) return { slices: [], total: 0, subTotal: 0, grandTotal: 0, markupPct: 0 };

                    const data = sections.map(s => {
                        const items = s.items || estimate[s.key] || [];
                        const value = items.reduce((sum, i) => sum + (i.total || 0), 0);
                        return { id: s.id, label: s.title, value, color: s.color || '#cbd5e1' };
                    });

                    // Calculate Subtotal and Markup
                    const subTotal = data.reduce((sum, d) => sum + d.value, 0);
                    const markupStr = formData?.bidMarkUp || estimate?.bidMarkUp || '0';
                    const markupPct = parseFloat(String(markupStr).replace(/[^0-9.-]+/g, "")) || 0;
                    const markupAmount = subTotal * (markupPct / 100);
                    const grandTotal = subTotal + markupAmount;

                    return { slices: data, total: grandTotal, subTotal, grandTotal, markupPct };
                } catch (err) {
                    console.error("Chart Data Error:", err);
                    return { slices: [], total: 0, subTotal: 0, grandTotal: 0, markupPct: 0 };
                }
            }, [sections, estimate, formData.bidMarkUp]);

            // Track if we have performed the initial expansion (using ref to avoid closure issues)
            const initialExpandDone = React.useRef(false);
            const prevSliceValues = React.useRef({});

            // Auto-collapse/expand accordion sections
            // Auto-collapse/expand accordion sections based on ITEMS COUNT
            React.useEffect(() => {
                if (!sections) return;

                const oldVals = prevSliceValues.current; // reusing this ref but strictly for counts now
                const isFirstRun = !initialExpandDone.current;

                // Calculate new state
                const newState = {};
                const newCounts = {};

                sections.forEach(s => {
                    const count = s.items.length;
                    newCounts[s.id] = count;
                    const oldCount = oldVals[s.id] || 0;

                    if (isFirstRun) {
                        // Initial Load: Expand if items > 0
                        newState[s.id] = count > 0;
                    } else {
                        // Continuous Updates:
                        if (count === 0) {
                            // Force collapse if 0 items
                            newState[s.id] = false;
                        } else if (count > 0 && oldCount === 0) {
                            // Auto-expand if transitioning from 0 -> >0 items
                            newState[s.id] = true;
                        }
                        // For other cases (items > 0 and oldItems > 0), don't set - preserve manual state
                    }
                });

                // Apply state updates
                setOpenSections(prev => {
                    const next = { ...prev };
                    Object.keys(newState).forEach(key => {
                        next[key] = newState[key];
                    });
                    return next;
                });

                // Update tracking refs
                prevSliceValues.current = newCounts;

                if (isFirstRun) {
                    initialExpandDone.current = true;
                }
            }, [sections]);

            const toggleService = (serviceId) => {
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');
                if (!id) return;

                const newVal = !formData[serviceId];

                // Optimistic Update & Local Store
                setFormData(prev => {
                    const newFormData = { ...prev, [serviceId]: newVal };
                    updateLocalStore(id, estimate, newFormData);
                    return newFormData;
                });
            };


            const toggleStatus = () => {
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');
                const currentStatus = formData.status || 'draft';
                const newStatus = currentStatus === 'confirmed' ? 'draft' : 'confirmed';

                // Optimistic Update & Local Store
                setFormData(prev => {
                    const newFormData = { ...prev, status: newStatus };
                    updateLocalStore(id, estimate, newFormData);
                    return newFormData;
                });

                addToast(`Estimate ${newStatus === 'confirmed' ? 'confirmed' : 'set to draft'} (unsaved)`, 'info');
            };

            const handleHeaderUpdate = (field, value) => {
                const id = estimateId || formData._id || new URLSearchParams(window.location.search).get('id');
                setFormData(prev => {
                    const newFormData = { ...prev, [field]: value };
                    updateLocalStore(id, estimate, newFormData);
                    return newFormData;
                });
            };


            const servicesList = [
                { id: 'directionalDrilling', label: 'Drilling', color: 'emerald', icon: <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" /> },
                { id: 'excavationBackfill', label: 'Excavation', color: 'blue', icon: <path d="M2 12h20M2 12l5-9M7 3h10M17 3l5 9" /> },
                { id: 'hydroExcavation', label: 'Hydro', color: 'cyan', icon: <path d="M12 2.69l5.74 8.2a8 8 0 1 1-11.48 0L12 2.69z" /> },
                { id: 'potholingCoring', label: 'Potholing', color: 'amber', icon: <circle cx="12" cy="12" r="10" /> },
                { id: 'asphaltConcrete', label: 'Asphalt', color: 'stone', icon: <rect x="2" y="2" width="20" height="20" rx="5" ry="5" /> }
            ];

            if (loading) return <PageSkeleton />;
            if (!estimate) return (
                <div className="h-screen w-screen flex flex-col bg-gray-50">
                    <Header activePage="estimates" />
                    <div className="flex-1 flex items-center justify-center">
                        <EmptyState icon="ban" title="Estimate Not Found" message="The requested estimate could not be loaded." action={<Button onClick={() => window.location.href = 'estimates.html'}>Back to Estimates</Button>} />
                    </div>
                </div>
            );

            const HeaderActions = () => {
                const allExpanded = sections && sections.length > 0 && sections.every(s => openSections[s.id]);

                const handleToggleAll = () => {
                    setOpenSections(prev => {
                        const next = {};
                        if (allExpanded) {
                            // Collapse all
                            sections.forEach(s => next[s.id] = false);
                        } else {
                            // Expand all
                            sections.forEach(s => next[s.id] = true);
                        }
                        return next;
                    });
                };

                return (
                    <div className="flex items-center gap-2">
                        {unsavedChanges && (
                            <button
                                onClick={handleGlobalSave}
                                disabled={saving}
                                className="flex items-center gap-2 px-3 py-1.5 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all font-bold text-xs shadow-md"
                            >
                                {saving ? <DevcoIcon name="loader" size={14} className="animate-spin" /> : <DevcoIcon name="save" size={14} />}
                                SAVE
                            </button>
                        )}
                        <button
                            onClick={handleToggleAll}
                            className="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title={allExpanded ? "Collapse All" : "Expand All"}
                        >
                            <DevcoIcon name={allExpanded ? "chevrons-up" : "chevrons-down"} size={20} />
                        </button>
                    </div>
                );
            };


            return (
                <div className="flex flex-col h-screen bg-slate-50 overflow-hidden">
                    <Header
                        activePage="estimates"
                        rightContent={
                            <div className="flex items-center gap-2">
                                <HeaderActions />
                                <div className="h-6 w-px bg-gray-200 mx-2"></div>
                                <button
                                    onClick={() => loadEstimate(true)}
                                    className="flex items-center justify-center w-10 h-10 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors border border-transparent hover:border-blue-100"
                                    title="Refresh Data"
                                >
                                    <DevcoIcon name="refresh-cw" size={20} />
                                </button>
                                <button
                                    onClick={handleCreateNew}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-sm text-sm font-bold"
                                >
                                    <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    New
                                </button>
                                <button
                                    onClick={handleDeleteEstimate}
                                    className="flex items-center justify-center w-10 h-10 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-colors border border-transparent hover:border-red-100"
                                    title="Delete Estimate"
                                >
                                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        }
                    />

                    < main className="flex-1 overflow-y-auto" >
                        <div className="w-full px-4 py-8">
                            {/* Detailed Header Card */}


                            <div className="bg-[#eef2f6] rounded-[40px] shadow-[12px_12px_24px_#d1d9e6,-12px_-12px_24px_#ffffff] p-8 mb-6">
                                {/* 4-Column Grid Layout */}
                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8">

                                    {/* PART 1: Customer + Services */}
                                    <div className="flex flex-col gap-6 p-4 rounded-2xl bg-white/30 shadow-[inset_2px_2px_6px_#d1d9e6,inset_-2px_-2px_6px_#ffffff]">
                                        {/* Customer */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">Customer</label>
                                            <div className="text-2xl font-black text-slate-800 tracking-tight truncate" title={formData.customerName || 'No Customer'}>
                                                {formData.customerName || 'No Customer'}
                                            </div>
                                        </div>

                                        {/* Services */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 block">Services</label>
                                            <div className="grid grid-cols-3 gap-3">
                                                {[
                                                    { id: 'directionalDrilling', label: 'Directional Drilling', icon: <path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25M12 11l-2.5-1.25M12 16l-5-2.5M12 16l5-2.5M2 17l10 5 10-5" /> },
                                                    { id: 'excavationBackfill', label: 'Excavation & Backfill', icon: <path d="M2 22h20M2 12l2-2 3 3 5-5 3 3 5-5 2 2" strokeLinecap="round" strokeLinejoin="round" /> },
                                                    { id: 'hydroExcavation', label: 'Hydro-excavation', icon: <path d="M12 2.69l5.74 8.2a8 8 0 1 1-11.48 0L12 2.69z" /> },
                                                    { id: 'potholingCoring', label: 'Potholing & Coring', icon: <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-7a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" /> },
                                                    { id: 'asphaltConcrete', label: 'Asphalt & Concrete', icon: <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2zm0-4h16M4 14h16M4 10h16M4 6h16" /> },
                                                    { id: 'status', label: formData.status === 'confirmed' ? 'Confirmed' : 'Draft', isStatus: true, icon: <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /> }
                                                ].map((s) => {
                                                    const isConfirmed = s.isStatus && formData.status === 'confirmed';
                                                    const isActive = s.isStatus ? isConfirmed : formData[s.id];

                                                    return (
                                                        <div
                                                            key={s.id}
                                                            onClick={() => s.isStatus ? toggleStatus() : toggleService(s.id)}
                                                            className={`
                                                                group relative w-12 h-12 rounded-full flex items-center justify-center cursor-pointer transition-all duration-300
                                                                ${isActive
                                                                    ? s.isStatus
                                                                        ? 'shadow-[inset_4px_4px_8px_#b8e0c8,inset_-4px_-4px_8px_#ffffff] text-emerald-600 bg-emerald-50/50'
                                                                        : 'shadow-[inset_4px_4px_8px_#d1d9e6,inset_-4px_-4px_8px_#ffffff] text-blue-600'
                                                                    : 'shadow-[6px_6px_12px_#d1d9e6,-6px_-6px_12px_#ffffff] hover:shadow-[8px_8px_16px_#d1d9e6,-8px_-8px_16px_#ffffff] hover:-translate-y-0.5 text-slate-400'}
                                                            `}
                                                        >
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                {s.icon}
                                                            </svg>

                                                            {/* Custom Tooltip */}
                                                            <div className="absolute -top-9 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-white text-[9px] font-bold rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-20">
                                                                {s.label}
                                                                <div className="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 rotate-45"></div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>

                                    {/* PART 2: Date/Project Title + Markup/Fringe */}
                                    <div className="flex flex-col gap-5 p-4 rounded-2xl bg-white/30 shadow-[inset_2px_2px_6px_#d1d9e6,inset_-2px_-2px_6px_#ffffff]">
                                        {/* Date & Project Title (inline) */}
                                        <div className="flex gap-4">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Date</label>
                                                <div className="text-lg font-bold text-slate-600">{formData.date || '-'}</div>
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Project Title</label>
                                                <div className="text-lg font-bold text-slate-600 truncate" title={formData.estimate || '-'}>{formData.estimate || '-'}</div>
                                            </div>
                                        </div>

                                        {/* Markup */}
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 block">Markup</label>
                                            <div className="relative shadow-[inset_4px_4px_8px_#d1d9e6,inset_-4px_-4px_8px_#ffffff] rounded-2xl p-1 bg-[#eef2f6] h-12 flex items-center">
                                                <input
                                                    type="number"
                                                    value={formData.bidMarkUp || ''}
                                                    onChange={e => handleHeaderUpdate('bidMarkUp', e.target.value)}
                                                    className="w-full bg-transparent text-xl font-bold text-slate-700 h-full px-4 outline-none text-left"
                                                    placeholder="0"
                                                />
                                                <span className="absolute right-4 text-lg font-bold text-slate-400">%</span>
                                            </div>
                                        </div>

                                        {/* Fringe */}
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 block">Fringe Rate</label>
                                            <div className="relative shadow-[inset_4px_4px_8px_#d1d9e6,inset_-4px_-4px_8px_#ffffff] rounded-2xl p-1 bg-[#eef2f6] h-12 flex items-center">
                                                <select
                                                    value={formData.fringe || ''}
                                                    onChange={e => handleHeaderUpdate('fringe', e.target.value)}
                                                    className="w-full appearance-none bg-transparent text-lg font-bold text-slate-700 h-full px-4 outline-none cursor-pointer text-left"
                                                >
                                                    <option value="">None</option>
                                                    <option value="HDD Public">HDD Public</option>
                                                    <option value="HDD Private">HDD Private</option>
                                                    <option value="Light Commercial">Light Commercial</option>
                                                </select>
                                                <div className="absolute right-4 pointer-events-none text-slate-400">
                                                    <DevcoIcon name="chevron-down" size={18} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* PART 3: Chart */}
                                    <div className="flex flex-col p-4 rounded-2xl bg-white/30 shadow-[inset_2px_2px_6px_#d1d9e6,inset_-2px_-2px_6px_#ffffff]">
                                        <label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 block text-center">Cost Breakdown</label>

                                        {/* Semi-Circle Arc Chart */}
                                        <div className="relative w-full flex justify-center items-start" style={{ height: '120px' }}>
                                            <svg viewBox="0 0 200 105" className="w-full max-w-[220px]" style={{ overflow: 'visible' }}>
                                                {(() => {
                                                    const sortedSlices = chartData.slices.filter(s => s.value > 0).sort((a, b) => b.value - a.value);

                                                    // Empty state
                                                    if (sortedSlices.length === 0) {
                                                        return <path d="M 10 100 A 90 90 0 0 1 190 100" fill="none" stroke="#e2e8f0" strokeWidth="22" strokeLinecap="round" />;
                                                    }

                                                    const centerX = 100;
                                                    const centerY = 100;
                                                    const radius = 75;
                                                    const strokeWidth = 24;
                                                    const gapAngle = 4; // Gap between segments in degrees
                                                    const totalGap = gapAngle * (sortedSlices.length - 1);
                                                    const availableAngle = 180 - totalGap;

                                                    let currentAngle = 180; // Start from left

                                                    return sortedSlices.map((slice, idx) => {
                                                        const percent = chartData.subTotal > 0 ? slice.value / chartData.subTotal : 0;
                                                        const sliceAngle = percent * availableAngle;

                                                        // Skip if segment is too small
                                                        if (sliceAngle < 2) return null;

                                                        const startAngle = currentAngle;
                                                        const endAngle = currentAngle - sliceAngle;

                                                        // Convert to radians
                                                        const startRad = (startAngle * Math.PI) / 180;
                                                        const endRad = (endAngle * Math.PI) / 180;

                                                        // Calculate arc endpoints
                                                        const x1 = centerX + radius * Math.cos(startRad);
                                                        const y1 = centerY - radius * Math.sin(startRad);
                                                        const x2 = centerX + radius * Math.cos(endRad);
                                                        const y2 = centerY - radius * Math.sin(endRad);

                                                        const largeArc = sliceAngle > 180 ? 1 : 0;
                                                        const pathD = `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`;

                                                        // Update angle for next segment (include gap)
                                                        currentAngle = endAngle - gapAngle;

                                                        return (
                                                            <path
                                                                key={slice.id}
                                                                d={pathD}
                                                                fill="none"
                                                                stroke={slice.color}
                                                                strokeWidth={strokeWidth}
                                                                strokeLinecap="round"
                                                                className="transition-all duration-700 ease-out"
                                                                style={{
                                                                    opacity: chartAnimate ? 1 : 0,
                                                                    transform: chartAnimate ? 'scale(1)' : 'scale(0.9)',
                                                                    transformOrigin: 'center',
                                                                    transitionDelay: `${idx * 120}ms`
                                                                }}
                                                            />
                                                        );
                                                    });
                                                })()}
                                            </svg>

                                            {/* Center Total - positioned at bottom center of the arc */}
                                            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 text-center">
                                                <div className="text-xs text-blue-500 font-bold mb-0">Total</div>
                                                <div className="text-2xl font-black text-slate-800 tracking-tight leading-none">${chartData.grandTotal.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                                                <div className="text-xs font-bold text-slate-400 mt-[-2px]">${chartData.subTotal.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                                            </div>
                                        </div>

                                        {/* Legend */}
                                        <div className="w-full mt-2 space-y-1 flex-1 overflow-y-auto max-h-[120px]">
                                            {/* Legend Headers (Optional but helpful given tight layout) */}
                                            {/* <div className="flex justify-between px-1 text-[9px] text-gray-400 uppercase tracking-widest font-bold mb-1">
                                                <span>Category</span>
                                                <div className="flex gap-4">
                                                    <span className="w-16 text-right">Sub</span>
                                                    <span className="w-16 text-right">Total</span>
                                                </div>
                                            </div> */}

                                            {chartData.slices.filter(s => s.value > 0).sort((a, b) => b.value - a.value).slice(0, 6).map(slice => {
                                                // Percent of Subtotal
                                                const percent = chartData.subTotal > 0 ? ((slice.value / chartData.subTotal) * 100).toFixed(1) : 0;
                                                const marginedValue = slice.value * (1 + (chartData.markupPct / 100));

                                                return (
                                                    <div key={slice.id} className="flex items-center justify-between py-1 px-1 hover:bg-white/50 rounded transition-colors group">
                                                        <div className="flex items-center gap-2 min-w-0">
                                                            <div className="w-2.5 h-2.5 rounded-sm shrink-0" style={{ backgroundColor: slice.color }}></div>
                                                            <span className="text-[11px] font-medium text-slate-600 truncate">{slice.label}</span>
                                                        </div>
                                                        <div className="flex items-center gap-1 shrink-0">
                                                            <span className="text-[10px] font-medium text-slate-400 w-10 text-right">{percent}%</span>
                                                            <span className="text-[11px] font-medium text-slate-500 w-16 text-right">${slice.value.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>
                                                            <span className="text-[11px] font-bold text-slate-800 w-16 text-right">${marginedValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* PART 4: Version History */}
                                    <div className="flex flex-col p-4 rounded-2xl bg-white/30 shadow-[inset_2px_2px_6px_#d1d9e6,inset_-2px_-2px_6px_#ffffff] overflow-hidden">
                                        <div className="flex items-center justify-between mb-4">
                                            <label className="text-sm font-bold text-slate-400 uppercase tracking-widest">Version History</label>
                                            {versionHistory.length > 0 && (
                                                <span className="text-[10px] bg-blue-100 text-blue-600 px-2.5 py-1 rounded-full font-bold">{versionHistory.length} versions</span>
                                            )}
                                        </div>

                                        <div className="space-y-3 flex-1 overflow-y-auto pr-1">
                                            {versionHistory.length > 0 ? (
                                                versionHistory.map((ver, idx) => {
                                                    const isLatest = idx === 0; // The most recent one created
                                                    const isCurrent = ver._id === estimate?._id; // The one currently being viewed

                                                    return (
                                                        <div key={ver._id} className={`group flex items-center gap-3 p-2 rounded-xl transition-colors cursor-pointer ${isCurrent ? 'bg-blue-50/80 shadow-sm border border-blue-100' : 'hover:bg-white/40 border border-transparent'}`} onClick={() => window.location.href = `view.html?id=${ver._id}`}>
                                                            <div className={`relative w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-md ${isCurrent ? 'bg-blue-600' : 'bg-slate-300'}`}>
                                                                V{ver.versionNumber}
                                                                {isCurrent && <span className="absolute w-full h-full rounded-full bg-blue-400/20 animate-ping"></span>}
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-2">
                                                                    <div className={`text-sm font-bold ${isCurrent ? 'text-blue-800' : 'text-slate-700'}`}>{ver.proposalNo || '0000'}-V.{ver.versionNumber}</div>
                                                                    {isLatest && <span className="px-1.5 py-0.5 bg-blue-500 text-white text-[9px] font-bold rounded-full uppercase tracking-wide">New</span>}
                                                                </div>
                                                                <div className="flex items-center gap-2 text-xs text-slate-400">
                                                                    <span>{new Date(ver.date).toLocaleDateString()}</span>
                                                                    <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                                                                    <span className={`font-bold ${isCurrent ? 'text-blue-600' : 'text-slate-500'}`}>${(ver.totalAmount || 0).toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>
                                                                </div>
                                                            </div>
                                                            {!isCurrent && (
                                                                <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <svg className="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                            ) : (
                                                <div className="text-center text-xs text-gray-400 py-4 italic">No history found</div>
                                            )}
                                        </div>
                                    </div>

                                </div >
                            </div >
                        </div >

                        {/* Accordion Line Items */}
                        < div className="w-full space-y-4 pb-20 md:px-8" >
                            {
                                sections.map(section => (
                                    <AccordionItem
                                        key={section.id}
                                        title={section.title}
                                        isOpen={openSections[section.id]}
                                        onToggle={() => toggleSection(section.id)}
                                        items={section.items || estimate[section.key] || []}
                                        onAdd={() => setActiveSection(section)}
                                        color={section.color}
                                        grandTotal={chartData.total}
                                    >
                                        <LineItemsTable
                                            sectionId={section.id}
                                            headers={section.headers}
                                            items={section.items || estimate[section.key] || []}
                                            fields={section.fields}
                                            editableFields={
                                                section.id === 'Labor' ? ['quantity', 'days', 'otPd', 'basePay'] :
                                                    section.id === 'Equipment' ? ['supplier', 'quantity', 'times', 'uom', 'dailyCost', 'weeklyCost', 'monthlyCost', 'fuelAdditiveCost'] :
                                                        section.id === 'Material' ? ['classification', 'subClassification', 'supplier', 'uom', 'cost', 'taxes', 'quantity'] :
                                                            section.id === 'Miscellaneous' ? ['classification', 'quantity', 'uom', 'cost'] :
                                                                section.id === 'Overhead' ? ['classification', 'subClassification', 'days', 'hourlyRate'] :
                                                                    section.id === 'Disposal' ? ['classification', 'subClassification', 'uom', 'quantity', 'cost'] :
                                                                        section.id === 'Subcontractor' ? ['classification', 'subClassification', 'subcontractor', 'quantity', 'uom', 'cost'] :
                                                                            []
                                            }
                                            onUpdateItem={(item, field, value) => handleItemUpdate(section, item, field, value)}
                                            onExplain={section.id === 'Labor' ? handleExplain : undefined}
                                            onDelete={(item) => handleDeleteItem(section, item)}
                                            suppliers={section.id === 'Equipment' ? uniqueEquipmentSuppliers : section.id === 'Material' ? uniqueMaterialSuppliers : []}
                                            uoms={section.id === 'Material' ? uniqueMaterialUOMs : []}
                                            miscClassifications={section.id === 'Miscellaneous' ? uniqueMiscClassifications : []}
                                            miscUoms={section.id === 'Miscellaneous' ? uniqueMiscUOMs : []}
                                            overheadClassifications={section.id === 'Overhead' ? uniqueOverheadClassifications : []}
                                            overheadSubClassifications={section.id === 'Overhead' ? uniqueOverheadSubClassifications : []}
                                            disposalClassifications={section.id === 'Disposal' ? uniqueDisposalClassifications : []}
                                            disposalUoms={section.id === 'Disposal' ? uniqueDisposalUOMs : []}
                                            subClassifications={section.id === 'Subcontractor' ? uniqueSubClassifications : []}
                                            subSubClassifications={section.id === 'Subcontractor' ? uniqueSubSubClassifications : []}
                                            subContractors={section.id === 'Subcontractor' ? uniqueSubContractors : []}
                                            subUoms={section.id === 'Subcontractor' ? uniqueSubUOMs : []}
                                        />
                                    </AccordionItem>
                                ))
                            }
                        </div >
                    </main >

                    <AddItemModal
                        isOpen={!!activeSection}
                        section={activeSection}
                        items={activeSection ? (activeSection.id === 'Labor' ? activeSection.items : (activeSection.id === 'Equipment' ? activeSection.items : (estimate[activeSection.key] || []))) : []}
                        catalog={activeSection ? (
                            activeSection.id === 'Labor' ? laborCatalog :
                                activeSection.id === 'Equipment' ? equipmentCatalog :
                                    activeSection.id === 'Material' ? materialCatalog : // Added Material Catalog
                                        activeSection.id === 'Miscellaneous' ? miscellaneousCatalog :
                                            activeSection.id === 'Overhead' ? overheadCatalog : // Added Overhead Catalog
                                                activeSection.id === 'Disposal' ? disposalCatalog :
                                                    activeSection.id === 'Subcontractor' ? subcontractorCatalog :
                                                        []
                        ) : []}
                        fringe={formData.fringe}
                        onClose={() => setActiveSection(null)}
                        onSave={handleSaveItem}
                        fringeConstants={fringeConstants} // Pass fringeConstants prop
                    />

                    <CalculationExplanationModal
                        isOpen={!!explanationItem}
                        item={explanationItem}
                        breakdown={breakdownData}
                        onClose={() => setExplanationItem(null)}
                    />

                    {/* Notifications & Modals */}
                    <ToastContainer toasts={toasts} removeToast={removeToast} />
                    <ConfirmModal
                        isOpen={confirmConfig.isOpen}
                        onClose={() => setConfirmConfig({ ...confirmConfig, isOpen: false })}
                        onConfirm={() => {
                            if (confirmConfig.onConfirm) confirmConfig.onConfirm();
                            setConfirmConfig({ ...confirmConfig, isOpen: false });
                        }}
                        title={confirmConfig.title}
                        message={confirmConfig.message}
                        confirmText="Delete"
                        variant="danger"
                    />
                </div >
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ViewApp />);
    </script>
</body>

</html>