<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devco | Estimate Details</title>
    <meta name="description" content="View and edit estimate details">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes modal {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-modal {
            animation: modal 0.2s ease-out;
        }
    </style>
</head>

<body class="font-sans bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" src="components.js"></script>

    <script type="text/babel">
        const { Header, Button, Card, Badge, Loading, EmptyState, Modal, Input } = window.DevcoComponents;

        // Service configurations
        const services = [
            { id: 'directionalDrilling', label: 'Directional Drilling', short: 'DD', color: 'emerald', icon: 'ðŸ”„' },
            { id: 'excavationBackfill', label: 'Excavation & Backfill', short: 'EB', color: 'blue', icon: 'ðŸ—ï¸' },
            { id: 'hydroExcavation', label: 'Hydro-excavation', short: 'HE', color: 'cyan', icon: 'ðŸ’§' },
            { id: 'potholingCoring', label: 'Potholing & Coring', short: 'PC', color: 'amber', icon: 'ðŸ•³ï¸' },
            { id: 'asphaltConcrete', label: 'Asphalt & Concrete', short: 'AC', color: 'orange', icon: 'ðŸ›£ï¸' }
        ];

        // Detail Field Component
        const DetailField = ({ label, value, className = '' }) => (
            <div className={className}>
                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">{label}</label>
                <p className="text-gray-900 font-medium">{value || '--'}</p>
            </div>
        );

        // Service Toggle Component
        const ServiceToggle = ({ service, isActive, onToggle, disabled }) => (
            <button
                onClick={() => !disabled && onToggle(service.id)}
                disabled={disabled}
                className={`p-4 rounded-xl border-2 transition-all duration-300 ${isActive
                        ? `bg-${service.color}-50 border-${service.color}-300 shadow-lg shadow-${service.color}-100`
                        : 'bg-gray-50 border-gray-200 hover:border-gray-300'
                    } ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:scale-[1.02]'}`}
                style={isActive ? {
                    backgroundColor: service.color === 'emerald' ? '#ecfdf5' :
                        service.color === 'blue' ? '#eff6ff' :
                            service.color === 'cyan' ? '#ecfeff' :
                                service.color === 'amber' ? '#fffbeb' :
                                    '#fff7ed',
                    borderColor: service.color === 'emerald' ? '#6ee7b7' :
                        service.color === 'blue' ? '#93c5fd' :
                            service.color === 'cyan' ? '#67e8f9' :
                                service.color === 'amber' ? '#fcd34d' :
                                    '#fdba74'
                } : {}}
            >
                <div className="text-2xl mb-2">{service.icon}</div>
                <div className={`text-sm font-semibold ${isActive ? 'text-gray-900' : 'text-gray-500'}`}>
                    {service.label}
                </div>
                <div className={`text-xs mt-1 ${isActive ? 'text-green-600' : 'text-gray-400'}`}>
                    {isActive ? 'âœ“ Active' : 'Inactive'}
                </div>
            </button>
        );

        // Main View App
        function ViewApp() {
            const [estimate, setEstimate] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [editing, setEditing] = React.useState(false);
            const [formData, setFormData] = React.useState({});
            const [saving, setSaving] = React.useState(false);

            const estimateId = new URLSearchParams(window.location.search).get('id');

            React.useEffect(() => {
                if (estimateId) {
                    loadEstimate();
                }
            }, [estimateId]);

            const loadEstimate = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getEstimateById',
                            payload: { id: estimateId }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        setEstimate(result.result);
                        setFormData(result.result);
                    }
                } catch (error) {
                    console.error('Error loading estimate:', error);
                }
                setLoading(false);
            };

            const saveEstimate = async () => {
                setSaving(true);
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateEstimate',
                            payload: { id: estimateId, ...formData }
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setEstimate(result.result.data);
                        setEditing(false);
                    } else {
                        alert('Error: ' + (result.error || 'Failed to save'));
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                    alert('Error saving estimate');
                }
                setSaving(false);
            };

            const toggleService = (serviceId) => {
                setFormData(prev => ({
                    ...prev,
                    [serviceId]: !prev[serviceId]
                }));
            };

            if (loading) {
                return (
                    <div className="min-h-screen">
                        <Header activePage="estimates" />
                        <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <Loading text="Loading estimate..." />
                        </main>
                    </div>
                );
            }

            if (!estimate) {
                return (
                    <div className="min-h-screen">
                        <Header activePage="estimates" />
                        <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <EmptyState
                                icon="âŒ"
                                title="Estimate not found"
                                message="The estimate you're looking for doesn't exist"
                                action={
                                    <Button onClick={() => window.location.href = 'index.html#estimates'}>
                                        Back to Estimates
                                    </Button>
                                }
                            />
                        </main>
                    </div>
                );
            }

            const data = editing ? formData : estimate;

            return (
                <div className="min-h-screen">
                    <Header activePage="estimates" />

                    <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Page Header */}
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => window.location.href = 'index.html#estimates'}
                                    className="p-2 hover:bg-gray-100 rounded-xl transition-colors"
                                >
                                    <svg className="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                        <path d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">
                                        Estimate #{estimate.proposalNo || estimate.estimate || 'N/A'}
                                    </h1>
                                    <p className="text-gray-500 text-sm mt-1">
                                        {estimate.customerName || 'Unknown Customer'}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {editing ? (
                                    <>
                                        <Button variant="secondary" onClick={() => {
                                            setFormData(estimate);
                                            setEditing(false);
                                        }}>
                                            Cancel
                                        </Button>
                                        <Button onClick={saveEstimate} disabled={saving}>
                                            {saving ? 'Saving...' : 'Save Changes'}
                                        </Button>
                                    </>
                                ) : (
                                    <Button onClick={() => setEditing(true)}>
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Edit
                                    </Button>
                                )}
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Column - Details */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* Customer Info */}
                                <Card className="p-6">
                                    <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                        <span className="text-xl">ðŸ‘¤</span>
                                        Customer Information
                                    </h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        {editing ? (
                                            <>
                                                <Input
                                                    label="Customer Name"
                                                    value={formData.customerName || ''}
                                                    onChange={(e) => setFormData({ ...formData, customerName: e.target.value })}
                                                />
                                                <Input
                                                    label="Customer ID"
                                                    value={formData.customerId || ''}
                                                    onChange={(e) => setFormData({ ...formData, customerId: e.target.value })}
                                                />
                                            </>
                                        ) : (
                                            <>
                                                <DetailField label="Customer Name" value={data.customerName} />
                                                <DetailField label="Customer ID" value={data.customerId} />
                                            </>
                                        )}
                                    </div>
                                </Card>

                                {/* Estimate Info */}
                                <Card className="p-6">
                                    <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                        <span className="text-xl">ðŸ“‹</span>
                                        Estimate Details
                                    </h2>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {editing ? (
                                            <>
                                                <Input
                                                    label="Estimate #"
                                                    value={formData.estimate || ''}
                                                    onChange={(e) => setFormData({ ...formData, estimate: e.target.value })}
                                                />
                                                <Input
                                                    label="Proposal No"
                                                    value={formData.proposalNo || ''}
                                                    onChange={(e) => setFormData({ ...formData, proposalNo: e.target.value })}
                                                />
                                                <Input
                                                    label="Date"
                                                    value={formData.date || ''}
                                                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                                />
                                                <Input
                                                    label="Bid Markup"
                                                    value={formData.bidMarkUp || ''}
                                                    onChange={(e) => setFormData({ ...formData, bidMarkUp: e.target.value })}
                                                />
                                            </>
                                        ) : (
                                            <>
                                                <DetailField label="Estimate #" value={data.estimate} />
                                                <DetailField label="Proposal No" value={data.proposalNo} />
                                                <DetailField label="Date" value={data.date} />
                                                <DetailField label="Bid Markup" value={data.bidMarkUp} />
                                            </>
                                        )}
                                    </div>
                                </Card>

                                {/* Services */}
                                <Card className="p-6">
                                    <h2 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                        <span className="text-xl">âš¡</span>
                                        Services
                                    </h2>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                        {services.map(service => (
                                            <ServiceToggle
                                                key={service.id}
                                                service={service}
                                                isActive={data[service.id]}
                                                onToggle={toggleService}
                                                disabled={!editing}
                                            />
                                        ))}
                                    </div>
                                </Card>
                            </div>

                            {/* Right Column - Summary */}
                            <div className="space-y-6">
                                {/* Quick Info */}
                                <Card className="p-6 bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                                    <h3 className="font-semibold text-white/80 mb-4">Quick Summary</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <div className="text-white/60 text-xs uppercase tracking-wider">Status</div>
                                            <div className="text-lg font-bold">Active</div>
                                        </div>
                                        <div>
                                            <div className="text-white/60 text-xs uppercase tracking-wider">Fringe</div>
                                            <div className="text-lg font-bold">{data.fringe || 'Not set'}</div>
                                        </div>
                                        <div>
                                            <div className="text-white/60 text-xs uppercase tracking-wider">Active Services</div>
                                            <div className="text-lg font-bold">
                                                {services.filter(s => data[s.id]).length} / {services.length}
                                            </div>
                                        </div>
                                    </div>
                                </Card>

                                {/* Fringe */}
                                {editing && (
                                    <Card className="p-6">
                                        <h3 className="font-semibold text-gray-900 mb-4">Settings</h3>
                                        <Input
                                            label="Fringe"
                                            value={formData.fringe || ''}
                                            onChange={(e) => setFormData({ ...formData, fringe: e.target.value })}
                                        />
                                    </Card>
                                )}

                                {/* Timestamps */}
                                <Card className="p-6">
                                    <h3 className="font-semibold text-gray-900 mb-4">Activity</h3>
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">Created</span>
                                            <span className="text-gray-900">
                                                {estimate.createdAt ? new Date(estimate.createdAt).toLocaleDateString() : '--'}
                                            </span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">Updated</span>
                                            <span className="text-gray-900">
                                                {estimate.updatedAt ? new Date(estimate.updatedAt).toLocaleDateString() : '--'}
                                            </span>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ViewApp />);
    </script>
</body>

</html>