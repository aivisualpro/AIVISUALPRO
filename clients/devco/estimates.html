<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devco | Estimates</title>
    <script>
        (function () {
            if (!localStorage.getItem('devco_session_valid')) {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
            }
        })();
    </script>
    <link rel="icon" type="image/png" href="devco-logo.png">
    <meta name="description" content="View and manage all estimates">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Lato', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes modal {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-modal {
            animation: modal 0.2s ease-out;
        }
    </style>
</head>

<body class="font-sans bg-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel" src="components.js"></script>

    <script type="text/babel">
        const { Header, Badge, Loading, EmptyState, Pagination, StatusTabs } = window.DevcoComponents;

        function EstimatesApp() {
            const [estimates, setEstimates] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [search, setSearch] = React.useState('');
            const [sortField, setSortField] = React.useState('date');
            const [sortDirection, setSortDirection] = React.useState('desc');
            const [currentPage, setCurrentPage] = React.useState(1);
            const [activeFilter, setActiveFilter] = React.useState('all');
            const itemsPerPage = 15;

            React.useEffect(() => {
                loadEstimates();
            }, []);

            const loadEstimates = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getEstimates' })
                    });
                    const result = await response.json();
                    setEstimates(result.success && result.result ? result.result : []);
                } catch (error) {
                    console.error('Error loading estimates:', error);
                    setEstimates([]);
                }
                setLoading(false);
            };

            // Date filter helpers
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const isCurrentMonth = (dateStr) => {
                if (!dateStr) return false;
                const d = new Date(dateStr);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            };

            const isLastMonth = (dateStr) => {
                if (!dateStr) return false;
                const d = new Date(dateStr);
                return d.getMonth() === lastMonth && d.getFullYear() === lastMonthYear;
            };

            const isThisYear = (dateStr) => {
                if (!dateStr) return false;
                const d = new Date(dateStr);
                return d.getFullYear() === currentYear;
            };

            // Calculate counts for tabs
            const tabCounts = {
                all: estimates.length,
                currentMonth: estimates.filter(e => isCurrentMonth(e.date)).length,
                lastMonth: estimates.filter(e => isLastMonth(e.date)).length,
                thisYear: estimates.filter(e => isThisYear(e.date)).length,
                confirmed: estimates.filter(e => e.status === 'confirmed').length,
                draft: estimates.filter(e => e.status === 'draft' || !e.status).length
            };

            const filterTabs = [
                { id: 'all', label: 'All', count: tabCounts.all },
                { id: 'currentMonth', label: 'Current Month', count: tabCounts.currentMonth },
                { id: 'lastMonth', label: 'Last Month', count: tabCounts.lastMonth },
                { id: 'thisYear', label: 'This Year', count: tabCounts.thisYear },
                { id: 'confirmed', label: 'Confirmed', count: tabCounts.confirmed },
                { id: 'draft', label: 'Draft', count: tabCounts.draft }
            ];

            // Apply active filter
            const filterByTab = (items) => {
                switch (activeFilter) {
                    case 'currentMonth': return items.filter(e => isCurrentMonth(e.date));
                    case 'lastMonth': return items.filter(e => isLastMonth(e.date));
                    case 'thisYear': return items.filter(e => isThisYear(e.date));
                    case 'confirmed': return items.filter(e => e.status === 'confirmed');
                    case 'draft': return items.filter(e => e.status === 'draft' || !e.status);
                    default: return items;
                }
            };

            const filteredEstimates = filterByTab(estimates.filter(e =>
                (e.proposalNo || '').toLowerCase().includes(search.toLowerCase()) ||
                (e.customerName || '').toLowerCase().includes(search.toLowerCase()) ||
                (e.estimate || '').toLowerCase().includes(search.toLowerCase())
            ));

            const handleSort = (field) => {
                if (sortField === field) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortDirection('desc'); // Default to desc for new field usually better for dates/ids
                }
            };

            const sortedEstimates = [...filteredEstimates].sort((a, b) => {
                let aValue = a[sortField] || '';
                let bValue = b[sortField] || '';

                // Handle date sorting
                if (sortField === 'date') {
                    aValue = new Date(aValue).getTime();
                    bValue = new Date(bValue).getTime();
                }

                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination
            const totalPages = Math.ceil(sortedEstimates.length / itemsPerPage);
            const paginatedEstimates = sortedEstimates.slice(
                (currentPage - 1) * itemsPerPage,
                currentPage * itemsPerPage
            );

            const ServiceBadges = ({ estimate }) => {
                const services = [];
                if (estimate.directionalDrilling) services.push({ label: 'DD', variant: 'success' });
                if (estimate.excavationBackfill) services.push({ label: 'EB', variant: 'info' });
                if (estimate.hydroExcavation) services.push({ label: 'HE', variant: 'purple' });
                if (estimate.potholingCoring) services.push({ label: 'PC', variant: 'warning' });
                if (estimate.asphaltConcrete) services.push({ label: 'AC', variant: 'danger' });

                if (services.length === 0) {
                    return <span className="text-gray-400 text-xs">None</span>;
                }

                return (
                    <div className="flex flex-wrap gap-1">
                        {services.map(s => (
                            <Badge key={s.label} variant={s.variant}>{s.label}</Badge>
                        ))}
                    </div>
                );
            };

            const handleCreate = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'createEstimate' })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        window.location.href = `view.html?id=${result.result.id}`;
                    } else {
                        alert('Failed to create estimate');
                        setLoading(false);
                    }
                } catch (error) {
                    console.error('Error creating estimate:', error);
                    alert('Error creating estimate');
                    setLoading(false);
                }
            };

            const handleDelete = async (id, e) => {
                if (e) e.stopPropagation();
                if (!confirm('Are you sure you want to delete this estimate?')) return;

                const originalEstimates = [...estimates];
                // Optimistic update
                setEstimates(prev => prev.filter(e => e._id !== id));

                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'deleteEstimateFromAppSheet',
                            payload: { estimateId: id }
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Failed');
                    }
                } catch (error) {
                    console.error('Error deleting:', error);
                    alert('Failed to delete estimate');
                    setEstimates(originalEstimates); // Revert
                }
            };

            return (
                <div className="h-screen w-screen flex flex-col overflow-hidden" style={{ background: '#f0f2f5' }}>
                    <Header
                        activePage="estimates"
                        rightContent={<>
                            <div className="relative flex items-center">
                                <input
                                    type="text"
                                    value={search}
                                    onChange={(e) => { setSearch(e.target.value); setCurrentPage(1); }}
                                    placeholder="Search for ..."
                                    className="w-56 h-10 px-4 pl-10 text-sm text-gray-600 placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-200 transition-all duration-200 border border-gray-200"
                                    style={{ background: '#ffffff' }}
                                />
                                <svg className="absolute left-3 w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.3-4.3"></path>
                                </svg>
                            </div>
                            <button
                                onClick={handleCreate}
                                className="h-10 px-4 text-sm font-medium text-gray-700 rounded-xl transition-all duration-200 flex items-center gap-2 border border-gray-200 hover:bg-gray-50"
                                style={{ background: '#ffffff' }}
                            >
                                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M12 5v14"></path>
                                    <path d="M5 12h14"></path>
                                </svg>
                                Add Estimate
                            </button>
                        </>}
                    />

                    <main className="flex-1 flex flex-col overflow-hidden">
                        {/* Filter Tabs */}
                        <div className="flex-shrink-0 px-4" style={{ background: '#f0f2f5' }}>
                            <StatusTabs tabs={filterTabs} activeTab={activeFilter} onChange={(id) => { setActiveFilter(id); setCurrentPage(1); }} />
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 flex flex-col overflow-hidden bg-white">


                            {loading ? (
                                <Loading text="Loading estimates..." />
                            ) : filteredEstimates.length === 0 ? (
                                <EmptyState
                                    icon="ðŸ“‹"
                                    title="No estimates found"
                                    message="Estimates will appear here when synced from AppSheet"
                                />
                            ) : (
                                <div className="flex-1 overflow-auto px-4" style={{ background: '#f9fafb' }}>
                                    <table className="w-full" style={{ background: '#ffffff' }}>
                                        <thead className="border-b border-gray-200 sticky top-0 z-10" style={{ background: '#f9fafb' }}>
                                            <tr>
                                                <th className="px-4 py-1 text-left text-[11px] font-medium text-gray-500 uppercase tracking-wider w-14">S.No</th>
                                                {[
                                                    { id: 'proposalNo', label: 'Proposal No' },
                                                    { id: 'estimate', label: 'Estimate #' },
                                                    { id: 'customerName', label: 'Customer' },
                                                    { id: 'date', label: 'Date' },
                                                    { id: 'bidMarkUp', label: 'Bid Markup' }
                                                ].map(col => (
                                                    <th
                                                        key={col.id}
                                                        className="px-4 py-1 text-left text-[11px] font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer hover:bg-white select-none transition-colors"
                                                        onClick={() => handleSort(col.id)}
                                                    >
                                                        <div className="flex items-center gap-1">
                                                            {col.label}
                                                            {sortField === col.id && (
                                                                <svg className="w-3.5 h-3.5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                                                                    {sortDirection === 'asc'
                                                                        ? <path d="m18 15-6-6-6 6"></path>
                                                                        : <path d="m6 9 6 6 6-6"></path>
                                                                    }
                                                                </svg>
                                                            )}
                                                        </div>
                                                    </th>
                                                ))}
                                                <th className="px-4 py-1 text-left text-[11px] font-medium text-gray-500 uppercase tracking-wider">Services</th>
                                                <th className="px-4 py-1 text-right text-[11px] font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100" style={{ background: '#ffffff' }}>
                                            {paginatedEstimates.map((estimate, index) => (
                                                <tr
                                                    key={estimate._id}
                                                    className="hover:bg-gray-50/50 transition-colors cursor-pointer"
                                                    onClick={() => window.location.href = `view.html?id=${estimate._id}`}
                                                >
                                                    <td className="px-4 py-1 text-xs text-gray-400 whitespace-nowrap font-medium">
                                                        {(currentPage - 1) * itemsPerPage + index + 1}
                                                    </td>
                                                    <td className="px-4 py-1 text-xs whitespace-nowrap">
                                                        <span className="font-medium text-gray-900">
                                                            {estimate.proposalNo || '--'}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-1 text-xs text-gray-600 whitespace-nowrap">
                                                        {estimate.estimate || '--'}
                                                    </td>
                                                    <td className="px-4 py-1 text-xs text-gray-600 whitespace-nowrap">{estimate.customerName || '--'}</td>
                                                    <td className="px-4 py-1 text-xs text-gray-600 whitespace-nowrap">{estimate.date || '--'}</td>
                                                    <td className="px-4 py-1 text-xs whitespace-nowrap">
                                                        <Badge variant="info">{estimate.bidMarkUp || '--'}</Badge>
                                                    </td>
                                                    <td className="px-4 py-1 text-xs whitespace-nowrap">
                                                        <ServiceBadges estimate={estimate} />
                                                    </td>
                                                    <td className="px-4 py-1 text-right">
                                                        <div className="flex items-center justify-end gap-2">
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    window.location.href = `view.html?id=${estimate._id}`;
                                                                }}
                                                                className="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-lg border border-transparent hover:border-gray-200 transition-all"
                                                                title="View"
                                                            >
                                                                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                                                    <circle cx="12" cy="12" r="3"></circle>
                                                                </svg>
                                                            </button>
                                                            <button
                                                                onClick={(e) => handleDelete(estimate._id, e)}
                                                                className="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg border border-transparent hover:border-red-200 transition-all"
                                                                title="Delete"
                                                            >
                                                                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                    <path d="M3 6h18"></path>
                                                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            {/* Pagination */}
                            {!loading && filteredEstimates.length > 0 && totalPages > 1 && (
                                <Pagination
                                    currentPage={currentPage}
                                    totalPages={totalPages}
                                    onPageChange={setCurrentPage}
                                />
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EstimatesApp />);
    </script>
</body>

</html>