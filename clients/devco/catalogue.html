<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devco | Catalogue</title>
    <link rel="icon" type="image/png" href="devco-logo.png">
    <meta name="description" content="Manage catalogue items - Equipment, Labor, Materials and more">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Lato', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes modal {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-modal {
            animation: modal 0.2s ease-out;
        }
    </style>
</head>

<body class="font-sans bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" src="components.js"></script>

    <script type="text/babel">
        const { Header, Button, Card, Table, TableHead, TableBody, TableRow, TableHeader, TableCell, Badge, Loading, EmptyState, Modal, ConfirmModal, Input, SearchInput, StatusTabs, Pagination, ActionDropdown, IconButton, Toast, ToastContainer } = window.DevcoComponents;

        // Initialize Lucide Icons
        React.useEffect && lucide.createIcons();

        // Icon Component using Lucide
        const Icon = ({ name, size = 16, className = '' }) => {
            const iconRef = React.useRef(null);

            React.useEffect(() => {
                if (iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconRef.current.appendChild(iconElement);
                    lucide.createIcons({ icons: { [name]: lucide.icons[name] }, attrs: { 'stroke-width': 2 } });
                }
            }, [name]);

            return <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }} />;
        };

        // Main Catalogue App
        function CatalogueApp() {
            const [category, setCategory] = React.useState('equipment');
            const [items, setItems] = React.useState([]);
            const [allCounts, setAllCounts] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [search, setSearch] = React.useState('');
            const [sortField, setSortField] = React.useState('createdAt');
            const [sortDirection, setSortDirection] = React.useState('asc'); // asc = oldest first
            const [modalOpen, setModalOpen] = React.useState(false);
            const [editingItem, setEditingItem] = React.useState(null);
            const [formData, setFormData] = React.useState({});
            const [currentPage, setCurrentPage] = React.useState(1);
            const itemsPerPage = 10;
            const [toasts, setToasts] = React.useState([]);

            // Fringe Constants State
            const [fringeConstants, setFringeConstants] = React.useState([]);
            const [showFringeValuePrompt, setShowFringeValuePrompt] = React.useState(false);
            const [pendingFringeName, setPendingFringeName] = React.useState('');
            const [newFringeValue, setNewFringeValue] = React.useState('');

            // Helper to get fringe value
            const getFringeRate = (fringeDescription) => {
                if (!fringeDescription) return 0;
                const constant = fringeConstants.find(c => c.description === fringeDescription);
                if (!constant || !constant.value) return 0;
                // Value is stored as currency string "$12.50", parse it
                return parseFloat(String(constant.value).replace(/[^0-9.-]+/g, "")) || 0;
            };

            // Category display names
            const categoryNames = {
                equipment: 'Equipment',
                labor: 'Labor',
                overhead: 'Overhead',
                subcontractor: 'Subcontractor',
                disposal: 'Disposal',
                material: 'Material',
                miscellaneous: 'Miscellaneous',
                tool: 'Tool',
                estimateLineItemsLabor: 'Est. Labor'
            };

            // Fields that should use searchable dropdowns
            const dropdownFields = ['classification', 'subClassification', 'supplier', 'fringe', 'uom'];

            const categoryConfig = {
                equipment: {
                    title: 'Equipment Items',
                    headers: ['Equipment / Machine', 'Classification', 'Sub Classification', 'Supplier', 'Daily Cost', 'Weekly Cost', 'Monthly Cost', 'Fuel Additive'],
                    fields: ['equipmentMachine', 'classification', 'subClassification', 'supplier', 'dailyCost', 'weeklyCost', 'monthlyCost', 'fuelAdditiveCost'],
                    fieldTypes: { dailyCost: 'number', weeklyCost: 'number', monthlyCost: 'number', fuelAdditiveCost: 'number' }
                },
                labor: {
                    title: 'Labor Items',
                    headers: ['Labor', 'Classification', 'Sub Classification', 'Fringe', 'UOM', 'Cost', 'W Comp %', 'Payroll Tax %'],
                    fields: ['_labor', 'classification', 'subClassification', 'fringe', 'uom', 'cost', 'wCompPercent', 'payrollTaxesPercent'],
                    fieldTypes: { cost: 'number', wCompPercent: 'number', payrollTaxesPercent: 'number' },
                    computedFields: {
                        _labor: (item) => `${item.classification || ''}${item.classification && item.fringe ? '-' : ''}${item.fringe || ''}`
                    }
                },
                overhead: {
                    title: 'Overhead Items',
                    headers: ['Overhead', 'Classification', 'Sub Classification', 'UOM', 'Days', 'Hours', 'Hourly Rate', 'Daily Rate'],
                    fields: ['overhead', 'classification', 'subClassification', 'uom', 'days', 'hours', 'hourlyRate', 'dailyRate'],
                    fieldTypes: { days: 'number', hours: 'number', hourlyRate: 'number', dailyRate: 'number' }
                },
                subcontractor: {
                    title: 'Subcontractor Items',
                    headers: ['Subcontractor', 'Classification', 'Sub Classification', 'UOM', 'Notes', 'Cost'],
                    fields: ['subcontractor', 'classification', 'subClassification', 'uom', 'notes', 'cost'],
                    fieldTypes: { cost: 'number' }
                },
                disposal: {
                    title: 'Disposal Items',
                    headers: ['Disposal And Haul OFF', 'Classification', 'Sub Classification', 'UOM', 'Quantity', 'Cost'],
                    fields: ['disposalAndHaulOff', 'classification', 'subClassification', 'uom', 'quantity', 'cost'],
                    fieldTypes: { quantity: 'number', cost: 'number' }
                },
                material: {
                    title: 'Material Items',
                    headers: ['Material', 'Classification', 'Sub Classification', 'UOM', 'Supplier', 'Cost', 'Quantity', 'Taxes'],
                    fields: ['material', 'classification', 'subClassification', 'uom', 'supplier', 'cost', 'quantity', 'taxes'],
                    fieldTypes: { cost: 'number', quantity: 'number', taxes: 'number' }
                },
                miscellaneous: {
                    title: 'Miscellaneous Items',
                    headers: ['Item', 'Classification', 'Sub Classification', 'UOM', 'Quantity', 'Cost'],
                    fields: ['item', 'classification', 'subClassification', 'uom', 'quantity', 'cost'],
                    fieldTypes: { quantity: 'number', cost: 'number' }
                },
                tool: {
                    title: 'Tool Items',
                    headers: ['Tool', 'Classification', 'Sub Classification', 'UOM', 'Supplier', 'Cost', 'Quantity', 'Taxes'],
                    fields: ['tool', 'classification', 'subClassification', 'uom', 'supplier', 'cost', 'quantity', 'taxes'],
                    fieldTypes: { cost: 'number', quantity: 'number', taxes: 'number' }
                },
                estimateLineItemsLabor: {
                    title: 'Estimate Line Items (Labor)',
                    headers: ['Labor', 'Classification', 'Sub Classification', 'Fringe', 'Base Pay', 'Quantity', 'Days', 'OT PD', 'W.Comp %', 'Payroll Tax %', 'Total'],
                    fields: ['_labor', 'classification', 'subClassification', 'fringe', 'basePay', 'quantity', 'days', 'otPd', 'wCompPercent', 'payrollTaxesPercent', '_total'],
                    fieldTypes: {
                        basePay: 'number', quantity: 'number', days: 'number', otPd: 'number', wCompPercent: 'number', payrollTaxesPercent: 'number'
                    },
                    computedFields: {
                        _labor: (item) => `${item.classification || ''}${item.classification && item.fringe ? '-' : ''}${item.fringe || ''}`,
                        _total: (item) => {
                            const parseNum = (val) => parseFloat(String(val).replace(/[^0-9.-]+/g, "")) || 0;
                            const subClass = (item.subClassification || '').toLowerCase();
                            const basePay = parseNum(item.basePay);
                            const qty = parseNum(item.quantity);
                            const days = parseNum(item.days);
                            const otPd = parseNum(item.otPd);
                            const wCompPct = parseNum(item.wCompPercent);
                            const taxesPct = parseNum(item.payrollTaxesPercent);

                            if (subClass === 'per diem' || subClass === 'hotel') {
                                return basePay * qty * days;
                            }

                            const totalHours = qty * 8 * days;

                            if (totalHours > 0) {
                                const regularPay = totalHours * basePay;
                                const wComp = regularPay * (wCompPct / 100);
                                const taxes = regularPay * (taxesPct / 100);
                                const fringeRate = getFringeRate(item.fringe);
                                const fringe = totalHours * fringeRate;
                                const otHours = qty * days * otPd;
                                const otPay = otHours * (basePay * 1.5); // Standard OT Rate Assumption
                                return regularPay + wComp + taxes + fringe + otPay;
                            } else {
                                return qty * basePay;
                            }
                        }
                    }
                }
            };

            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            const [deleteId, setDeleteId] = React.useState(null);

            const confirmDelete = async () => {
                if (!deleteId) return;
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'deleteCatalogueItem',
                            payload: { type: category, id: deleteId }
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        loadItems();
                        addToast('Item deleted successfully', 'success');
                    } else {
                        addToast('Failed to delete item', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting:', error);
                    addToast('Error deleting item', 'error');
                }
                setDeleteId(null);
            };

            // Fringe Constants Logic


            const config = categoryConfig[category];

            // Close modal on Escape key press
            React.useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape' && modalOpen) {
                        setModalOpen(false);
                    }
                };
                document.addEventListener('keydown', handleEscape);
                return () => document.removeEventListener('keydown', handleEscape);
            }, [modalOpen]);

            // Get unique values for dropdown fields from existing items
            const getOptionsForField = (field) => {
                const values = items
                    .map(item => item[field])
                    .filter(Boolean)
                    .filter((v, i, arr) => arr.indexOf(v) === i)
                    .sort();
                return values;
            };

            // Load all category counts on mount
            React.useEffect(() => {
                loadAllCounts();
            }, []);

            // Load items when category changes
            React.useEffect(() => {
                loadItems();
                setCurrentPage(1);

                // Load Fringe Constants if category is labor or estimateLineItemsLabor
                if (category === 'labor' || category === 'estimateLineItemsLabor') {
                    loadFringeConstants();
                }
            }, [category]);

            const loadFringeConstants = async () => {
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: 'constant' }
                        })
                    });
                    const result = await response.json();
                    if (result.success && result.result) {
                        // Filter for type 'Fringe'
                        const fringes = result.result.filter(c => c.type === 'Fringe');
                        setFringeConstants(fringes);
                    }
                } catch (e) {
                    console.error("Error loading fringe constants", e);
                }
            };

            const handleFringeChange = (val) => {
                // Check if existing constant
                const existing = fringeConstants.find(c => c.description === val);
                if (existing) {
                    setFormData({ ...formData, fringe: val });
                } else {
                    // New Fringe - prompt for value
                    setPendingFringeName(val);
                    setNewFringeValue('');
                    setShowFringeValuePrompt(true);
                }
            };

            const handleSaveNewFringe = async () => {
                if (!newFringeValue) {
                    addToast("Please enter a value", 'warning');
                    return;
                }

                // Format value as currency
                let formattedValue = newFringeValue;
                const num = parseFloat(newFringeValue.replace(/[^0-9.-]+/g, ""));
                if (!isNaN(num)) {
                    formattedValue = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(num);
                }

                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'addCatalogueItem',
                            payload: {
                                type: 'constant',
                                data: {
                                    description: pendingFringeName,
                                    type: 'Fringe',
                                    value: formattedValue
                                }
                            }
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        await loadFringeConstants();
                        setFormData({ ...formData, fringe: pendingFringeName });
                        setShowFringeValuePrompt(false);
                        addToast("New fringe constant saved", 'success');
                    } else {
                        addToast("Failed to save constant: " + result.error, 'error');
                    }
                } catch (e) {
                    console.error("Error saving new fringe", e);
                    addToast("Failed to save constant", 'error');
                }
            };

            const loadAllCounts = async () => {
                const counts = {};
                for (const cat of Object.keys(categoryConfig)) {
                    try {
                        const response = await fetch('/webhook/devcoBackend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'getCatalogueItems', payload: { type: cat } })
                        });
                        const result = await response.json();
                        counts[cat] = result.success && result.result ? result.result.length : 0;
                    } catch (e) {
                        counts[cat] = 0;
                    }
                }
                setAllCounts(counts);
            };

            const loadItems = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getCatalogueItems',
                            payload: { type: category }
                        })
                    });
                    const result = await response.json();
                    const loadedItems = result.success && result.result ? result.result : [];
                    setItems(loadedItems);
                    setAllCounts(prev => ({ ...prev, [category]: loadedItems.length }));
                } catch (error) {
                    console.error('Error loading items:', error);
                    setItems([]);
                }
                setLoading(false);
            };

            // Filter items by search
            const filteredItems = items.filter(item =>
                config.fields.some(field => {
                    const value = field.startsWith('_') && config.computedFields?.[field]
                        ? config.computedFields[field](item)
                        : item[field];
                    return String(value ?? '').toLowerCase().includes(search.toLowerCase());
                })
            );

            // Sort items
            const sortedItems = [...filteredItems].sort((a, b) => {
                let valueA, valueB;

                // Handle computed fields
                if (sortField.startsWith('_') && config.computedFields?.[sortField]) {
                    valueA = config.computedFields[sortField](a);
                    valueB = config.computedFields[sortField](b);
                } else {
                    valueA = a[sortField];
                    valueB = b[sortField];
                }

                // Handle dates
                if (sortField === 'createdAt' || sortField === 'updatedAt') {
                    valueA = new Date(valueA || 0);
                    valueB = new Date(valueB || 0);
                    return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
                }

                // Handle numbers
                if (typeof valueA === 'number' && typeof valueB === 'number') {
                    return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
                }

                // Handle strings
                const strA = String(valueA || '').toLowerCase();
                const strB = String(valueB || '').toLowerCase();
                const comparison = strA.localeCompare(strB);
                return sortDirection === 'asc' ? comparison : -comparison;
            });

            // Toggle sort for a field
            const handleSort = (field) => {
                if (sortField === field) {
                    // Toggle direction
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    // New field, default to ascending
                    setSortField(field);
                    setSortDirection('asc');
                }
                setCurrentPage(1);
            };

            // Pagination
            const totalPages = Math.ceil(sortedItems.length / itemsPerPage);
            const paginatedItems = sortedItems.slice(
                (currentPage - 1) * itemsPerPage,
                currentPage * itemsPerPage
            );

            // Category tabs with counts
            const categoryTabs = [
                { id: 'equipment', label: 'Equipment', count: allCounts.equipment || 0 },
                { id: 'labor', label: 'Labor', count: allCounts.labor || 0 },
                { id: 'overhead', label: 'Overhead', count: allCounts.overhead || 0 },
                { id: 'subcontractor', label: 'Subcontractor', count: allCounts.subcontractor || 0 },
                { id: 'disposal', label: 'Disposal', count: allCounts.disposal || 0 },
                { id: 'material', label: 'Material', count: allCounts.material || 0 },
                { id: 'miscellaneous', label: 'Miscellaneous', count: allCounts.miscellaneous || 0 },
                { id: 'tool', label: 'Tools', count: allCounts.tool || 0 }
            ];

            // Open add modal
            const openAddModal = () => {
                setEditingItem(null);
                // Set defaults for labor category
                if (category === 'labor') {
                    setFormData({
                        uom: 'Hourly',
                        wCompPercent: 12,
                        payrollTaxesPercent: 16
                    });
                } else {
                    setFormData({});
                }
                setModalOpen(true);
            };

            // Open edit modal
            const openEditModal = (item) => {
                setEditingItem(item);
                setFormData({ ...item });
                setModalOpen(true);
            };

            // Save item
            const saveItem = async () => {
                // Convert number fields from strings to actual numbers
                const processedData = { ...formData };
                if (config.fieldTypes) {
                    Object.keys(config.fieldTypes).forEach(field => {
                        if (config.fieldTypes[field] === 'number' && processedData[field] !== undefined) {
                            processedData[field] = parseFloat(processedData[field]) || 0;
                        }
                    });
                }

                const action = editingItem ? 'updateCatalogueItem' : 'addCatalogueItem';
                const payload = editingItem
                    ? { type: category, id: editingItem._id, data: processedData }
                    : { type: category, data: processedData };

                try {
                    const response = await fetch('/webhook/devcoBackend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, payload })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setModalOpen(false);
                        loadItems();
                        addToast(`Item ${editingItem ? 'updated' : 'added'} successfully`, 'success');
                    } else {
                        addToast('Error: ' + (result.error || 'Failed to save'), 'error');
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                    addToast('Error saving item', 'error');
                }
            };

            // Delete item
            const deleteItem = (id) => {
                setDeleteId(id);
            };

            return (
                <div className="h-screen w-screen flex flex-col bg-white overflow-hidden">
                    <ToastContainer toasts={toasts} removeToast={removeToast} />
                    <ConfirmModal
                        isOpen={!!deleteId}
                        onClose={() => setDeleteId(null)}
                        onConfirm={confirmDelete}
                        title="Delete Item"
                        message="Are you sure you want to delete this item? This action cannot be undone."
                        confirmText="Delete"
                    />
                    <Header activePage="catalogue" rightContent={<>
                        <div className="relative flex items-center">
                            <input type="text" value={search} onChange={(e) => {
                                setSearch(e.target.value);
                                setCurrentPage(1);
                            }}
                                placeholder="Search for ..."
                                className="w-56 h-10 px-4 pl-10 text-sm text-gray-600 placeholder-gray-400 rounded-xl
                            focus:outline-none focus:ring-2 focus:ring-gray-200 transition-all duration-200 border
                            border-gray-200"
                                style={{ background: '#ffffff' }}
                            />
                            <svg className="absolute left-3 w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.3-4.3"></path>
                            </svg>
                        </div>
                        <button onClick={openAddModal}
                            className="h-10 px-4 text-sm font-medium text-gray-700 rounded-xl transition-all duration-200 flex items-center gap-2 border border-gray-200 hover:bg-gray-50"
                            style={{ background: '#ffffff' }}>
                            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M12 5v14"></path>
                                <path d="M5 12h14"></path>
                            </svg>
                            Add {categoryNames[category]}
                        </button>
                    </>
                    }
                    />

                    <main className="flex-1 flex flex-col overflow-hidden">
                        {/* Category Tabs */}
                        <div className="flex-shrink-0 px-6" style={{ background: '#f0f2f5' }}>
                            <StatusTabs tabs={categoryTabs} activeTab={category} onChange={setCategory} />
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 flex flex-col overflow-hidden bg-white">

                            {/* Table */}
                            {loading ? (
                                <Loading text="Loading items..." />
                            ) : sortedItems.length === 0 ? (
                                <EmptyState icon="ðŸ“¦" title="No items found"
                                    message="Add your first item to get started" action={<button onClick={openAddModal}
                                        className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                                        + Add Item
                                    </button>
                                    }
                                />
                            ) : (
                                <div className="flex-1 flex flex-col overflow-hidden">
                                    <div className="flex-1 overflow-auto" style={{ background: '#f9fafb' }}>
                                        <table className="w-full" style={{ background: '#ffffff' }}>
                                            <thead className="border-b border-gray-200 sticky top-0 z-10" style={{
                                                background: '#f9fafb'
                                            }}>
                                                <tr>
                                                    <th
                                                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-14">
                                                        S.No
                                                    </th>
                                                    {config.headers.map((h, i) => {
                                                        const field = config.fields[i];
                                                        const isSorted = sortField === field;
                                                        return (
                                                            <th key={h} onClick={() => handleSort(field)}
                                                                className="px-4 py-3 text-left text-xs font-medium
                                                            text-gray-500 uppercase tracking-wider whitespace-nowrap
                                                            cursor-pointer hover:bg-white select-none transition-colors"
                                                            >
                                                                <div className="flex items-center gap-1">
                                                                    {h}
                                                                    {isSorted && (
                                                                        <svg className="w-3.5 h-3.5 text-gray-900"
                                                                            viewBox="0 0 24 24" fill="none"
                                                                            stroke="currentColor" strokeWidth="2.5"
                                                                            strokeLinecap="round" strokeLinejoin="round">
                                                                            {sortDirection === 'asc'
                                                                                ? <path d="m18 15-6-6-6 6"></path>
                                                                                : <path d="m6 9 6 6 6-6"></path>
                                                                            }
                                                                        </svg>
                                                                    )}
                                                                </div>
                                                            </th>
                                                        );
                                                    })}
                                                    <th
                                                        className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100" style={{
                                                background: '#ffffff'
                                            }}>
                                                {paginatedItems.map((item, index) => (
                                                    <tr key={item._id}
                                                        className="hover:bg-gray-50/50 transition-colors">
                                                        <td
                                                            className="px-4 py-3 text-sm text-gray-400 whitespace-nowrap font-medium">
                                                            {(currentPage - 1) * itemsPerPage + index + 1}
                                                        </td>
                                                        {config.fields.map(field => {
                                                            // Handle computed fields (start with _)
                                                            const value = field.startsWith('_') &&
                                                                config.computedFields?.[field]
                                                                ? config.computedFields[field](item)
                                                                : item[field];

                                                            // Format value based on field type
                                                            let displayValue = '--';
                                                            if (value !== undefined && value !== null && value !== '') {
                                                                // Currency fields
                                                                if (['cost', 'dailyCost', 'weeklyCost', 'monthlyCost', 'hourlyRate', 'dailyRate', 'fuelAdditiveCost', 'basePay', '_total'].includes(field)) {
                                                                    displayValue = `$${Number(value).toLocaleString()}`;
                                                                }
                                                                // Percentage fields
                                                                else if (['wCompPercent', 'payrollTaxesPercent',
                                                                    'taxes'].includes(field)) {
                                                                    displayValue = `${value}%`;
                                                                }
                                                                // Regular numbers
                                                                else if (typeof value === 'number') {
                                                                    displayValue = value.toLocaleString();
                                                                }
                                                                // Strings
                                                                else {
                                                                    displayValue = value;
                                                                }
                                                            }

                                                            return (
                                                                <td key={field}
                                                                    className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                                                                    {displayValue}
                                                                </td>
                                                            );
                                                        })}
                                                        <td className="px-4 py-3 text-right">
                                                            <div className="flex items-center justify-end gap-2">
                                                                <button onClick={() => openEditModal(item)}
                                                                    className="w-8 h-8 flex items-center justify-center
                                                                    text-gray-400 hover:text-gray-700 hover:bg-gray-100
                                                                    rounded-lg border border-transparent
                                                                    hover:border-gray-200 transition-all"
                                                                    title="Edit"
                                                                >
                                                                    <svg className="w-4 h-4" viewBox="0 0 24 24"
                                                                        fill="none" stroke="currentColor"
                                                                        strokeWidth="2" strokeLinecap="round"
                                                                        strokeLinejoin="round">
                                                                        <path
                                                                            d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z">
                                                                        </path>
                                                                        <path d="m15 5 4 4"></path>
                                                                    </svg>
                                                                </button>
                                                                <button onClick={() => deleteItem(item._id)}
                                                                    className="w-8 h-8 flex items-center justify-center
                                                                    text-gray-400 hover:text-red-600 hover:bg-red-50
                                                                    rounded-lg border border-transparent
                                                                    hover:border-red-200 transition-all"
                                                                    title="Delete"
                                                                >
                                                                    <svg className="w-4 h-4" viewBox="0 0 24 24"
                                                                        fill="none" stroke="currentColor"
                                                                        strokeWidth="2" strokeLinecap="round"
                                                                        strokeLinejoin="round">
                                                                        <path d="M3 6h18"></path>
                                                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6">
                                                                        </path>
                                                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2">
                                                                        </path>
                                                                        <line x1="10" x2="10" y1="11" y2="17"></line>
                                                                        <line x1="14" x2="14" y1="11" y2="17"></line>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Pagination */}
                                    <div className="flex-shrink-0 border-t border-gray-100">
                                        <Pagination currentPage={currentPage} totalPages={totalPages}
                                            onPageChange={setCurrentPage} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Fringe Value Prompt Modal */}
                    {showFringeValuePrompt && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-gray-900/40 backdrop-blur-sm" onClick={() =>
                                setShowFringeValuePrompt(false)}></div>
                            <div className="relative w-full max-w-sm bg-white rounded-xl shadow-2xl p-6 animate-modal">
                                <h3 className="text-lg font-semibold text-gray-900 mb-4">New Fringe Constant</h3>
                                <p className="text-sm text-gray-500 mb-4">
                                    Set the value for <strong>{pendingFringeName}</strong>. This will be saved to
                                    Constants for future use.
                                </p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Value (e.g.
                                            15.50)</label>
                                        <Input value={newFringeValue} onChange={(e) => setNewFringeValue(e.target.value)}
                                            placeholder="0.00"
                                            autoFocus
                                        />
                                    </div>
                                    <div className="flex justify-end gap-2">
                                        <Button variant="secondary" onClick={() =>
                                            setShowFringeValuePrompt(false)}>Cancel</Button>
                                        <Button onClick={handleSaveNewFringe}>Save Constant</Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add/Edit Modal - Neumorphic Design */}
                    {modalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            {/* Backdrop */}
                            <div className="absolute inset-0 bg-gray-900/40 backdrop-blur-sm" onClick={() =>
                                setModalOpen(false)}
                            ></div>

                            {/* Modal */}
                            <div className="relative w-full max-w-2xl rounded-2xl animate-modal overflow-hidden"
                                style={{ background: '#ffffff', boxShadow: '0 25px 50px rgba(0,0,0,0.15)' }}>
                                {/* Header */}
                                <div className="flex items-center justify-between px-6 py-5 border-b border-gray-100">
                                    <div>
                                        <h2 className="text-lg font-semibold text-gray-800">
                                            {editingItem ? `Edit ${categoryNames[category]}` : `Add a
                                            ${categoryNames[category].toLowerCase()} manually`}
                                        </h2>
                                    </div>
                                    <button onClick={() => setModalOpen(false)}
                                        className="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400
                                        hover:text-gray-600 hover:bg-gray-100 transition-all"
                                    >
                                        <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M18 6 6 18"></path>
                                            <path d="m6 6 12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                {/* Body */}
                                <div className="px-6 py-6 max-h-[60vh] overflow-y-auto">
                                    <div className="grid grid-cols-2 gap-5">
                                        {config.fields.map((field, i) => {
                                            // Skip computed fields (start with _)
                                            if (field.startsWith('_')) return null;

                                            const isDropdown = dropdownFields.includes(field);
                                            const isNumber = config.fieldTypes?.[field] === 'number';
                                            const label = config.headers[i];

                                            // Special handling for Fringe in Labor category
                                            if (category === 'labor' && field === 'fringe') {
                                                return (
                                                    <div key={field}>
                                                        <label
                                                            className="block text-sm font-medium text-gray-600 mb-2">{label}</label>
                                                        <SearchableSelect value={formData[field] || ''} onChange={(val) =>
                                                            handleFringeChange(val)}
                                                            options={fringeConstants.map(c => c.description)}
                                                            placeholder="Select or add fringe..."
                                                        />
                                                    </div>
                                                );
                                            }

                                            return (
                                                <div key={field} className={field === 'notes' ? 'col-span-2' : ''}>
                                                    <label className="block text-sm font-medium text-gray-600 mb-2">
                                                        {label}
                                                    </label>
                                                    {isDropdown ? (
                                                        <SearchableSelect value={formData[field] || ''} onChange={(val) =>
                                                            setFormData({ ...formData, [field]: val })}
                                                            options={getOptionsForField(field)}
                                                        />
                                                    ) : (
                                                        <input type={isNumber ? 'number' : 'text'} value={formData[field] || ''
                                                        } onChange={(e) => setFormData({
                                                            ...formData, [field]: e.target.value
                                                        })}
                                                            placeholder={`Enter ${label.toLowerCase()}`}
                                                            className="w-full h-11 px-4 text-sm text-gray-700 placeholder-gray-400
                                                rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-200
                                                transition-all border border-gray-200"
                                                            style={{
                                                                background: '#ffffff'
                                                            }}
                                                        />
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-100"
                                    style={{ background: '#fafafa' }}>
                                    <button onClick={() => setModalOpen(false)}
                                        className="h-10 px-5 text-sm font-medium text-gray-600 rounded-xl transition-all
                                        duration-200 border border-gray-200 hover:bg-gray-50"
                                        style={{ background: '#ffffff' }}
                                    >
                                        Cancel
                                    </button>
                                    <button onClick={saveItem}
                                        className="h-10 px-5 text-sm font-medium text-white rounded-xl transition-all duration-200 flex items-center gap-2"
                                        style={{
                                            background: '#22c55e', boxShadow: '0 2px 4px rgba(34, 197, 94, 0.3)'
                                        }}>
                                        {editingItem ? 'Update' : 'Save the cost'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <CatalogueApp />);
    </script>
</body>

</html>