<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Culture Gourmet Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.5;
        }

        button {
            cursor: pointer;
        }

        .center-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            background: #f8fafc;
        }

        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px 28px 28px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            max-width: 420px;
            width: 100%;
        }

        .heading-xl {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.025em;
            margin-bottom: 8px;
            color: #111827;
        }

        .text-muted {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .field {
            margin-bottom: 14px;
        }

        .field label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
        }

        .field input,
        .field textarea {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 12px 14px;
            font-size: 16px;
            outline: none;
            background: #ffffff;
            transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
        }

        .field input:focus,
        .field textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: #ffffff;
        }

        .btn-primary {
            width: 100%;
            border: none;
            border-radius: 8px;
            background: #2563eb;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            padding: 14px 0;
            margin-top: 8px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.15s, box-shadow 0.15s;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-primary:active {
            background: #1e40af;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .error-text {
            font-size: 13px;
            color: #b91c1c;
            margin-top: 8px;
            min-height: 18px;
        }

        .hidden {
            display: none !important;
        }

        /* APP LAYOUT */
        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }



        .pill {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }



        .app-main {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            width: 240px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            padding: 24px 16px;
            color: #374151;
        }

        .sidebar-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            font-weight: 500;
            transition: background-color 0.15s, color 0.15s;
        }

        .nav-item:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .nav-item span.label {
            display: inline-block;
        }

        .nav-item.active {
            background: #2563eb;
            color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .nav-badge {
            font-size: 11px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 9999px;
            padding: 2px 8px;
            margin-left: 8px;
            font-weight: 600;
        }

        .nav-item.active .nav-badge {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        /* Accordion Styles */
        .accordion {
            width: 100%;
            margin: 24px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            background: #fff;
        }

        .accordion-item {
            border-bottom: 1px solid #e5e7eb;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            padding: 18px 24px;
            background: #ffffff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #111827;
            transition: all 0.15s ease;
            user-select: none;
            font-size: 16px;
        }

        .accordion-header:hover {
            background: #f9fafb;
        }

        .accordion-header.active {
            background: #eff6ff;
            color: #2563eb;
            border-bottom: 1px solid #dbeafe;
        }

        .accordion-icon {
            transition: transform 0.2s ease;
            font-size: 14px;
            color: #6b7280;
            margin-left: 12px;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
            color: #2563eb;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: #fff;
        }

        .accordion-content-inner {
            padding: 0 24px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .accordion-content.active {
            max-height: 2000px;
            transition: max-height 0.4s ease-in;
        }

        .accordion-content.active .accordion-content-inner {
            opacity: 1;
            transition: opacity 0.3s ease 0.15s;
            padding: 24px;
        }

        /* Fix for the two-column layout inside accordion */
        .accordion .two-column {
            margin: 0;
            gap: 20px;
        }

        .accordion .panel {
            margin: 0;
            box-shadow: none;
            border: 1px solid #e5e7eb;
        }

        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            background: #ffffff;
        }

        .content h2 {
            margin: 0 0 8px;
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }

        .content .sub {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .grid-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px;
            margin-bottom: 22px;
        }

        .metric-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px 18px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.15s;
        }

        .metric-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .metric-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: #111827;
        }

        .metric-tag {
            font-size: 12px;
            margin-top: 6px;
            display: inline-block;
            padding: 4px 10px;
            border-radius: 9999px;
            background: #dbeafe;
            color: #1e40af;
            font-weight: 500;
        }

        .panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px 24px 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
            transition: box-shadow 0.15s;
        }

        .panel:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .panel-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .panel-sub {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        thead {
            background: #f8fafc;
        }

        th {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            color: #4b5563;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge-soft {
            display: inline-block;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 9999px;
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-sm {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
        }

        .btn-sm.danger {
            border-color: #fecaca;
            background: #fef2f2;
            color: #b91c1c;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1.2fr 1.7fr;
            gap: 16px;
        }

        @media (max-width:900px) {
            .app-main {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
            }

            .content {
                padding: 16px;
            }

            .two-column {
                grid-template-columns: 1fr;
            }
        }

        .contract-preview {
            background: #f9fafb;
            border-radius: 16px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            font-size: 13px;
            white-space: pre-wrap;
            line-height: 1.55;
        }

        /* TOASTS */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: #fff;
            border-left: 4px solid #3b82f6;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            min-width: 300px;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            pointer-events: auto;
        }

        .toast.success {
            border-left-color: #22c55e;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: #ffffff;
            padding: 28px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95) translateY(10px);
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.open .modal-box {
            transform: scale(1) translateY(0);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .modal-text {
            font-size: 15px;
            color: #64748b;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Contacts Section Styles */
        .contacts-section {
            margin-top: 20px;
        }
        
        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .contacts-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }
        
        .contact-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .contact-item .field {
            margin-bottom: 10px;
        }
        
        .contact-item .field:last-child {
            margin-bottom: 0;
        }
        
        .contact-item label {
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .contact-item input {
            font-size: 13px;
            padding: 6px 10px;
        }
        
        .remove-contact {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fee2e2;
            color: #b91c1c;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .remove-contact:hover {
            background: #fecaca;
        }

        /* Bootstrap Table Fixes */
        .table-responsive {
            border-radius: 0 0 12px 12px;
        }
        
        .card .table th:first-child,
        .card .table td:first-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .card .table th:last-child,
        .card .table td:last-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        /* Modal backdrop styling */
        .modal-backdrop.show {
            opacity: 0.5;
        }
        
        /* Custom button group spacing */
        .btn-group-sm > .btn {
            --bs-btn-padding-x: 0.5rem;
            --bs-btn-padding-y: 0.25rem;
            --bs-btn-font-size: 0.875rem;
        }
        
        /* Client avatar animation */
        .client-avatar {
            transition: transform 0.2s ease;
        }
        
        .client-avatar:hover {
            transform: scale(1.05);
        }
        
        /* Amazing UI Enhancements */
        .table-hover tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.08) !important;
            transform: translateY(-2px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.15);
        }
        
        .table-hover tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-backdrop.show {
            backdrop-filter: blur(12px);
            background: rgba(0, 0, 0, 0.6);
        }
        
        .bg-primary.bg-gradient.rounded-circle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s ease;
        }
        
        .bg-primary.bg-gradient.rounded-circle:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        .card {
            transition: all 0.3s ease;
            border: none !important;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
        }
        
        .btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }
        
        /* Search functionality */
        .search-highlight {
            background-color: #fbbf24 !important;
            color: #92400e !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .input-group-text {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e5e7eb;
        }
        
        .form-control:focus {
            border-color: #2563eb !important;
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25) !important;
        }
        
        .table-light {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .text-primary {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Loading animation for smooth interactions */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .table tbody tr {
            animation: fadeInUp 0.5s ease-out;
        }
        
        .table tbody tr:nth-child(even) {
            animation-delay: 0.1s;
        }
        
        .table tbody tr:nth-child(odd) {
            animation-delay: 0.05s;
        }
        
        /* Enhanced button groups */
        .btn-group .btn {
            border-radius: 6px !important;
            margin: 0 2px;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            border-color: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-outline-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            border-color: #dc2626;
            transform: translateY(-1px);
        }
        
        /* Card header enhancements */
        .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            border-bottom: 1px solid #e5e7eb !important;
        }
        
        /* Glowing effects */
        .btn-primary:focus,
        .btn-primary:active {
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.5), 0 8px 20px rgba(37, 99, 235, 0.3) !important;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Improved transitions for all interactive elements */
        * {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        /* Button click effects */
        .btn-click-effect {
            position: relative;
            overflow: hidden;
        }
        
        .btn-click-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-click-effect.clicked::after {
            width: 300px;
            height: 300px;
        }
        
        /* Floating label animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .card-header h5 {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Search input focus glow */
        .form-control:focus {
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(37, 99, 235, 0.3), 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
            }
            to {
                box-shadow: 0 0 20px rgba(37, 99, 235, 0.5), 0 0 0 0.2rem rgba(37, 99, 235, 0.4);
            }
        }
        
        /* Subtle background pattern */
        body {
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.03) 0%, transparent 50%);
        }
        
        /* Enhanced scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
        }
        
        /* Loading spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        
        /* Tooltip enhancements */
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }
        
        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <!-- LOGIN -->
    <div id="login-section" class="center-wrapper">
        <div class="card">
            <div class="heading-xl">Culture Gourmet Portal</div>
            <div class="text-muted">
                Login to manage clients and catering contracts.
            </div>
            <div class="field">
                <label for="cg-user-id">User ID</label>
                <input id="cg-user-id" type="text" placeholder="****" />
            </div>
            <div class="field">
                <label for="cg-user-pass">Password</label>
                <input id="cg-user-pass" type="password" placeholder="****" />
            </div>
            <button id="cg-login-btn" class="btn-primary" type="button">Login</button>
            <div id="cg-login-error" class="error-text"></div>

        </div>
    </div>

    <!-- APP -->
    <div id="app-section" class="app-shell hidden">
        <main class="app-main">
            <aside class="sidebar">
                <div style="width:100%; display: flex; flex-direction: column; height: 100%;">
                    <div>
                        <div class="sidebar-title">Portal</div>
                        <div class="nav-item active" data-section="home-section" id="nav-home">
                            <span class="label">Home</span>
                        </div>
                        <div class="nav-item" data-section="clients-section" id="nav-clients">
                            <span class="label">Clients</span>
                            <span class="nav-badge" id="clients-count-badge">0</span>
                        </div>
                        <div class="nav-item" data-section="contracts-section" id="nav-contracts">
                            <span class="label">Contracts</span>
                            <span class="nav-badge" id="contracts-count-badge">0</span>
                        </div>
                        <div class="nav-item" data-section="admin-section" id="nav-admin">
                            <span class="label">Admin</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: auto; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                        <div class="sidebar-title">Account</div>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin-bottom: 8px;">
                            <div class="pill">admin</div>
                        </div>
                        <button id="btn-logout" class="nav-item" style="width: 100%; text-align: left; background: none; border: none; cursor: pointer; color: #dc2626; font-size: 14px;">
                            <span class="label">Log out</span>
                        </button>
                    </div>
                </div>
            </aside>

            <section class="content">
                <!-- HOME -->
                <section id="home-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold text-dark mb-1">
                                <i class="bi bi-speedometer2 text-primary me-2"></i>
                                Dashboard
                            </h2>
                            <p class="text-muted mb-0">Overview of your Culture Gourmet contracts and business metrics</p>
                        </div>
                        <button class="btn btn-outline-primary btn-lg shadow-sm" type="button">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
                        </button>
                    </div>

                    <div class="row g-4 mb-5">
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-gradient rounded-3 p-3 me-3">
                                            <i class="bi bi-file-earmark-text text-white fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="text-muted small fw-semibold text-uppercase">Total Contracts</div>
                                            <div class="fs-2 fw-bold text-dark" id="metric-total">0</div>
                                            <div class="text-muted small">All statuses</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-info bg-gradient rounded-3 p-3 me-3">
                                            <i class="bi bi-send text-white fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="text-muted small fw-semibold text-uppercase">Sent</div>
                                            <div class="fs-2 fw-bold text-dark" id="metric-sent">0</div>
                                            <div class="text-muted small">Awaiting open</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-warning bg-gradient rounded-3 p-3 me-3">
                                            <i class="bi bi-eye text-white fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="text-muted small fw-semibold text-uppercase">Under Review</div>
                                            <div class="fs-2 fw-bold text-dark" id="metric-under-review">0</div>
                                            <div class="text-muted small">Opened, not signed</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success bg-gradient rounded-3 p-3 me-3">
                                            <i class="bi bi-check-circle text-white fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="text-muted small fw-semibold text-uppercase">Signed</div>
                                            <div class="fs-2 fw-bold text-dark" id="metric-signed">0</div>
                                            <div class="text-muted small">Fully executed</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-1 fw-semibold">
                                        <i class="bi bi-clock-history me-2 text-primary"></i>
                                        Recent Activity
                                    </h5>
                                    <p class="text-muted mb-0 small">Last few contract events and updates</p>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4 fw-semibold text-dark">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-person me-2"></i>Client
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-activity me-2"></i>Event
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-calendar3 me-2"></i>When
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-flag me-2"></i>Status
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-activity-body">
                                        <tr>
                                            <td colspan="4" class="text-center py-5">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="bi bi-clock-history text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                                                    <h6 class="text-muted mb-2">No recent activity</h6>
                                                    <p class="text-muted mb-0 small">Activity will appear once you create contracts</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CLIENTS -->
                <section id="clients-section" class="">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold text-dark mb-1">
                                <i class="bi bi-people-fill text-primary me-2"></i>
                                Clients
                            </h2>
                            <p class="text-muted mb-0">Manage your client database and contact information</p>
                        </div>
                        <button id="btn-add-client" class="btn btn-primary btn-lg shadow-sm" type="button">
                            <i class="bi bi-plus-circle me-2"></i>Add New Client
                        </button>
                    </div>
                    
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom-0 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 fw-semibold">
                                    <i class="bi bi-table me-2 text-primary"></i>
                                    All Clients
                                </h5>
                                <div class="d-flex gap-2">
                                    <div class="input-group" style="width: 250px;">
                                        <span class="input-group-text bg-light border-end-0">
                                            <i class="bi bi-search text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0 bg-light" placeholder="Search clients...">
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4 fw-semibold text-dark">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-person me-2"></i>Client Name
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-envelope me-2"></i>Email
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-telephone me-2"></i>Phone
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-people me-2"></i>Contacts
                                                </div>
                                            </th>
                                            <th class="border-0 py-3 fw-semibold text-dark text-center">Actions</th>
                                        </tr>
                                    </thead>
                            <tbody id="clients-table-body">
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="bi bi-person text-white"></i>
                                            </div>
                                            <div>
                                                <div class="fw-semibold">Skynet Silicon</div>
                                                <small class="text-muted">Client ID: mikyc19n-by0rev</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-envelope text-muted me-2"></i>
                                            <span>adeelkhipk@gmail.com</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-telephone text-muted me-2"></i>
                                            <span>+1 (555) 123-4567</span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary rounded-pill">1</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" data-edit-client-id="mikyc19n-by0rev" title="Edit Client">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" data-delete-client-id="mikyc19n-by0rev" title="Delete Client">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                </tr>
                            </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Client Form Modal -->
                    <div id="client-form-panel" class="card border-0 shadow-lg hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; width: 90%; max-width: 700px;">
                        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 text-white fw-bold">
                                    <i class="bi bi-person-plus me-2"></i>
                                    <span class="client-form-title">New Client</span>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" id="client-close-btn"></button>
                            </div>
                        </div>
                        
                        <div class="card-body p-4">
                            <form>
                                <div class="mb-4">
                                    <label for="client-name-input" class="form-label fw-semibold">
                                        <i class="bi bi-person me-1"></i>Client Name *
                                    </label>
                                    <input id="client-name-input" type="text" class="form-control form-control-lg" placeholder="Enter client or company name" required>
                                </div>
                                
                                <div class="contacts-section">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-semibold mb-0">
                                            <i class="bi bi-people me-2 text-primary"></i>Contact Information
                                        </h6>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addContactField()">
                                            <i class="bi bi-plus me-1"></i>Add Contact
                                        </button>
                                    </div>
                                    <div id="contacts-container" class="contacts-container">
                                        <!-- Contact fields will be added here dynamically -->
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card-footer bg-light border-top-0 p-4">
                            <div class="d-flex gap-2 justify-content-end">
                                <button id="client-cancel-btn" class="btn btn-outline-secondary" type="button">
                                    <i class="bi bi-x-circle me-1"></i>Cancel
                                </button>
                                <button id="client-save-btn" class="btn btn-primary px-4" type="button">
                                    <i class="bi bi-check-circle me-1"></i>Save Client
                                </button>
                            </div>
                            <div id="client-form-msg" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Modal Backdrop -->
                    <div id="client-modal-backdrop" class="modal-backdrop fade hidden" style="z-index: 1040;"></div>
                </section>

                <!-- CONTRACTS -->
                <section id="contracts-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold text-dark mb-1">
                                <i class="bi bi-file-earmark-text text-primary me-2"></i>
                                Contracts
                            </h2>
                            <p class="text-muted mb-0">Create and manage Culture Gourmet catering agreements</p>
                        </div>
                        <button class="btn btn-success btn-lg shadow-sm" type="button">
                            <i class="bi bi-plus-circle me-2"></i>New Contract
                        </button>
                    </div>

                    <div class="accordion">
                        <!-- Create Contract Accordion Item -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion('create-contract')">
                                <span>Create New Contract</span>
                                <span class="accordion-icon"></span>
                            </div>
                            <div class="accordion-content" id="create-contract-content">
                                <div class="accordion-content-inner">
                                    <div class="two-column">
                                        <div class="panel">
                                            <div class="field">
                                                <label for="contract-client-name">Client Name</label>
                                                <input id="contract-client-name" type="text" placeholder="Adeel Jabbar" />
                                            </div>
                                            <div class="field">
                                                <label for="contract-client-email">Client Email</label>
                                                <input id="contract-client-email" type="email" placeholder="client@example.com" />
                                            </div>
                                            <div class="field">
                                                <label for="contract-event-date">Event Date</label>
                                                <input id="contract-event-date" type="date" />
                                            </div>
                                            <div class="field">
                                                <label for="contract-event-location">Event Location</label>
                                                <input id="contract-event-location" type="text" placeholder="Venue / Address" />
                                            </div>
                                            <div class="field">
                                                <label for="contract-guest-count">Guest Count</label>
                                                <input id="contract-guest-count" type="number" min="1" placeholder="e.g. 80" />
                                            </div>
                                            <div class="field">
                                                <label>Event Start / End Time</label>
                                                <div style="display:flex;gap:6px;">
                                                    <input id="contract-start-time" type="time" />
                                                    <input id="contract-end-time" type="time" />
                                                </div>
                                            </div>

                                            <button id="contract-send-btn" class="btn-primary" type="button">Create Contract</button>
                                            <div id="contract-send-message" class="success-text"></div>
                                        </div>

                                        <div class="panel">
                                            <div class="panel-title">Live Contract Preview</div>
                                            <div class="panel-sub" style="margin-bottom: 16px;">Updates as you type client details.</div>
                                            <div id="contract-preview" class="contract-preview"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- View Contracts Accordion Item -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion('view-contracts')">
                                <span>View Contracts</span>
                                <span class="accordion-icon"></span>
                            </div>
                            <div class="accordion-content" id="view-contracts-content">
                                <div class="accordion-content-inner">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Client</th>
                                                <th>Event Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="contracts-table-body">
                                            <tr>
                                                <td colspan="4" style="text-align:center;color:#9ca3af;padding: 20px;">
                                                    No contracts found. Create your first contract to get started.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ADMIN (local-only) -->
                <section id="admin-section" class="hidden">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold text-dark mb-1">
                                <i class="bi bi-gear text-primary me-2"></i>
                                Admin Settings
                            </h2>
                            <p class="text-muted mb-0">Configure company profile and system preferences</p>
                        </div>
                        <button class="btn btn-outline-success btn-lg shadow-sm" type="button">
                            <i class="bi bi-save me-2"></i>Save All Settings
                        </button>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom-0 py-3">
                                    <h5 class="card-title mb-0 fw-semibold">
                                        <i class="bi bi-building me-2 text-primary"></i>
                                        Company Profile
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-4">
                                        <label for="admin-company-name" class="form-label fw-semibold">
                                            <i class="bi bi-building me-1"></i>Company Name
                                        </label>
                                        <input id="admin-company-name" type="text" class="form-control form-control-lg" value="Culture Gourmet" />
                                    </div>
                                    <div class="mb-4">
                                        <label for="admin-company-address" class="form-label fw-semibold">
                                            <i class="bi bi-geo-alt me-1"></i>Business Address
                                        </label>
                                        <textarea id="admin-company-address" rows="4" class="form-control" placeholder="Enter your business address..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom-0 py-3">
                                    <h5 class="card-title mb-0 fw-semibold">
                                        <i class="bi bi-envelope-at me-2 text-primary"></i>
                                        SMTP Email Settings
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-3">
                                        <label for="smtp-host" class="form-label fw-semibold">
                                            <i class="bi bi-server me-1"></i>SMTP Host
                                        </label>
                                        <input id="smtp-host" type="text" class="form-control" placeholder="smtp.gmail.com" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-port" class="form-label fw-semibold">
                                            <i class="bi bi-hdd-network me-1"></i>SMTP Port
                                        </label>
                                        <input id="smtp-port" type="number" class="form-control" placeholder="587" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-user" class="form-label fw-semibold">
                                            <i class="bi bi-person-circle me-1"></i>SMTP User (Email)
                                        </label>
                                        <input id="smtp-user" type="text" class="form-control" placeholder="you@gmail.com" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="smtp-pass" class="form-label fw-semibold">
                                            <i class="bi bi-key me-1"></i>SMTP Password
                                        </label>
                                        <input id="smtp-pass" type="password" class="form-control" placeholder="App Password" />
                                    </div>
                                    <div class="mb-4">
                                        <label for="smtp-from" class="form-label fw-semibold">
                                            <i class="bi bi-envelope me-1"></i>From Email (Optional)
                                        </label>
                                        <input id="smtp-from" type="text" class="form-control" placeholder="Culture Gourmet <you@gmail.com>" />
                                    </div>
                                    <button id="btn-save-smtp" class="btn btn-primary w-100" type="button">
                                        <i class="bi bi-check-circle me-1"></i>Save SMTP Settings
                                    </button>
                                    <div id="smtp-msg" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </section>
        </main>
    </div>

    <!-- UI COMPONENTS -->
    <div id="toast-container" class="toast-container"></div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="confirm-title" class="modal-title">Confirm Action</div>
            <div id="confirm-text" class="modal-text">Are you sure you want to proceed?</div>
            <div class="modal-actions">
                <button id="confirm-no" class="btn-sm" style="padding: 8px 16px; font-size:13px;">Cancel</button>
                <button id="confirm-yes" class="btn-primary"
                    style="width:auto; margin:0; padding: 8px 20px; font-size:13px;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ---------- UI Helpers ----------
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        function showConfirm(message, title = "Confirm Action") {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const textEl = document.getElementById('confirm-text');
                const btnYes = document.getElementById('confirm-yes');
                const btnNo = document.getElementById('confirm-no');

                titleEl.textContent = title;
                textEl.textContent = message;
                overlay.classList.add('open');

                // Remove previous listeners to avoid stacking
                const newBtnYes = btnYes.cloneNode(true);
                const newBtnNo = btnNo.cloneNode(true);
                btnYes.parentNode.replaceChild(newBtnYes, btnYes);
                btnNo.parentNode.replaceChild(newBtnNo, btnNo);

                const close = (val) => {
                    overlay.classList.remove('open');
                    resolve(val);
                };

                newBtnYes.addEventListener('click', () => close(true));
                newBtnNo.addEventListener('click', () => close(false));
            });
        }

        // ---------- simple login ----------
        const LOGIN_USER = "admin";
        const LOGIN_PASS = "Abc123***";

        const loginSection = document.getElementById("login-section");
        const appSection = document.getElementById("app-section");
        const loginBtn = document.getElementById("cg-login-btn");
        const loginErr = document.getElementById("cg-login-error");
        const userIdInput = document.getElementById("cg-user-id");
        const userPassInput = document.getElementById("cg-user-pass");
        const btnLogout = document.getElementById("btn-logout");

        function showApp() {
            loginSection.classList.add("hidden");
            appSection.classList.remove("hidden");
            loadInitialData();
            // Clear login hash and go to clean URL
            window.location.hash = '';
            activateSection('home-section');
        }
        function showLogin() {
            appSection.classList.add("hidden");
            loginSection.classList.remove("hidden");
            window.location.hash = 'login';
        }



        loginBtn.addEventListener("click", () => {
            const u = userIdInput.value.trim();
            const p = userPassInput.value.trim();
            if (u === LOGIN_USER && p === LOGIN_PASS) {
                loginErr.textContent = "";
                localStorage.setItem("cg_auth", "true");
                showApp();
            } else {
                loginErr.textContent = "Invalid credentials.";
            }
        });

        btnLogout.addEventListener("click", () => {
            localStorage.removeItem("cg_auth");
            showLogin();
        });

        // ---------- navigation ----------
        const sections = {
            "home-section": document.getElementById("home-section"),
            "clients-section": document.getElementById("clients-section"),
            "contracts-section": document.getElementById("contracts-section"),
            "admin-section": document.getElementById("admin-section"),
        };
        const navItems = document.querySelectorAll(".nav-item");

        function activateSection(id) {
            // Update URL hash
            window.location.hash = id;
            
            Object.keys(sections).forEach((key) => {
                sections[key].classList.toggle("hidden", key !== id);
            });
            navItems.forEach((item) => {
                item.classList.toggle(
                    "active",
                    item.getAttribute("data-section") === id
                );
            });
        }

        // Handle navigation clicks
        navItems.forEach((item) => {
            item.addEventListener("click", () => {
                const id = item.getAttribute("data-section");
                if (id) activateSection(id);
            });
        });

        // Handle hash changes (browser back/forward buttons)
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1); // Remove #
            const isAuthenticated = localStorage.getItem("cg_auth") === "true";
            
            if (hash === 'login') {
                showLogin();
            } else if (hash && sections[hash] && isAuthenticated) {
                activateSection(hash);
            } else if (!isAuthenticated) {
                showLogin();
            }
        });

        // Check hash on page load
        window.addEventListener('load', () => {
            const hash = window.location.hash.slice(1);
            const isAuthenticated = localStorage.getItem("cg_auth") === "true";
            
            if (hash === 'login' || !isAuthenticated) {
                showLogin();
            } else if (hash && sections[hash] && isAuthenticated) {
                showApp();
                activateSection(hash);
            } else if (isAuthenticated) {
                showApp();
            } else {
                showLogin();
            }
            
            // Initialize button click effects
            initializeButtonEffects();
        });
        
        // Add click effects to all buttons
        function initializeButtonEffects() {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn') || e.target.closest('.btn')) {
                    const btn = e.target.classList.contains('btn') ? e.target : e.target.closest('.btn');
                    addClickEffect(btn);
                }
            });
        }
        
        function addClickEffect(button) {
            button.classList.add('btn-click-effect');
            button.classList.add('clicked');
            
            setTimeout(() => {
                button.classList.remove('clicked');
            }, 600);
        }
        
        // Loading state management
        function setButtonLoading(button, isLoading = true) {
            if (isLoading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Loading...';
                button.disabled = true;
                button.classList.add('btn-loading');
            } else {
                button.innerHTML = button.dataset.originalText || button.innerHTML;
                button.disabled = false;
                button.classList.remove('btn-loading');
            }
        }

        // ---------- API helper ----------
        const API_URL = "/webhook/theCultureGourmetContract";

        async function callCG(payload) {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const raw = await res.json();
            return raw.result || raw;
        }

        // ---------- Clients ----------
        let clients = [];
        let editingClientId = null;
        const clientsTableBody = document.getElementById("clients-table-body");
        const clientsCountBadge = document.getElementById("clients-count-badge");
        const btnAddClient = document.getElementById("btn-add-client");
        const clientFormPanel = document.getElementById("client-form-panel");
        const clientNameInput = document.getElementById("client-name-input");
        const clientSaveBtn = document.getElementById("client-save-btn");
        const clientCancelBtn = document.getElementById("client-cancel-btn");
        const clientFormMsg = document.getElementById("client-form-msg");
        const contactsContainer = document.getElementById("contacts-container");
        let contactCount = 0;

        // Add a new contact field
        function addContactField(contactData = null) {
            contactCount++;
            const contactId = `contact-${contactCount}`;
            const contactItem = document.createElement('div');
            contactItem.className = 'card border-0 bg-light mb-3 position-relative';
            contactItem.id = contactId;
            
            contactItem.innerHTML = `
                <div class="card-body p-3">
                    <button type="button" class="btn btn-outline-danger btn-sm position-absolute top-0 end-0 m-2" onclick="removeContactField('${contactId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">
                                <i class="bi bi-person me-1"></i>Contact Person
                            </label>
                            <input type="text" class="form-control" id="${contactId}-person" value="${contactData?.person || ''}" placeholder="Full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">
                                <i class="bi bi-envelope me-1"></i>Contact Email
                            </label>
                            <input type="email" class="form-control" id="${contactId}-email" value="${contactData?.email || ''}" placeholder="email@domain.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">
                                <i class="bi bi-telephone me-1"></i>Contact Phone
                            </label>
                            <input type="text" class="form-control" id="${contactId}-phone" value="${contactData?.phone || ''}" placeholder="(555) 123-4567">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold small">
                                <i class="bi bi-geo-alt me-1"></i>Contact Address
                            </label>
                            <input type="text" class="form-control" id="${contactId}-address" value="${contactData?.address || ''}" placeholder="Street address">
                        </div>
                    </div>
                </div>
            `;
            
            contactsContainer.appendChild(contactItem);
            return contactId;
        }

        // Remove a contact field
        function removeContactField(contactId) {
            const contactItem = document.getElementById(contactId);
            if (contactItem) {
                contactItem.remove();
            }
        }

        // Clear all contact fields
        function clearContactFields() {
            contactsContainer.innerHTML = '';
            contactCount = 0;
        }

        // Get all contact data
        function getContactData() {
            const contacts = [];
            const contactItems = contactsContainer.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const id = item.id;
                const person = document.getElementById(`${id}-person`)?.value || '';
                const email = document.getElementById(`${id}-email`)?.value || '';
                const phone = document.getElementById(`${id}-phone`)?.value || '';
                const address = document.getElementById(`${id}-address`)?.value || '';
                
                if (person || email || phone || address) {
                    contacts.push({ person, email, phone, address });
                }
            });
            
            return contacts;
        }

        function renderClients() {
            clientsTableBody.innerHTML = "";
            if (!clients.length) {
                clientsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-people display-4 mb-3 d-block text-light"></i>
                                <h6 class="fw-semibold">No clients yet</h6>
                                <p class="mb-0 small">Click "Add New Client" to create your first client</p>
                            </div>
                        </td>
                    </tr>`;
            } else {
                clients.forEach((c) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="client-avatar bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="bi bi-person text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">${c.name}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope text-muted me-2"></i>
                                ${c.contacts?.[0]?.email || '<span class="text-muted">No email</span>'}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-telephone text-muted me-2"></i>
                                ${c.contacts?.[0]?.phone || '<span class="text-muted">No phone</span>'}
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary rounded-pill">${c.contacts?.length || 0}</span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" data-edit-client-id="${c.id}" title="Edit Client">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" data-delete-client-id="${c.id}" title="Delete Client">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    clientsTableBody.appendChild(tr);
                });

                // Attach event listeners
                document.querySelectorAll("[data-edit-client-id]").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const id = btn.getAttribute("data-edit-client-id");
                        handleEditClient(id);
                    });
                });

                document.querySelectorAll("[data-delete-client-id]").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const id = btn.getAttribute("data-delete-client-id");
                        handleDeleteClient(id);
                    });
                });
            }

            clientsCountBadge.textContent = String(clients.length);
        }

        // Search functionality
        function initializeClientSearch() {
            const searchInput = document.querySelector('#clients-section .form-control[placeholder="Search clients..."]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterClientTable(searchTerm);
                });
            }
        }

        function filterClientTable(searchTerm) {
            const tableRows = document.querySelectorAll('#clients-table-body tr');
            let visibleCount = 0;
            
            tableRows.forEach((row, index) => {
                const clientNameEl = row.querySelector('td:first-child .fw-semibold');
                const clientEmailEl = row.querySelector('td:nth-child(2)');
                const clientPhoneEl = row.querySelector('td:nth-child(3)');
                
                const clientName = clientNameEl?.textContent?.toLowerCase() || '';
                const clientEmail = clientEmailEl?.textContent?.toLowerCase().replace(/\s+/g, '') || '';
                const clientPhone = clientPhoneEl?.textContent?.toLowerCase().replace(/\s+/g, '') || '';
                
                // Clear previous highlights
                if (clientNameEl) clientNameEl.innerHTML = clientNameEl.textContent;
                if (clientEmailEl) {
                    const emailContent = clientEmailEl.textContent.trim();
                    clientEmailEl.innerHTML = `<div class="d-flex align-items-center"><i class="bi bi-envelope text-muted me-2"></i>${emailContent}</div>`;
                }
                if (clientPhoneEl) {
                    const phoneContent = clientPhoneEl.textContent.trim();
                    clientPhoneEl.innerHTML = `<div class="d-flex align-items-center"><i class="bi bi-telephone text-muted me-2"></i>${phoneContent}</div>`;
                }
                
                if (searchTerm && (clientName.includes(searchTerm) || clientEmail.includes(searchTerm) || clientPhone.includes(searchTerm))) {
                    // Highlight matching terms
                    if (clientName.includes(searchTerm) && clientNameEl) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        clientNameEl.innerHTML = clientNameEl.textContent.replace(regex, '<span class="search-highlight">$1</span>');
                    }
                    if (clientEmail.includes(searchTerm) && clientEmailEl) {
                        const emailContent = clientEmailEl.textContent.trim();
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const highlightedEmail = emailContent.replace(regex, '<span class="search-highlight">$1</span>');
                        clientEmailEl.innerHTML = `<div class="d-flex align-items-center"><i class="bi bi-envelope text-muted me-2"></i>${highlightedEmail}</div>`;
                    }
                    if (clientPhone.includes(searchTerm) && clientPhoneEl) {
                        const phoneContent = clientPhoneEl.textContent.trim();
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const highlightedPhone = phoneContent.replace(regex, '<span class="search-highlight">$1</span>');
                        clientPhoneEl.innerHTML = `<div class="d-flex align-items-center"><i class="bi bi-telephone text-muted me-2"></i>${highlightedPhone}</div>`;
                    }
                }
                
                if (searchTerm === '' || clientName.includes(searchTerm) || clientEmail.includes(searchTerm) || clientPhone.includes(searchTerm)) {
                    row.style.display = '';
                    row.style.animationDelay = `${index * 0.05}s`;
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update search results counter
            updateSearchCounter(visibleCount, tableRows.length, searchTerm);
        }
        
        function updateSearchCounter(visible, total, searchTerm) {
            let counterEl = document.querySelector('.search-counter');
            if (!counterEl) {
                const searchContainer = document.querySelector('#clients-section .input-group');
                counterEl = document.createElement('small');
                counterEl.className = 'search-counter text-muted mt-1 d-block';
                searchContainer.parentNode.appendChild(counterEl);
            }
            
            // Handle no results state
            const tableBody = document.getElementById('clients-table-body');
            let noResultsRow = document.querySelector('.no-results-row');
            
            if (searchTerm && visible === 0) {
                // Show no results message
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = `
                        <td colspan="5" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-search text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                                <h6 class="text-muted mb-2">No clients found</h6>
                                <p class="text-muted mb-0 small">Try adjusting your search term or <a href="#" class="text-primary" onclick="document.querySelector('.form-control[placeholder=\\"Search clients...\\"]').value=''; filterClientTable('');">clear the search</a></p>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(noResultsRow);
                }
                noResultsRow.style.display = '';
                counterEl.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>No matches for "${searchTerm}"`;
                counterEl.className = 'search-counter text-warning mt-1 d-block';
            } else {
                // Hide no results message
                if (noResultsRow) {
                    noResultsRow.style.display = 'none';
                }
                
                if (searchTerm) {
                    counterEl.innerHTML = `<i class="bi bi-check-circle me-1"></i>Showing ${visible} of ${total} clients`;
                    counterEl.className = 'search-counter text-success mt-1 d-block';
                } else {
                    counterEl.innerHTML = '';
                    counterEl.className = 'search-counter text-muted mt-1 d-block';
                }
            }
        }

        // Modal functionality
        function showClientModal() {
            const modal = document.getElementById('client-form-panel');
            const backdrop = document.getElementById('client-modal-backdrop');
            modal.classList.remove('hidden');
            backdrop.classList.remove('hidden');
            backdrop.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideClientModal() {
            const modal = document.getElementById('client-form-panel');
            const backdrop = document.getElementById('client-modal-backdrop');
            modal.classList.add('hidden');
            backdrop.classList.add('hidden');
            backdrop.classList.remove('show');
            document.body.style.overflow = '';
        }

        btnAddClient.addEventListener("click", () => {
            editingClientId = null;
            clientNameInput.value = "";
            clientFormMsg.textContent = "";
            clearContactFields();
            // Add one empty contact field by default
            addContactField();
            document.querySelector('.client-form-title').textContent = "New Client";
            showClientModal();
            console.log("Add Client clicked - form opened");
        });

        // Handle close button clicks
        document.getElementById('client-close-btn').addEventListener('click', hideClientModal);
        document.getElementById('client-modal-backdrop').addEventListener('click', hideClientModal);

        clientCancelBtn.addEventListener("click", () => {
            hideClientModal();
            clearContactFields();
            editingClientId = null;
        });

        clientSaveBtn.addEventListener("click", async () => {
            const name = clientNameInput.value.trim();
            const contacts = getContactData();
            
            console.log("Saving client:", { name, contacts });
            
            if (!name) {
                showToast("Client name is required.", "error");
                return;
            }
            
            if (contacts.length === 0) {
                showToast("At least one contact is required.", "error");
                return;
            }
            
            // Validate that at least one contact has a name
            const hasValidContact = contacts.some(c => c.person.trim() !== '');
            if (!hasValidContact) {
                showToast("At least one contact person name is required.", "error");
                return;
            }

            try {
                if (editingClientId) {
                    // Update existing client
                    const payload = {
                        action: "updateClient",
                        clientId: editingClientId,
                        name,
                        contacts
                    };
                    console.log("Sending update payload:", payload);
                    
                    const resp = await callCG(payload);
                    
                    if (resp.success) {
                        const idx = clients.findIndex(c => c.id === editingClientId);
                        if (idx !== -1) {
                            clients[idx] = resp.client;
                        }
                        showToast("Client updated successfully!");
                    } else {
                        showToast(resp.message || "Error updating client.", "error");
                    }
                } else {
                    // Create new client
                    const payload = {
                        action: "createClient",
                        name,
                        contacts
                    };
                    console.log("Sending create payload:", payload);
                    
                    const resp = await callCG(payload);
                    
                    if (resp.success) {
                        clients.push(resp.client);
                        showToast("Client created successfully!");
                    } else {
                        showToast(resp.message || "Error creating client.", "error");
                    }
                }

                renderClients();
                hideClientModal();
                clearContactFields();
                editingClientId = null;

            } catch (err) {
                console.error(err);
                showToast("Error saving client.", "error");
            }
        });

        async function handleEditClient(clientId) {
            const client = clients.find((c) => c.id === clientId);
            if (!client) return;

            editingClientId = clientId;
            clientNameInput.value = client.name || "";
            clientFormMsg.textContent = "";
            clearContactFields();
            
            // Load existing contacts
            if (client.contacts && Array.isArray(client.contacts)) {
                client.contacts.forEach(contact => {
                    addContactField(contact);
                });
            } else {
                // Add one empty field if no contacts exist
                addContactField();
            }
            
            document.querySelector('.client-form-title').textContent = "Edit Client";
            showClientModal();
        }

        async function handleDeleteClient(clientId) {
            if (!await showConfirm("Are you sure you want to delete this client?", "Delete Client")) return;

            try {
                const resp = await callCG({
                    action: "deleteClient",
                    clientId,
                });
                if (!resp.success) {
                    showToast(resp.message || "Error deleting client.", "error");
                    return;
                }

                clients = clients.filter((c) => c.id !== clientId);
                renderClients();
                showToast("Client deleted successfully!");

            } catch (err) {
                console.error(err);
                showToast("Error deleting client.", "error");
            }
        }

        // ---------- Contracts ----------
        let contracts = [];
        const contractsTableBody = document.getElementById("contracts-table-body");
        const contractsCountBadge = document.getElementById("contracts-count-badge");
        const contractClientName = document.getElementById("contract-client-name");
        const contractClientEmail = document.getElementById("contract-client-email");
        const contractEventDate = document.getElementById("contract-event-date");
        const contractEventLocation = document.getElementById("contract-event-location");
        const contractGuestCount = document.getElementById("contract-guest-count");
        const contractStartTime = document.getElementById("contract-start-time");
        const contractEndTime = document.getElementById("contract-end-time");
        const contractPreview = document.getElementById("contract-preview");
        const contractSendBtn = document.getElementById("contract-send-btn");
        const contractSendMessage = document.getElementById("contract-send-message");

        function fmtEventTime() {
            const s = contractStartTime.value;
            const e = contractEndTime.value;
            if (!s && !e) return "____________________________";
            if (s && e) return `${s}  ${e}`;
            return s || e;
        }
        function fmtEventDate() {
            return contractEventDate.value || "____________________________";
        }

        function updateContractPreview() {
            const clientName = contractClientName.value || "________________________";
            const eventDate = fmtEventDate();
            const eventLocation = contractEventLocation.value || "____________________________";
            const guestCount = contractGuestCount.value || "____________________________";
            const eventTime = fmtEventTime();

            const txt = `
CULTURE GOURMET  CATERING AGREEMENT
(One-Page Contract)

This Catering Agreement (Agreement) is entered into between Culture Gourmet (Caterer) and the undersigned ${clientName} (Client) for catering services on the date listed below.

1. EVENT DETAILS
Client Name: ${clientName}
Event Date: ${eventDate}
Event Location: ${eventLocation}
Guest Count: ${guestCount}
Event Start/End Time: ${eventTime}

2. SERVICE AREA
Culture Gourmet provides catering services locally within the DMV and nationwide, subject to travel fees.

3. DEPOSIT & BOOKING POLICY
- A 50% deposit is required to secure the event date.
- The deposit is non-refundable and holds the selected date.
- In cases of inclement weather, the deposit is fully transferable to a new mutually agreed-upon date.

4. CANCELLATION POLICY
If the Client cancels for any reason:
- Payments made are credited in full toward a future event date within 12 months.
- No cash refunds will be provided.

5. RESCHEDULING POLICY
- Rescheduling due to weather or unforeseen circumstances is allowed at no additional cost, pending availability.
- New dates are subject to availability and may incur rate differences on holidays or peak days.

6. PAYMENT TERMS
- Accepted payment methods: Credit Card or Cash.
- All events must be paid in full no later than 14 days prior to the event date.
- If an event is booked within 14 days of the event date, the full invoice amount is due at the time of booking.
- Final payment is non-refundable but fully creditable toward a future date if the event is canceled.

7. ALCOHOL SERVICE (If Applicable)
- Alcohol service is provided only to guests 21+.
- Culture Gourmet is not responsible for guest behavior related to alcohol.
- Client agrees to maintain compliance with all state and local alcohol laws.

8. LIABILITY & DAMAGES
Client is responsible for any damages to equipment, rentals, or property caused by guests. Culture Gourmet is not liable for circumstances outside of its control, including venue limitations, acts of nature, or client-provided items.

9. AGREEMENT & SIGNATURES
By signing below, the Client acknowledges and agrees to all terms outlined.

Client Name: ${clientName}
Client Signature: ________________________________
Date: ____________________

Culture Gourmet Representative: ______________________________
Signature: _____________________________________
Date: ____________________
`;
            contractPreview.textContent = txt.trim();
        }

        [
            contractClientName,
            contractClientEmail,
            contractEventDate,
            contractEventLocation,
            contractGuestCount,
            contractStartTime,
            contractEndTime,
        ].forEach((el) => {
            el.addEventListener("input", updateContractPreview);
            el.addEventListener("change", updateContractPreview);
        });

        function renderContracts() {
            contractsTableBody.innerHTML = "";
            if (!contracts.length) {
                contractsTableBody.innerHTML =
                    '<tr><td colspan="5" style="text-align:center;color:#9ca3af;">No contracts found. Create your first contract to get started.</td></tr>';
            } else {
                contracts.forEach((c) => {
                    const tr = document.createElement("tr");

                    // Map status to display text
                    const statusMap = {
                        'draft': 'Draft',
                        'send': 'Sent',
                        'under-review': 'Under Review',
                        'reviewed': 'Reviewed',
                        'signed': 'Signed'
                    };
                    
                    const status = c.status || 'draft';
                    const statusText = statusMap[status] || status;
                    
                    // Status badge with appropriate class
                    const statusBadge = `<span class="badge-soft status-${status.replace(' ', '-').toLowerCase()}">${statusText}</span>`;

                    // Action buttons
                    const actions = [
                        `<button class="btn-sm btn-edit" data-edit-id="${c.id}">Edit</button>`,
                        `<button class="btn-sm btn-resend" data-resend-id="${c.id}">Resend</button>`,
                        `<button class="btn-sm btn-delete" data-delete-id="${c.id}">Delete</button>`,
                        `<a href="theCultureGourmetContractAdmin.html?contractId=${c.id}" class="btn-sm btn-open">Open</a>`
                    ];

                    tr.innerHTML = `
        <td>${c.clientName || ""}</td>
        <td>${c.eventDate ? new Date(c.eventDate).toLocaleDateString() : ""}</td>
        <td>${statusBadge}</td>
        <td>${actions.join("")}</td>
      `;

                    contractsTableBody.appendChild(tr);
                });
            }

            // update dashboard counters as before
            contractsCountBadge.textContent = String(contracts.length);
            updateMetrics();
            renderRecentActivity();

            // Wire up action buttons
            document.querySelectorAll("[data-edit-id]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-edit-id");
                    handleEditContract(id);
                });
            });

            document.querySelectorAll("[data-resend-id]").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-resend-id");
                    if (await showConfirm("Resend this contract to the client?", "Confirm Resend")) {
                        await sendContract(id);
                    }
                });
            });

            document.querySelectorAll("[data-delete-id]").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const id = btn.getAttribute("data-delete-id");
                    if (await showConfirm("Are you sure you want to delete this contract? This action cannot be undone.", "Confirm Delete")) {
                        await handleDeleteContract(id);
                    }
                });
            });
            
            // Add status badge styling
            const style = document.createElement('style');
            style.textContent = `
                .status-badge {
                    display: inline-block;
                    padding: 6px 12px;
                    border-radius: 9999px;
                    font-size: 13px;
                    font-weight: 500;
                    text-transform: capitalize;
                }
                .status-draft { background: #f3f4f6; color: #374151; }
                .status-send { background: #dbeafe; color: #1e40af; }
                .status-under-review { background: #fef3c7; color: #d97706; }
                .status-reviewed { background: #ede9fe; color: #7c3aed; }
                .status-signed { background: #dcfce7; color: #16a34a; }
                
                .btn-sm {
                    padding: 6px 12px;
                    border-radius: 6px;
                    font-size: 13px;
                    font-weight: 500;
                    cursor: pointer;
                    border: 1px solid #d1d5db;
                    background: #ffffff;
                    color: #374151;
                    transition: all 0.15s;
                    transition: all 0.2s;
                    margin-right: 6px;
                    text-decoration: none;
                    display: inline-block;
                    text-align: center;
                }
                
                .btn-sm:hover { 
                    background: #f9fafb; 
                    border-color: #9ca3af; 
                }
                
                .btn-edit { background: #ffffff; color: #374151; }
                .btn-edit:hover { background: #f9fafb; }
                
                .btn-resend { background: #dbeafe; color: #1e40af; border-color: #2563eb; }
                .btn-resend:hover { background: #bfdbfe; }
                
                .btn-delete { background: #fee2e2; color: #dc2626; border-color: #ef4444; }
                .btn-delete:hover { background: #fecaca; }
                
                .btn-open { background: #dcfce7; color: #16a34a; border-color: #22c55e; }
                .btn-open:hover { background: #bbf7d0; }
                
                .badge-soft {
                    display: inline-block;
                    padding: 6px 12px;
                    border-radius: 9999px;
                    font-size: 13px;
                    font-weight: 500;
                    text-transform: capitalize;
                }`;
            document.head.appendChild(style);
        }



        async function sendContract(contractId) {
            const contract = contracts.find((c) => c.id === contractId);
            if (!contract) return;

            if (!await showConfirm(`Send contract to ${contract.clientEmail}?`, "Send Contract")) return;

            try {
                const resp = await callCG({
                    action: "sendContract",
                    contractId,
                });
                if (!resp.success) {
                    showToast(resp.message || "Error sending contract.", "error");
                    return;
                }

                // update local contracts array
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) {
                    contracts[idx] = resp.contract;
                }

                renderContracts();

                if (resp.emailSent) {
                    showToast(" Email sent successfully via SMTP!", "success");
                } else {
                    // Fallback to mailto if SMTP failed or not configured
                    const fullLink = window.location.origin + (resp.contract.fileUrl || "");
                    const subject = "Culture Gourmet Catering Agreement";
                    const body =
                        `Hi ${resp.contract.clientName},\n\n` +
                        `Here is your catering agreement:\n${fullLink}\n\n` +
                        `Thank you,\nCulture Gourmet`;

                    if (resp.emailError) {
                        console.warn("SMTP Error:", resp.emailError);
                        showToast(" SMTP failed. Opening default mail client instead.", "warning");
                    } else {
                        showToast(" SMTP not configured. Opening default mail client.", "info");
                    }

                    window.open(
                        `mailto:${encodeURIComponent(
                            resp.contract.clientEmail
                        )}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,
                        "_blank"
                    );
                }

            } catch (err) {
                console.error(err);
                showToast("Error contacting server.", "error");
            }
        }


        async function updateContractStatus(contractId, status) {
            if (!await showConfirm(`Mark this contract as "${status}"?`, "Update Status")) return;

            try {
                const resp = await callCG({
                    action: "updateContractStatus",
                    contractId,
                    status,
                });

                if (!resp.success) {
                    showToast(resp.message || "Error updating status.", "error");
                    return;
                }

                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) {
                    contracts[idx] = resp.contract;
                }

                renderContracts();
                showToast(`Status updated to ${status}`, "success");
            } catch (err) {
                console.error(err);
                showToast("Error contacting server.", "error");
            }
        }
        async function handleEditContract(contractId) {
            const contract = contracts.find((c) => c.id === contractId);
            if (!contract) return;

            const clientName = prompt("Client Name", contract.clientName || "");
            if (clientName === null) return;

            const clientEmail = prompt("Client Email", contract.clientEmail || "");
            if (clientEmail === null) return;

            const eventDate = prompt("Event Date", contract.eventDate || "");
            if (eventDate === null) return;

            const eventLocation = prompt("Event Location", contract.eventLocation || "");
            if (eventLocation === null) return;

            const guestCount = prompt("Guest Count", contract.guestCount || "");
            if (guestCount === null) return;

            const eventTime = prompt("Event Start/End Time", contract.eventTime || "");
            if (eventTime === null) return;

            try {
                const resp = await callCG({
                    action: "updateContractFields",
                    contractId,
                    clientName,
                    clientEmail,
                    eventDate,
                    eventLocation,
                    guestCount,
                    eventTime,
                });

                if (!resp.success) {
                    alert(resp.message || "Error updating contract.");
                    return;
                }

                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) {
                    contracts[idx] = resp.contract;
                }

                renderContracts();
            } catch (err) {
                console.error(err);
                showToast("Error contacting server.", "error");
            }
        }

        async function handleDeleteContract(contractId) {
            if (!await showConfirm("Are you sure you want to delete this contract?", "Delete Contract")) return;

            try {
                const resp = await callCG({
                    action: "deleteContract",
                    contractId,
                });

                if (!resp.success) {
                    showToast(resp.message || "Error deleting contract.", "error");
                    return;
                }

                // remove from local array
                const idx = contracts.findIndex((c) => c.id === contractId);
                if (idx !== -1) {
                    contracts.splice(idx, 1);
                }

                renderContracts();
                showToast("Contract deleted.", "success");
            } catch (err) {
                console.error(err);
                showToast("Error contacting server.", "error");
            }
        }


        contractSendBtn.addEventListener("click", async () => {
            const clientName = contractClientName.value.trim();
            const clientEmail = contractClientEmail.value.trim();
            if (!clientName || !clientEmail) {
                contractSendMessage.textContent = "Client name and email are required.";
                return;
            }
            contractSendMessage.textContent = "";
            try {
                const resp = await callCG({
                    action: "createContract",
                    clientName,
                    clientEmail,
                    eventDate: contractEventDate.value,
                    eventLocation: contractEventLocation.value,
                    guestCount: contractGuestCount.value,
                    eventTime: fmtEventTime(),
                });
                if (!resp.success) {
                    contractSendMessage.textContent =
                        resp.message || "Error creating contract.";
                    return;
                }
                contracts.push(resp.contract);
                renderContracts();
                contractSendMessage.textContent =
                    "Contract created (Draft). Click Send in the table to email it.";
            } catch (err) {
                console.error(err);
                contractSendMessage.textContent = "Error contacting server.";
            }
        });

        // ---------- Dashboard metrics & activity ----------
        const metricTotal = document.getElementById("metric-total");
        const metricSent = document.getElementById("metric-sent");
        const metricUnderReview = document.getElementById("metric-under-review");
        const metricSigned = document.getElementById("metric-signed");
        const recentActivityBody = document.getElementById("recent-activity-body");

        function updateMetrics() {
            const total = contracts.length;
            const sent = contracts.filter((c) => c.status === "Sent").length;
            const signed = contracts.filter((c) => c.status === "Signed").length;
            const under = contracts.filter((c) => c.status === "Under Review").length;

            metricTotal.textContent = total;
            metricSent.textContent = sent;
            metricSigned.textContent = signed;
            metricUnderReview.textContent = under;
        }

        function renderRecentActivity() {
            recentActivityBody.innerHTML = "";
            if (!contracts.length) {
                recentActivityBody.innerHTML =
                    '<tr><td colspan="4" style="text-align:center;color:#9ca3af;">Activity will appear once you create contracts.</td></tr>';
                return;
            }
            const items = [];
            contracts.forEach((c) => {
                (c.timeline || []).forEach((ev) => {
                    items.push({
                        clientName: c.clientName,
                        status: c.status,
                        label: ev.label || "Event",
                        at: ev.at || c.createdAt,
                    });
                });
            });
            items.sort((a, b) => (a.at || "").localeCompare(b.at || ""));
            const last = items.slice(-5).reverse();

            last.forEach((ev) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${ev.clientName}</td>
          <td>${ev.label}</td>
          <td>${ev.at || ""}</td>
          <td><span class="badge-soft">${ev.status || ""}</span></td>
        `;
                recentActivityBody.appendChild(tr);
            });
        }

        // Enhanced Accordion functionality
        function toggleAccordion(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const header = content.previousElementSibling;
            
            // Toggle active class on header and content
            const isActive = content.classList.contains('active');
            
            // Close all accordion items first
            document.querySelectorAll('.accordion-content').forEach(item => {
                if (item.id !== `${sectionId}-content` && item.classList.contains('active')) {
                    item.classList.remove('active');
                    item.style.maxHeight = '0';
                    item.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle current item
            if (!isActive) {
                // Open the clicked item
                header.classList.add('active');
                content.classList.add('active');
                // Calculate the exact height needed
                const innerContent = content.querySelector('.accordion-content-inner');
                content.style.maxHeight = innerContent.scrollHeight + 'px';
            } else {
                // Close the clicked item if it was already open
                header.classList.remove('active');
                content.classList.remove('active');
                content.style.maxHeight = '0';
            }
        }
        
        // Handle window resize to adjust accordion heights
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                document.querySelectorAll('.accordion-content.active').forEach(activeItem => {
                    const innerContent = activeItem.querySelector('.accordion-content-inner');
                    if (innerContent) {
                        activeItem.style.maxHeight = innerContent.scrollHeight + 'px';
                    }
                });
            }, 250);
        });
        
        // Open "View Contracts" accordion by default on page load
        document.addEventListener('DOMContentLoaded', function() {
            const viewContractsAccordion = document.getElementById('view-contracts-content');
            if (viewContractsAccordion) {
                const innerContent = viewContractsAccordion.querySelector('.accordion-content-inner');
                viewContractsAccordion.classList.add('active');
                viewContractsAccordion.style.maxHeight = innerContent.scrollHeight + 'px';
                viewContractsAccordion.previousElementSibling.classList.add('active');
            }
        });

        // ---------- initial load after login ----------
        async function loadInitialData() {
            try {
                const [clientsResp, contractsResp] = await Promise.all([
                    callCG({ action: "listClients" }),
                    callCG({ action: "listContracts" }),
                ]);
                clients = clientsResp.clients || [];
                contracts = contractsResp.contracts || [];
                renderClients();
                renderContracts();
                updateContractPreview();
            } catch (err) {
                console.error("Error loading initial data", err);
            }

            loadSmtpSettings();
        }

        // ---------- SMTP Settings ----------
        const smtpHostInput = document.getElementById("smtp-host");
        const smtpPortInput = document.getElementById("smtp-port");
        const smtpUserInput = document.getElementById("smtp-user");
        const smtpPassInput = document.getElementById("smtp-pass");
        const smtpFromInput = document.getElementById("smtp-from");
        const btnSaveSmtp = document.getElementById("btn-save-smtp");
        const smtpMsg = document.getElementById("smtp-msg");

        async function loadSmtpSettings() {
            try {
                const resp = await callCG({ action: "getSettings" });
                if (resp.success && resp.settings) {
                    const s = resp.settings;
                    smtpHostInput.value = s.smtpHost || "";
                    smtpPortInput.value = s.smtpPort || "";
                    smtpUserInput.value = s.smtpUser || "";
                    smtpPassInput.value = s.smtpPass || "";
                    smtpFromInput.value = s.smtpFrom || "";
                }
            } catch (e) {
                console.error("Error loading settings", e);
            }
        }

        btnSaveSmtp.addEventListener("click", async () => {
            btnSaveSmtp.disabled = true;
            smtpMsg.textContent = "Saving...";
            try {
                const resp = await callCG({
                    action: "saveSettings",
                    smtpHost: smtpHostInput.value.trim(),
                    smtpPort: smtpPortInput.value.trim(),
                    smtpUser: smtpUserInput.value.trim(),
                    smtpPass: smtpPassInput.value.trim(),
                    smtpFrom: smtpFromInput.value.trim(),
                });
                if (resp.success) {
                    smtpMsg.textContent = " Settings saved.";
                } else {
                    smtpMsg.textContent = " Error saving settings.";
                }
            } catch (e) {
                console.error(e);
                smtpMsg.textContent = " Network error.";
            } finally {
                btnSaveSmtp.disabled = false;
            }
        });

        // initialize preview for first load (before login)
        updateContractPreview();

        // Initialize client search functionality
        initializeClientSearch();

        // Initial routing is handled by the load event listener above
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>

</html>